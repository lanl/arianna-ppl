<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.1"/>
    <title>arianna.ppl.inference API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script>
<style>
    mjx-container {
        overflow-x: auto;
        overflow-y: hidden;
    }
</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../ppl.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;arianna.ppl</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="variable" href="#P">P</a>
            </li>
            <li>
                    <a class="variable" href="#Model">Model</a>
            </li>
            <li>
                    <a class="variable" href="#Logprob">Logprob</a>
            </li>
            <li>
                    <a class="class" href="#Chain">Chain</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Chain.__init__">Chain</a>
                        </li>
                        <li>
                                <a class="variable" href="#Chain.states">states</a>
                        </li>
                        <li>
                                <a class="variable" href="#Chain.names">names</a>
                        </li>
                        <li>
                                <a class="function" href="#Chain.get">get</a>
                        </li>
                        <li>
                                <a class="variable" href="#Chain.bundle">bundle</a>
                        </li>
                        <li>
                                <a class="function" href="#Chain.subset">subset</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#InferenceEngine">InferenceEngine</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#InferenceEngine.rng">rng</a>
                        </li>
                        <li>
                                <a class="function" href="#InferenceEngine.fit">fit</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MCMC">MCMC</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#MCMC.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#MCMC.model_data">model_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#MCMC.nsamples">nsamples</a>
                        </li>
                        <li>
                                <a class="variable" href="#MCMC.burn">burn</a>
                        </li>
                        <li>
                                <a class="variable" href="#MCMC.thin">thin</a>
                        </li>
                        <li>
                                <a class="variable" href="#MCMC.mcmc_iteration">mcmc_iteration</a>
                        </li>
                        <li>
                                <a class="variable" href="#MCMC.transform">transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#MCMC.logprob_history">logprob_history</a>
                        </li>
                        <li>
                                <a class="function" href="#MCMC.step">step</a>
                        </li>
                        <li>
                                <a class="function" href="#MCMC.fit">fit</a>
                        </li>
                        <li>
                                <a class="function" href="#MCMC.logprob">logprob</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#SingleWalkerMCMC">SingleWalkerMCMC</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#SingleWalkerMCMC.init_state">init_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#SingleWalkerMCMC.mcmc_state">mcmc_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#SingleWalkerMCMC.transform">transform</a>
                        </li>
                        <li>
                                <a class="function" href="#SingleWalkerMCMC.step">step</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#RandomWalkMetropolis">RandomWalkMetropolis</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#RandomWalkMetropolis.__init__">RandomWalkMetropolis</a>
                        </li>
                        <li>
                                <a class="variable" href="#RandomWalkMetropolis.mcmc_state">mcmc_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#RandomWalkMetropolis.init_state">init_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#RandomWalkMetropolis.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#RandomWalkMetropolis.model_data">model_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#RandomWalkMetropolis.transform">transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#RandomWalkMetropolis.rng">rng</a>
                        </li>
                        <li>
                                <a class="variable" href="#RandomWalkMetropolis.proposal">proposal</a>
                        </li>
                        <li>
                                <a class="function" href="#RandomWalkMetropolis.step">step</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AffineInvariantMCMC">AffineInvariantMCMC</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.nsteps">nsteps</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.init_state">init_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.mcmc_state">mcmc_state</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.accept_rate">accept_rate</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.accept">accept</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.nwalkers">nwalkers</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.rng">rng</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.a">a</a>
                        </li>
                        <li>
                                <a class="variable" href="#AffineInvariantMCMC.dim">dim</a>
                        </li>
                        <li>
                                <a class="function" href="#AffineInvariantMCMC.logprob">logprob</a>
                        </li>
                        <li>
                                <a class="function" href="#AffineInvariantMCMC.step">step</a>
                        </li>
                        <li>
                                <a class="function" href="#AffineInvariantMCMC.fit">fit</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#AIES">AIES</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#AIES.__init__">AIES</a>
                        </li>
                        <li>
                                <a class="function" href="#AIES.default_temperature_fn">default_temperature_fn</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.nwalkers">nwalkers</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.transform">transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.rng">rng</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.accept">accept</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.a">a</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.model_data">model_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.temperature_fn">temperature_fn</a>
                        </li>
                        <li>
                                <a class="variable" href="#AIES.init_state">init_state</a>
                        </li>
                        <li>
                                <a class="function" href="#AIES.step">step</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ParallelAIES">ParallelAIES</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ParallelAIES.__init__">ParallelAIES</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.executor">executor</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.nwalkers">nwalkers</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.transform">transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.rng">rng</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.rngs">rngs</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.accept">accept</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.a">a</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.model_data">model_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#ParallelAIES.init_state">init_state</a>
                        </li>
                        <li>
                                <a class="function" href="#ParallelAIES.step">step</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ImportanceSampling">ImportanceSampling</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ImportanceSampling.__init__">ImportanceSampling</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImportanceSampling.particles">particles</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImportanceSampling.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImportanceSampling.model_data">model_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImportanceSampling.temperature">temperature</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImportanceSampling.rng">rng</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImportanceSampling.log_weights">log_weights</a>
                        </li>
                        <li>
                                <a class="variable" href="#ImportanceSampling.weights">weights</a>
                        </li>
                        <li>
                                <a class="function" href="#ImportanceSampling.fit">fit</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#LaplaceApproximation">LaplaceApproximation</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LaplaceApproximation.__init__">LaplaceApproximation</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceApproximation.rng">rng</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceApproximation.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceApproximation.model_data">model_data</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceApproximation.transform">transform</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceApproximation.shaper">shaper</a>
                        </li>
                        <li>
                                <a class="variable" href="#LaplaceApproximation.init_vec_state">init_vec_state</a>
                        </li>
                        <li>
                                <a class="function" href="#LaplaceApproximation.logprob">logprob</a>
                        </li>
                        <li>
                                <a class="function" href="#LaplaceApproximation.fit">fit</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BayesianOptimization">BayesianOptimization</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#AdaptiveRandomWalkMetropolis">AdaptiveRandomWalkMetropolis</a>
                            <ul class="memberlist">
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../arianna.html">arianna</a><wbr>.<a href="./../ppl.html">ppl</a><wbr>.inference    </h1>

                
                        <input id="mod-inference-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-inference-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractmethod</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">Executor</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a>    <span class="n">Any</span><span class="p">,</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>    <span class="n">Callable</span><span class="p">,</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>    <span class="n">Concatenate</span><span class="p">,</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a>    <span class="n">Generator</span><span class="p">,</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>    <span class="n">Iterable</span><span class="p">,</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a>    <span class="n">Optional</span><span class="p">,</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>    <span class="n">ParamSpec</span><span class="p">,</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="p">)</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ndarray</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">Generator</span> <span class="k">as</span> <span class="n">RNG</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">numpy.random</span><span class="w"> </span><span class="kn">import</span> <span class="n">default_rng</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.optimize</span><span class="w"> </span><span class="kn">import</span> <span class="n">minimize</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">scipy.special</span><span class="w"> </span><span class="kn">import</span> <span class="n">log_softmax</span><span class="p">,</span> <span class="n">softmax</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="kn">import</span> <span class="n">tqdm</span><span class="p">,</span> <span class="n">trange</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">arianna.distributions</span><span class="w"> </span><span class="kn">import</span> <span class="n">MvNormal</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">arianna.ppl.context</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="n">Context</span><span class="p">,</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="n">LogprobAndLogjacobianAndTrace</span><span class="p">,</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>    <span class="n">LogprobAndPriorSample</span><span class="p">,</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="n">LogprobAndTrace</span><span class="p">,</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="n">Predictive</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>    <span class="n">State</span><span class="p">,</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">TransformedLogprobAndTrace</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="n">TransformedPredictive</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="p">)</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">arianna.ppl.shaper</span><span class="w"> </span><span class="kn">import</span> <span class="n">Shaper</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="n">P</span> <span class="o">=</span> <span class="n">ParamSpec</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a><span class="n">Model</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n">Context</span><span class="p">,</span> <span class="n">P</span><span class="p">],</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="n">Logprob</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">State</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]]</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Chain</span><span class="p">:</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Chain MCMC samples.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    Parameters</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    ----------</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="sd">    states : Iterable[State]</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">        MCMC states.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    Attributes</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    ----------</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    chain : list[State]</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">        MCMC states in list format.</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">State</span><span class="p">]):</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over states.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">        Yields</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">        ------</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a><span class="sd">        State</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">            MCMC state within chain.</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="k">yield</span> <span class="n">state</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of states.&quot;&quot;&quot;</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all MCMC samples for one variable or cached value by name.</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">        Parameters</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">        ----------</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">        name : str</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">            Name of model parameter or cached value.</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">        Returns</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a><span class="sd">        -------</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">        ndarray</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a><span class="sd">            MCMC samples for the variable or cached value named.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">])</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="nd">@cached_property</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Bundle MCMC values into a dictionary.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a><span class="sd">        Returns</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="sd">        -------</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="sd">        dict[str, ndarray]</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a><span class="sd">            Dictionary bundle of MCMC samples.</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return subset of the states.</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="sd">        Parameters</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="sd">        ----------</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="sd">        burn : int, optional</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="sd">            Number of initial samples to discard, by default 0.</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">        thin : int, optional</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">            Take only every `thin`-th sample, by default 1.</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a><span class="sd">        Returns</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">        -------</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">        Chain</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">            A whole new chain, with the first `burn` removed, and taking only</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">            every `thin`-th sample.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">burn</span><span class="p">::</span><span class="n">thin</span><span class="p">])</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="k">class</span><span class="w"> </span><span class="nc">InferenceEngine</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract inference engine class.&quot;&quot;&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model.&quot;&quot;&quot;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>        <span class="k">pass</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MCMC</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract class for MCMC.&quot;&quot;&quot;</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="n">model_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="n">mcmc_iteration</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">logprob_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="k">pass</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update model state in one MCMC iteration.&quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="k">pass</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run MCMC.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a><span class="sd">        Returns</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a><span class="sd">        -------</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a><span class="sd">        Chain</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a><span class="sd">            Chain of MCMC samples.</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">        Parameters</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        ----------</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a><span class="sd">        state : State</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a><span class="sd">        Returns</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a><span class="sd">        -------</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="sd">        tuple[float, State]</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a><span class="sd">            (Log density (float), native state and cached values (dict))</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="c1"># state is real.</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>            <span class="c1"># Returns logprob + log_det_jacobian, native_state.</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>            <span class="k">return</span> <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>            <span class="p">)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>            <span class="c1"># state is native.</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>            <span class="c1"># Returns logprob, state (which is already native).</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>            <span class="k">return</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">)</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SingleWalkerMCMC</span><span class="p">(</span><span class="n">MCMC</span><span class="p">):</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Markov Chain Monte Carlo.&quot;&quot;&quot;</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="n">init_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>    <span class="n">mcmc_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>    <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return logprob and native_state_and_cache.</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        Returns</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        -------</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        float, State</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">            Logprob and native state and cache dictionary.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>        <span class="k">pass</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="n">nsamples</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">burn</span> <span class="o">=</span> <span class="n">burn</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thin</span> <span class="o">=</span> <span class="n">thin</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">nsamples</span> <span class="o">*</span> <span class="n">thin</span> <span class="o">+</span> <span class="n">burn</span><span class="p">):</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>            <span class="c1"># NOTE: mcmc_state may not be the returned state, but the state</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>            <span class="c1"># that is used in the MCMC (e.g., for computational efficiency).</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>            <span class="c1"># trace is the state in its native space appended with any cached</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>            <span class="c1"># values.</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>            <span class="n">logprob</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">burn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">thin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logprob</span><span class="p">)</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>                <span class="k">yield</span> <span class="n">trace</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="k">class</span><span class="w"> </span><span class="nc">RandomWalkMetropolis</span><span class="p">(</span><span class="n">SingleWalkerMCMC</span><span class="p">):</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Random walk Metropolis.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">    Parameters</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">    ----------</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a><span class="sd">    model: Model</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        model function.</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">    init_state: Optional[State]</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        Initial state for MCMC. If `transform=True` then `init_state` should</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a><span class="sd">        contain values in the real space; if `transform=False`, then</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a><span class="sd">        `init_state` should contain values in the native space. If not</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a><span class="sd">        provided, `init_state` is sampled from the prior predictive.</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a><span class="sd">        Defaults to None.</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a><span class="sd">    proposal: Optional[dict[str, Any]]</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a><span class="sd">        Dictionary containing proposal functions, dependent on the current</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="sd">        value. Defaults to None.</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a><span class="sd">    transform: bool</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a><span class="sd">        Whether or not to sample parameters into the real space. If False,</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a><span class="sd">        samples parameters in the native space. Regardless, returned samples</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a><span class="sd">        are in the native space and will include cached values. Defaults to</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a><span class="sd">        True.</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a><span class="sd">    rng: Optional[RNG]</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a><span class="sd">        Numpy random number generator. Defaults to None.</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a><span class="sd">    Attributes</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a><span class="sd">    ----------</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a><span class="sd">    model: Model</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a><span class="sd">        See Parameters.</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a><span class="sd">    init_state: State</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a><span class="sd">        If the constructor received None, `init_state` will be an empty</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a><span class="sd">        dictionary.</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a><span class="sd">    proposal: dict[str, Any]</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a><span class="sd">        If None is received in the constructor, an empty dictionary is first</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a><span class="sd">        created. In addition, any model parameters unnamed in the constructor</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a><span class="sd">        will have a value of</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a><span class="sd">        `lambda value, rng, mcmc_iteration: rng.normal(value, 0.1)`.</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a><span class="sd">        Thus, if you supplied in the constructor</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a><span class="sd">        `dict(mu=lambda value, rng, mcmc_iteration: rng.normal(value, 1))`</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="sd">        and your model is</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="sd">        ```python</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">        def model(ctx, y=None):</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">            mu = ctx.rv(&quot;mu&quot;, Normal(0, 10))</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a><span class="sd">            sigma = ctx.rv(&quot;sigma&quot;, Gamma(1, 1))</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a><span class="sd">            ctx.rv(&quot;y&quot;, Normal(mu, sigma), obs=y)</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="sd">        ```</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        then the value for sigma will be</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a><span class="sd">        `lambda value, rng, _: rng.normal(value, 0.1)`.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">    transform: bool</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">        See Parameters.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">    rng: RNG</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a><span class="sd">        If `None` was supplied in the constructor, then rng will be set to</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a><span class="sd">        `np.random.default_rng()`.</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>    <span class="n">mcmc_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>    <span class="n">init_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">State</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="n">proposal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="p">):</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>        <span class="k">match</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">TransformedPredictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="p">)</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>                <span class="p">)</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># init_state is provided.</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span> <span class="o">=</span> <span class="n">proposal</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">:</span>  <span class="c1"># should not have cached values.</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="n">name</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return native state and cached values.</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="sd">        Returns</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">        -------</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">        State</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a><span class="sd">            Native state and cached values.</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="n">proposed_state</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="n">name</span><span class="p">:</span> <span class="n">propose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span><span class="p">)</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">propose</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>        <span class="p">}</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>        <span class="c1"># NOTE: A trace contains the state (i.e., result of rv) in the native</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="c1"># space AND cached values (i.e., result of cached).</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="n">logprob_proposed</span><span class="p">,</span> <span class="n">proposed_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">proposed_state</span><span class="p">)</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="n">logprob_current</span><span class="p">,</span> <span class="n">current_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">)</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>        <span class="k">if</span> <span class="n">logprob_proposed</span> <span class="o">-</span> <span class="n">logprob_current</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">()):</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span> <span class="o">=</span> <span class="n">proposed_state</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>            <span class="k">return</span> <span class="n">logprob_proposed</span><span class="p">,</span> <span class="n">proposed_trace</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="k">return</span> <span class="n">logprob_current</span><span class="p">,</span> <span class="n">current_trace</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AffineInvariantMCMC</span><span class="p">(</span><span class="n">MCMC</span><span class="p">):</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Affine Invariant MCMC.&quot;&quot;&quot;</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>    <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>    <span class="n">init_state</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>    <span class="n">mcmc_state</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>    <span class="n">accept_rate</span><span class="p">:</span> <span class="n">ndarray</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="n">accept</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>    <span class="nd">@cached_property</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of model parameters.&quot;&quot;&quot;</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>            <span class="nb">sum</span><span class="p">(</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>            <span class="p">)</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="p">)</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a><span class="sd">        Parameters</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a><span class="sd">        ----------</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a><span class="sd">        state : State</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a><span class="sd">        Returns</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a><span class="sd">        -------</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a><span class="sd">        tuple[float, float, State]</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a><span class="sd">            (</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a><span class="sd">                Log density in native space,</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a><span class="sd">                Log determinant of jacobian,</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a><span class="sd">                native state and cached values (dict)</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a><span class="sd">            )</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="c1"># state is real.</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>            <span class="c1"># Returns logprob, log_det_jacobian, native_state.</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="k">return</span> <span class="n">LogprobAndLogjacobianAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>            <span class="p">)</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>            <span class="c1"># state is native.</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="c1"># Returns logprob, logprob, state (which is already native).</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>            <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a><span class="sd">        Returns</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a><span class="sd">        -------</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a><span class="sd">        list[State]</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="sd">            List of native state and cache dictionary.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="k">pass</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>        <span class="n">this_walker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="n">other_walker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_walker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="n">candidate</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>            <span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">this_walker</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other_walker</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="p">}</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>        <span class="n">cand_logprob</span><span class="p">,</span> <span class="n">cand_ldj</span><span class="p">,</span> <span class="n">cand_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>        <span class="n">this_logprob</span><span class="p">,</span> <span class="n">this_ldj</span><span class="p">,</span> <span class="n">this_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">this_walker</span><span class="p">)</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="n">log_accept_prob</span> <span class="o">=</span> <span class="n">cand_logprob</span> <span class="o">+</span> <span class="n">cand_ldj</span> <span class="o">-</span> <span class="n">this_logprob</span> <span class="o">-</span> <span class="n">this_ldj</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="n">log_accept_prob</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="k">if</span> <span class="n">log_accept_prob</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_draw_u</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">burn</span><span class="p">:</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">candidate</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                <span class="n">this_walker</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">cand_trace</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>            <span class="n">lp</span> <span class="o">=</span> <span class="n">cand_logprob</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">this_trace</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="n">lp</span> <span class="o">=</span> <span class="n">this_logprob</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">rebalanced_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model with AIES.&quot;&quot;&quot;</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>        <span class="k">if</span> <span class="n">rebalanced_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="n">rebalanced_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="k">if</span> <span class="n">rebalanced_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="c1"># Reweight with importance sampling.</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">rebalanced_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">weights</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>            <span class="p">)</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">resampled_logprob_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>            <span class="p">)</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>            <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>        <span class="k">return</span> <span class="n">chain</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="n">nsteps</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="n">nsteps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">burn</span> <span class="o">=</span> <span class="n">burn</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thin</span> <span class="o">=</span> <span class="n">thin</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">*</span> <span class="n">thin</span> <span class="o">+</span> <span class="n">burn</span><span class="p">):</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="c1"># NOTE: mcmc_state may not be the returned state, but the state</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>            <span class="c1"># that is used in the MCMC (e.g., for computational efficiency).</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="c1"># trace is the state in its native space appended with any cached</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="c1"># values.</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>            <span class="n">logprob</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">burn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">thin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">logprob</span><span class="p">)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="k">yield from</span> <span class="n">trace</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">thin</span><span class="p">)</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>    <span class="nd">@cached_property</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_root_a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>    <span class="nd">@cached_property</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_invroot_a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_a</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span> <span class="o">...</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span> <span class="o">...</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_z_given_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_a</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invroot_a</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invroot_a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_u</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_z_given_u</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a><span class="c1"># https://arxiv.org/abs/1202.3665</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AIES</span><span class="p">(</span><span class="n">AffineInvariantMCMC</span><span class="p">):</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequential Affine Invariant Ensemble Sampler.</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a><span class="sd">    This sampler is good for target distributions that are not multimodal and</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a><span class="sd">    separated by large low density regions. You should use as many walkers as</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a><span class="sd">    you can afford. Whereas this sampler employs walkers that are sequeutnailly</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a><span class="sd">    updated.  there is a parallel analog that updates walkers in parallel.</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a><span class="sd">    Parameters</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a><span class="sd">    ----------</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a><span class="sd">    model : Model</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a><span class="sd">        A model function of the form `def model(ctx: Context, **data)`.</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a><span class="sd">    num_walkers : int, optional</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a><span class="sd">        Number of walkers. Defaults to 10.</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="sd">    transform : bool, optional</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="sd">        Whether or not to transform parameters into the real space, by default</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">        True.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">    rng : RNG, optional</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a><span class="sd">        Random number generator, by default default_rng()</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a><span class="sd">    a : float, optional</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="sd">        Tuning parameter that is set, by default, to 2.0, which is good for many</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">        cases.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a><span class="sd">    temperature_fn : Optional[Callable[[int], float]], optional</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        A temperature function for annealing, by default None.</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">    References</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a><span class="sd">    ----------</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a><span class="sd">    - [emcee: The MCMC Hammer](https://arxiv.org/pdf/1202.3665)</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a><span class="sd">    - [Ensemble Samplers with Affine Invariance](https://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-s.pdf)</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">default_temperature_fn</span><span class="p">(</span><span class="nb">iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return 1.&quot;&quot;&quot;</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>        <span class="k">return</span> <span class="mf">1.0</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>        <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(),</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>        <span class="n">temperature_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>    <span class="p">):</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">nwalkers</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nwalkers</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tuning parameter `a` must be larger than 1.&quot;</span><span class="p">)</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temperature_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>            <span class="n">temperature_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_temperature_fn</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>        <span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TransformedPredictive</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="n">Predictive</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>            <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>                <span class="n">predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a>                <span class="p">)</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a>            <span class="p">]</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a><span class="sd">        Returns</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a><span class="sd">        -------</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a><span class="sd">        list[float], list[State]</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a><span class="sd">            List of logprobs and list of native state and cache dictionary.</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="n">lp</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">):</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>            <span class="n">lp_i</span><span class="p">,</span> <span class="n">trace_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>            <span class="n">lp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp_i</span><span class="p">)</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>            <span class="n">trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace_i</span><span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>        <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>        <span class="c1"># Draw anything but the current walker (i).</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_walker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ParallelAIES</span><span class="p">(</span><span class="n">AffineInvariantMCMC</span><span class="p">):</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parallel Affine Invariant MCMC (or Parallel AIES).</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a><span class="sd">    References</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a><span class="sd">    ----------</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a><span class="sd">    - [emcee: The MCMC Hammer](https://arxiv.org/pdf/1202.3665)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a><span class="sd">    - [Ensemble Samplers with Affine Invariance](https://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-s.pdf)</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="n">executor</span><span class="p">:</span> <span class="n">Executor</span><span class="p">,</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(),</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>    <span class="p">):</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="k">if</span> <span class="n">nwalkers</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">nwalkers</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>                <span class="s2">&quot;num_walkers needs to be an even integer greater than 3, &quot;</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>                <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="n">nwalkers</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>            <span class="p">)</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">nwalkers</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nwalkers</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tuning parameter `a` must be larger than 1.&quot;</span><span class="p">)</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TransformedPredictive</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="n">Predictive</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>                <span class="n">predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>                <span class="p">)</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>            <span class="p">]</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a><span class="sd">        Returns</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a><span class="sd">        -------</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a><span class="sd">        list[float], list[State]</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="sd">            Tuple in which the first element is a list of logprobs, and the</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a><span class="sd">            second element is a list of traces (i.e., native state and cache</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a><span class="sd">            dictionary).</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>        <span class="n">mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>        <span class="n">out_first_half</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">mid</span><span class="p">))</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>        <span class="p">)</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>        <span class="n">out_second_half</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">))</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>        <span class="p">)</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a>        <span class="n">logprob_first_half</span><span class="p">,</span> <span class="n">trace_first_half</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">out_first_half</span><span class="p">)</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>        <span class="n">logprob_second_half</span><span class="p">,</span> <span class="n">trace_second_half</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">out_second_half</span><span class="p">)</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>        <span class="n">logprob</span> <span class="o">=</span> <span class="n">logprob_first_half</span> <span class="o">+</span> <span class="n">logprob_second_half</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace_first_half</span> <span class="o">+</span> <span class="n">trace_second_half</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="k">return</span> <span class="n">logprob</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>        <span class="n">other_walkers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_other_walkers</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_walkers</span><span class="p">))</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="k">return</span> <span class="n">other_walkers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_other_walkers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]:</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>        <span class="n">mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mid</span><span class="p">:</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">mid</span><span class="p">:]</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[:</span><span class="n">mid</span><span class="p">]</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ImportanceSampling</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Importance Sampling.&quot;&quot;&quot;</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>    <span class="n">particles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>        <span class="n">particles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>        <span class="n">nparticles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>    <span class="p">):</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a>        <span class="k">match</span> <span class="n">nparticles</span><span class="p">,</span> <span class="n">particles</span><span class="p">:</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a>                    <span class="s2">&quot;nparticles and particles cannot both be None!&quot;</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a>                <span class="p">)</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="n">nparticles</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>                <span class="n">logprobs_and_samples</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>                    <span class="n">LogprobAndPriorSample</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>                    <span class="p">)</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>                <span class="p">]</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">logprobs_and_samples</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>            <span class="k">case</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span> <span class="k">_</span><span class="p">:</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>                    <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">particle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>                    <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>                <span class="p">]</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>                    <span class="s2">&quot;nparticles and particles cannot both be specified!&quot;</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>                <span class="p">)</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_weights</span> <span class="o">=</span> <span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">)</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>        <span class="c1"># self.ess = ess_kish(self.weights)</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample.&quot;&quot;&quot;</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LaplaceApproximation</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Laplace Approximation of Posterior.&quot;&quot;&quot;</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>    <span class="p">):</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">TransformedPredictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>                <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>            <span class="p">)</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>                <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>            <span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span> <span class="o">=</span> <span class="n">Shaper</span><span class="o">.</span><span class="n">from_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_vec_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a><span class="sd">        Parameters</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a><span class="sd">        ----------</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a><span class="sd">        state : State</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a><span class="sd">        Returns</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a><span class="sd">        -------</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a><span class="sd">        tuple[float, State]</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a><span class="sd">            (Log density (float), native state and cached values (dict))</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">)</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>            <span class="c1"># state is real.</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>            <span class="c1"># Returns logprob + log_det_jacobian, native_state.</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>            <span class="k">return</span> <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos">787</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos">788</span></a>            <span class="c1"># state is native.</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos">789</span></a>            <span class="c1"># Returns logprob, state (which is already native).</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos">790</span></a>            <span class="k">return</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos">791</span></a>
</span><span id="L-792"><a href="#L-792"><span class="linenos">792</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_negative_logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec_state</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos">793</span></a>        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">vec_state</span><span class="p">)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos">794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos">795</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">minimize_kwargs</span><span class="p">):</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos">796</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model with laplace approx.&quot;&quot;&quot;</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos">797</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos">798</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_negative_logprob</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_vec_state</span><span class="p">,</span> <span class="o">**</span><span class="n">minimize_kwargs</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos">799</span></a>        <span class="p">)</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos">800</span></a>        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">x</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos">801</span></a>        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">hess_inv</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos">802</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">MvNormal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">nsamples</span><span class="p">,),</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos">803</span></a>
</span><span id="L-804"><a href="#L-804"><span class="linenos">804</span></a>        <span class="c1"># Return native state and cache.</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos">805</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos">806</span></a>            <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos">807</span></a>                <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos">808</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos">809</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">),</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos">810</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos">811</span></a>                <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos">812</span></a>                <span class="k">for</span> <span class="n">vec_state</span> <span class="ow">in</span> <span class="n">samples</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos">813</span></a>            <span class="p">)</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos">814</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos">815</span></a>            <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos">816</span></a>                <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos">817</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos">818</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">),</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos">819</span></a>                    <span class="n">return_cached</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos">820</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos">821</span></a>                <span class="p">)</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos">822</span></a>                <span class="k">for</span> <span class="n">vec_state</span> <span class="ow">in</span> <span class="n">samples</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos">823</span></a>            <span class="p">)</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos">824</span></a>
</span><span id="L-825"><a href="#L-825"><span class="linenos">825</span></a>
</span><span id="L-826"><a href="#L-826"><span class="linenos">826</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BayesianOptimization</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos">827</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Bayesian Optimization.&quot;&quot;&quot;</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos">828</span></a>
</span><span id="L-829"><a href="#L-829"><span class="linenos">829</span></a>    <span class="o">...</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos">830</span></a>
</span><span id="L-831"><a href="#L-831"><span class="linenos">831</span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos">832</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveRandomWalkMetropolis</span><span class="p">(</span><span class="n">SingleWalkerMCMC</span><span class="p">):</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos">833</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Adaptive Random Walk Metropolis.</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos">834</span></a>
</span><span id="L-835"><a href="#L-835"><span class="linenos">835</span></a><span class="sd">    Resources</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos">836</span></a><span class="sd">    ---------</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos">837</span></a><span class="sd">    - https://probability.ca/jeff/ftpdir/adaptex.pdf</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos">838</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos">839</span></a>
</span><span id="L-840"><a href="#L-840"><span class="linenos">840</span></a>    <span class="o">...</span>
</span></pre></div>


            </section>
                <section id="P">
                    <div class="attr variable">
            <span class="name">P</span>        =
<span class="default_value">~P</span>

        
    </div>
    <a class="headerlink" href="#P"></a>
    
    

                </section>
                <section id="Model">
                    <div class="attr variable">
            <span class="name">Model</span>        =
<span class="default_value">typing.Callable[typing.Concatenate[<a href="context.html#Context">arianna.ppl.context.Context</a>, ~P], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#Model"></a>
    
    

                </section>
                <section id="Logprob">
                    <div class="attr variable">
            <span class="name">Logprob</span>        =
<span class="default_value">typing.Callable[[dict[str, float | numpy.ndarray]], tuple[float, dict[str, float | numpy.ndarray]]]</span>

        
    </div>
    <a class="headerlink" href="#Logprob"></a>
    
    

                </section>
                <section id="Chain">
                            <input id="Chain-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Chain</span>:

                <label class="view-source-button" for="Chain-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Chain"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Chain-42"><a href="#Chain-42"><span class="linenos"> 42</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Chain</span><span class="p">:</span>
</span><span id="Chain-43"><a href="#Chain-43"><span class="linenos"> 43</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Chain MCMC samples.</span>
</span><span id="Chain-44"><a href="#Chain-44"><span class="linenos"> 44</span></a>
</span><span id="Chain-45"><a href="#Chain-45"><span class="linenos"> 45</span></a><span class="sd">    Parameters</span>
</span><span id="Chain-46"><a href="#Chain-46"><span class="linenos"> 46</span></a><span class="sd">    ----------</span>
</span><span id="Chain-47"><a href="#Chain-47"><span class="linenos"> 47</span></a><span class="sd">    states : Iterable[State]</span>
</span><span id="Chain-48"><a href="#Chain-48"><span class="linenos"> 48</span></a><span class="sd">        MCMC states.</span>
</span><span id="Chain-49"><a href="#Chain-49"><span class="linenos"> 49</span></a>
</span><span id="Chain-50"><a href="#Chain-50"><span class="linenos"> 50</span></a><span class="sd">    Attributes</span>
</span><span id="Chain-51"><a href="#Chain-51"><span class="linenos"> 51</span></a><span class="sd">    ----------</span>
</span><span id="Chain-52"><a href="#Chain-52"><span class="linenos"> 52</span></a><span class="sd">    chain : list[State]</span>
</span><span id="Chain-53"><a href="#Chain-53"><span class="linenos"> 53</span></a><span class="sd">        MCMC states in list format.</span>
</span><span id="Chain-54"><a href="#Chain-54"><span class="linenos"> 54</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Chain-55"><a href="#Chain-55"><span class="linenos"> 55</span></a>
</span><span id="Chain-56"><a href="#Chain-56"><span class="linenos"> 56</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">State</span><span class="p">]):</span>
</span><span id="Chain-57"><a href="#Chain-57"><span class="linenos"> 57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
</span><span id="Chain-58"><a href="#Chain-58"><span class="linenos"> 58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span><span id="Chain-59"><a href="#Chain-59"><span class="linenos"> 59</span></a>
</span><span id="Chain-60"><a href="#Chain-60"><span class="linenos"> 60</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Chain-61"><a href="#Chain-61"><span class="linenos"> 61</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over states.</span>
</span><span id="Chain-62"><a href="#Chain-62"><span class="linenos"> 62</span></a>
</span><span id="Chain-63"><a href="#Chain-63"><span class="linenos"> 63</span></a><span class="sd">        Yields</span>
</span><span id="Chain-64"><a href="#Chain-64"><span class="linenos"> 64</span></a><span class="sd">        ------</span>
</span><span id="Chain-65"><a href="#Chain-65"><span class="linenos"> 65</span></a><span class="sd">        State</span>
</span><span id="Chain-66"><a href="#Chain-66"><span class="linenos"> 66</span></a><span class="sd">            MCMC state within chain.</span>
</span><span id="Chain-67"><a href="#Chain-67"><span class="linenos"> 67</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Chain-68"><a href="#Chain-68"><span class="linenos"> 68</span></a>        <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">:</span>
</span><span id="Chain-69"><a href="#Chain-69"><span class="linenos"> 69</span></a>            <span class="k">yield</span> <span class="n">state</span>
</span><span id="Chain-70"><a href="#Chain-70"><span class="linenos"> 70</span></a>
</span><span id="Chain-71"><a href="#Chain-71"><span class="linenos"> 71</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Chain-72"><a href="#Chain-72"><span class="linenos"> 72</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of states.&quot;&quot;&quot;</span>
</span><span id="Chain-73"><a href="#Chain-73"><span class="linenos"> 73</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">)</span>
</span><span id="Chain-74"><a href="#Chain-74"><span class="linenos"> 74</span></a>
</span><span id="Chain-75"><a href="#Chain-75"><span class="linenos"> 75</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="Chain-76"><a href="#Chain-76"><span class="linenos"> 76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all MCMC samples for one variable or cached value by name.</span>
</span><span id="Chain-77"><a href="#Chain-77"><span class="linenos"> 77</span></a>
</span><span id="Chain-78"><a href="#Chain-78"><span class="linenos"> 78</span></a><span class="sd">        Parameters</span>
</span><span id="Chain-79"><a href="#Chain-79"><span class="linenos"> 79</span></a><span class="sd">        ----------</span>
</span><span id="Chain-80"><a href="#Chain-80"><span class="linenos"> 80</span></a><span class="sd">        name : str</span>
</span><span id="Chain-81"><a href="#Chain-81"><span class="linenos"> 81</span></a><span class="sd">            Name of model parameter or cached value.</span>
</span><span id="Chain-82"><a href="#Chain-82"><span class="linenos"> 82</span></a>
</span><span id="Chain-83"><a href="#Chain-83"><span class="linenos"> 83</span></a><span class="sd">        Returns</span>
</span><span id="Chain-84"><a href="#Chain-84"><span class="linenos"> 84</span></a><span class="sd">        -------</span>
</span><span id="Chain-85"><a href="#Chain-85"><span class="linenos"> 85</span></a><span class="sd">        ndarray</span>
</span><span id="Chain-86"><a href="#Chain-86"><span class="linenos"> 86</span></a><span class="sd">            MCMC samples for the variable or cached value named.</span>
</span><span id="Chain-87"><a href="#Chain-87"><span class="linenos"> 87</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Chain-88"><a href="#Chain-88"><span class="linenos"> 88</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">])</span>
</span><span id="Chain-89"><a href="#Chain-89"><span class="linenos"> 89</span></a>
</span><span id="Chain-90"><a href="#Chain-90"><span class="linenos"> 90</span></a>    <span class="nd">@cached_property</span>
</span><span id="Chain-91"><a href="#Chain-91"><span class="linenos"> 91</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Chain-92"><a href="#Chain-92"><span class="linenos"> 92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Bundle MCMC values into a dictionary.</span>
</span><span id="Chain-93"><a href="#Chain-93"><span class="linenos"> 93</span></a>
</span><span id="Chain-94"><a href="#Chain-94"><span class="linenos"> 94</span></a><span class="sd">        Returns</span>
</span><span id="Chain-95"><a href="#Chain-95"><span class="linenos"> 95</span></a><span class="sd">        -------</span>
</span><span id="Chain-96"><a href="#Chain-96"><span class="linenos"> 96</span></a><span class="sd">        dict[str, ndarray]</span>
</span><span id="Chain-97"><a href="#Chain-97"><span class="linenos"> 97</span></a><span class="sd">            Dictionary bundle of MCMC samples.</span>
</span><span id="Chain-98"><a href="#Chain-98"><span class="linenos"> 98</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Chain-99"><a href="#Chain-99"><span class="linenos"> 99</span></a>        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
</span><span id="Chain-100"><a href="#Chain-100"><span class="linenos">100</span></a>
</span><span id="Chain-101"><a href="#Chain-101"><span class="linenos">101</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Chain-102"><a href="#Chain-102"><span class="linenos">102</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return subset of the states.</span>
</span><span id="Chain-103"><a href="#Chain-103"><span class="linenos">103</span></a>
</span><span id="Chain-104"><a href="#Chain-104"><span class="linenos">104</span></a><span class="sd">        Parameters</span>
</span><span id="Chain-105"><a href="#Chain-105"><span class="linenos">105</span></a><span class="sd">        ----------</span>
</span><span id="Chain-106"><a href="#Chain-106"><span class="linenos">106</span></a><span class="sd">        burn : int, optional</span>
</span><span id="Chain-107"><a href="#Chain-107"><span class="linenos">107</span></a><span class="sd">            Number of initial samples to discard, by default 0.</span>
</span><span id="Chain-108"><a href="#Chain-108"><span class="linenos">108</span></a><span class="sd">        thin : int, optional</span>
</span><span id="Chain-109"><a href="#Chain-109"><span class="linenos">109</span></a><span class="sd">            Take only every `thin`-th sample, by default 1.</span>
</span><span id="Chain-110"><a href="#Chain-110"><span class="linenos">110</span></a>
</span><span id="Chain-111"><a href="#Chain-111"><span class="linenos">111</span></a><span class="sd">        Returns</span>
</span><span id="Chain-112"><a href="#Chain-112"><span class="linenos">112</span></a><span class="sd">        -------</span>
</span><span id="Chain-113"><a href="#Chain-113"><span class="linenos">113</span></a><span class="sd">        Chain</span>
</span><span id="Chain-114"><a href="#Chain-114"><span class="linenos">114</span></a><span class="sd">            A whole new chain, with the first `burn` removed, and taking only</span>
</span><span id="Chain-115"><a href="#Chain-115"><span class="linenos">115</span></a><span class="sd">            every `thin`-th sample.</span>
</span><span id="Chain-116"><a href="#Chain-116"><span class="linenos">116</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Chain-117"><a href="#Chain-117"><span class="linenos">117</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">burn</span><span class="p">::</span><span class="n">thin</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Chain MCMC samples.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>states</strong> (Iterable[State]):
MCMC states.</li>
</ul>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>chain</strong> (list[State]):
MCMC states in list format.</li>
</ul>
</div>


                            <div id="Chain.__init__" class="classattr">
                                        <input id="Chain.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Chain</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span></span>)</span>

                <label class="view-source-button" for="Chain.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Chain.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Chain.__init__-56"><a href="#Chain.__init__-56"><span class="linenos">56</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">states</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">State</span><span class="p">]):</span>
</span><span id="Chain.__init__-57"><a href="#Chain.__init__-57"><span class="linenos">57</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
</span><span id="Chain.__init__-58"><a href="#Chain.__init__-58"><span class="linenos">58</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</span></pre></div>


    

                            </div>
                            <div id="Chain.states" class="classattr">
                                <div class="attr variable">
            <span class="name">states</span>

        
    </div>
    <a class="headerlink" href="#Chain.states"></a>
    
    

                            </div>
                            <div id="Chain.names" class="classattr">
                                <div class="attr variable">
            <span class="name">names</span>

        
    </div>
    <a class="headerlink" href="#Chain.names"></a>
    
    

                            </div>
                            <div id="Chain.get" class="classattr">
                                        <input id="Chain.get-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">name</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>:</span></span>

                <label class="view-source-button" for="Chain.get-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Chain.get"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Chain.get-75"><a href="#Chain.get-75"><span class="linenos">75</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ndarray</span><span class="p">:</span>
</span><span id="Chain.get-76"><a href="#Chain.get-76"><span class="linenos">76</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all MCMC samples for one variable or cached value by name.</span>
</span><span id="Chain.get-77"><a href="#Chain.get-77"><span class="linenos">77</span></a>
</span><span id="Chain.get-78"><a href="#Chain.get-78"><span class="linenos">78</span></a><span class="sd">        Parameters</span>
</span><span id="Chain.get-79"><a href="#Chain.get-79"><span class="linenos">79</span></a><span class="sd">        ----------</span>
</span><span id="Chain.get-80"><a href="#Chain.get-80"><span class="linenos">80</span></a><span class="sd">        name : str</span>
</span><span id="Chain.get-81"><a href="#Chain.get-81"><span class="linenos">81</span></a><span class="sd">            Name of model parameter or cached value.</span>
</span><span id="Chain.get-82"><a href="#Chain.get-82"><span class="linenos">82</span></a>
</span><span id="Chain.get-83"><a href="#Chain.get-83"><span class="linenos">83</span></a><span class="sd">        Returns</span>
</span><span id="Chain.get-84"><a href="#Chain.get-84"><span class="linenos">84</span></a><span class="sd">        -------</span>
</span><span id="Chain.get-85"><a href="#Chain.get-85"><span class="linenos">85</span></a><span class="sd">        ndarray</span>
</span><span id="Chain.get-86"><a href="#Chain.get-86"><span class="linenos">86</span></a><span class="sd">            MCMC samples for the variable or cached value named.</span>
</span><span id="Chain.get-87"><a href="#Chain.get-87"><span class="linenos">87</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Chain.get-88"><a href="#Chain.get-88"><span class="linenos">88</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Get all MCMC samples for one variable or cached value by name.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>name</strong> (str):
Name of model parameter or cached value.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>ndarray</strong>: MCMC samples for the variable or cached value named.</li>
</ul>
</div>


                            </div>
                            <div id="Chain.bundle" class="classattr">
                                        <input id="Chain.bundle-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">bundle</span><span class="annotation">: dict[str, numpy.ndarray]</span>

                <label class="view-source-button" for="Chain.bundle-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Chain.bundle"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Chain.bundle-90"><a href="#Chain.bundle-90"><span class="linenos">90</span></a>    <span class="nd">@cached_property</span>
</span><span id="Chain.bundle-91"><a href="#Chain.bundle-91"><span class="linenos">91</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">bundle</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ndarray</span><span class="p">]:</span>
</span><span id="Chain.bundle-92"><a href="#Chain.bundle-92"><span class="linenos">92</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Bundle MCMC values into a dictionary.</span>
</span><span id="Chain.bundle-93"><a href="#Chain.bundle-93"><span class="linenos">93</span></a>
</span><span id="Chain.bundle-94"><a href="#Chain.bundle-94"><span class="linenos">94</span></a><span class="sd">        Returns</span>
</span><span id="Chain.bundle-95"><a href="#Chain.bundle-95"><span class="linenos">95</span></a><span class="sd">        -------</span>
</span><span id="Chain.bundle-96"><a href="#Chain.bundle-96"><span class="linenos">96</span></a><span class="sd">        dict[str, ndarray]</span>
</span><span id="Chain.bundle-97"><a href="#Chain.bundle-97"><span class="linenos">97</span></a><span class="sd">            Dictionary bundle of MCMC samples.</span>
</span><span id="Chain.bundle-98"><a href="#Chain.bundle-98"><span class="linenos">98</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Chain.bundle-99"><a href="#Chain.bundle-99"><span class="linenos">99</span></a>        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Bundle MCMC values into a dictionary.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>dict[str, ndarray]</strong>: Dictionary bundle of MCMC samples.</li>
</ul>
</div>


                            </div>
                            <div id="Chain.subset" class="classattr">
                                        <input id="Chain.subset-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">subset</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>, </span><span class="param"><span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Chain.subset-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Chain.subset"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Chain.subset-101"><a href="#Chain.subset-101"><span class="linenos">101</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="Chain.subset-102"><a href="#Chain.subset-102"><span class="linenos">102</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return subset of the states.</span>
</span><span id="Chain.subset-103"><a href="#Chain.subset-103"><span class="linenos">103</span></a>
</span><span id="Chain.subset-104"><a href="#Chain.subset-104"><span class="linenos">104</span></a><span class="sd">        Parameters</span>
</span><span id="Chain.subset-105"><a href="#Chain.subset-105"><span class="linenos">105</span></a><span class="sd">        ----------</span>
</span><span id="Chain.subset-106"><a href="#Chain.subset-106"><span class="linenos">106</span></a><span class="sd">        burn : int, optional</span>
</span><span id="Chain.subset-107"><a href="#Chain.subset-107"><span class="linenos">107</span></a><span class="sd">            Number of initial samples to discard, by default 0.</span>
</span><span id="Chain.subset-108"><a href="#Chain.subset-108"><span class="linenos">108</span></a><span class="sd">        thin : int, optional</span>
</span><span id="Chain.subset-109"><a href="#Chain.subset-109"><span class="linenos">109</span></a><span class="sd">            Take only every `thin`-th sample, by default 1.</span>
</span><span id="Chain.subset-110"><a href="#Chain.subset-110"><span class="linenos">110</span></a>
</span><span id="Chain.subset-111"><a href="#Chain.subset-111"><span class="linenos">111</span></a><span class="sd">        Returns</span>
</span><span id="Chain.subset-112"><a href="#Chain.subset-112"><span class="linenos">112</span></a><span class="sd">        -------</span>
</span><span id="Chain.subset-113"><a href="#Chain.subset-113"><span class="linenos">113</span></a><span class="sd">        Chain</span>
</span><span id="Chain.subset-114"><a href="#Chain.subset-114"><span class="linenos">114</span></a><span class="sd">            A whole new chain, with the first `burn` removed, and taking only</span>
</span><span id="Chain.subset-115"><a href="#Chain.subset-115"><span class="linenos">115</span></a><span class="sd">            every `thin`-th sample.</span>
</span><span id="Chain.subset-116"><a href="#Chain.subset-116"><span class="linenos">116</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Chain.subset-117"><a href="#Chain.subset-117"><span class="linenos">117</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">burn</span><span class="p">::</span><span class="n">thin</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Return subset of the states.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>burn</strong> (int, optional):
Number of initial samples to discard, by default 0.</li>
<li><strong>thin</strong> (int, optional):
Take only every <code>thin</code>-th sample, by default 1.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>Chain</strong>: A whole new chain, with the first <code>burn</code> removed, and taking only
every <code>thin</code>-th sample.</li>
</ul>
</div>


                            </div>
                </section>
                <section id="InferenceEngine">
                            <input id="InferenceEngine-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">InferenceEngine</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="InferenceEngine-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InferenceEngine"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InferenceEngine-120"><a href="#InferenceEngine-120"><span class="linenos">120</span></a><span class="k">class</span><span class="w"> </span><span class="nc">InferenceEngine</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="InferenceEngine-121"><a href="#InferenceEngine-121"><span class="linenos">121</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract inference engine class.&quot;&quot;&quot;</span>
</span><span id="InferenceEngine-122"><a href="#InferenceEngine-122"><span class="linenos">122</span></a>
</span><span id="InferenceEngine-123"><a href="#InferenceEngine-123"><span class="linenos">123</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span>
</span><span id="InferenceEngine-124"><a href="#InferenceEngine-124"><span class="linenos">124</span></a>
</span><span id="InferenceEngine-125"><a href="#InferenceEngine-125"><span class="linenos">125</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="InferenceEngine-126"><a href="#InferenceEngine-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="InferenceEngine-127"><a href="#InferenceEngine-127"><span class="linenos">127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model.&quot;&quot;&quot;</span>
</span><span id="InferenceEngine-128"><a href="#InferenceEngine-128"><span class="linenos">128</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Abstract inference engine class.</p>
</div>


                            <div id="InferenceEngine.rng" class="classattr">
                                <div class="attr variable">
            <span class="name">rng</span><span class="annotation">: numpy.random._generator.Generator</span>

        
    </div>
    <a class="headerlink" href="#InferenceEngine.rng"></a>
    
    

                            </div>
                            <div id="InferenceEngine.fit" class="classattr">
                                        <input id="InferenceEngine.fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abstractmethod">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">fit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="InferenceEngine.fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#InferenceEngine.fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="InferenceEngine.fit-125"><a href="#InferenceEngine.fit-125"><span class="linenos">125</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="InferenceEngine.fit-126"><a href="#InferenceEngine.fit-126"><span class="linenos">126</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="InferenceEngine.fit-127"><a href="#InferenceEngine.fit-127"><span class="linenos">127</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model.&quot;&quot;&quot;</span>
</span><span id="InferenceEngine.fit-128"><a href="#InferenceEngine.fit-128"><span class="linenos">128</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Fit model.</p>
</div>


                            </div>
                </section>
                <section id="MCMC">
                            <input id="MCMC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">MCMC</span><wbr>(<span class="base"><a href="#InferenceEngine">InferenceEngine</a></span>):

                <label class="view-source-button" for="MCMC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MCMC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MCMC-131"><a href="#MCMC-131"><span class="linenos">131</span></a><span class="k">class</span><span class="w"> </span><span class="nc">MCMC</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="MCMC-132"><a href="#MCMC-132"><span class="linenos">132</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract class for MCMC.&quot;&quot;&quot;</span>
</span><span id="MCMC-133"><a href="#MCMC-133"><span class="linenos">133</span></a>
</span><span id="MCMC-134"><a href="#MCMC-134"><span class="linenos">134</span></a>    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span>
</span><span id="MCMC-135"><a href="#MCMC-135"><span class="linenos">135</span></a>    <span class="n">model_data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="MCMC-136"><a href="#MCMC-136"><span class="linenos">136</span></a>    <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="MCMC-137"><a href="#MCMC-137"><span class="linenos">137</span></a>    <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="MCMC-138"><a href="#MCMC-138"><span class="linenos">138</span></a>    <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="MCMC-139"><a href="#MCMC-139"><span class="linenos">139</span></a>    <span class="n">mcmc_iteration</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="MCMC-140"><a href="#MCMC-140"><span class="linenos">140</span></a>    <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="MCMC-141"><a href="#MCMC-141"><span class="linenos">141</span></a>    <span class="n">logprob_history</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
</span><span id="MCMC-142"><a href="#MCMC-142"><span class="linenos">142</span></a>
</span><span id="MCMC-143"><a href="#MCMC-143"><span class="linenos">143</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="MCMC-144"><a href="#MCMC-144"><span class="linenos">144</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="MCMC-145"><a href="#MCMC-145"><span class="linenos">145</span></a>        <span class="k">pass</span>
</span><span id="MCMC-146"><a href="#MCMC-146"><span class="linenos">146</span></a>
</span><span id="MCMC-147"><a href="#MCMC-147"><span class="linenos">147</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="MCMC-148"><a href="#MCMC-148"><span class="linenos">148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MCMC-149"><a href="#MCMC-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update model state in one MCMC iteration.&quot;&quot;&quot;</span>
</span><span id="MCMC-150"><a href="#MCMC-150"><span class="linenos">150</span></a>        <span class="k">pass</span>
</span><span id="MCMC-151"><a href="#MCMC-151"><span class="linenos">151</span></a>
</span><span id="MCMC-152"><a href="#MCMC-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="MCMC-153"><a href="#MCMC-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run MCMC.</span>
</span><span id="MCMC-154"><a href="#MCMC-154"><span class="linenos">154</span></a>
</span><span id="MCMC-155"><a href="#MCMC-155"><span class="linenos">155</span></a><span class="sd">        Returns</span>
</span><span id="MCMC-156"><a href="#MCMC-156"><span class="linenos">156</span></a><span class="sd">        -------</span>
</span><span id="MCMC-157"><a href="#MCMC-157"><span class="linenos">157</span></a><span class="sd">        Chain</span>
</span><span id="MCMC-158"><a href="#MCMC-158"><span class="linenos">158</span></a><span class="sd">            Chain of MCMC samples.</span>
</span><span id="MCMC-159"><a href="#MCMC-159"><span class="linenos">159</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MCMC-160"><a href="#MCMC-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="MCMC-161"><a href="#MCMC-161"><span class="linenos">161</span></a>
</span><span id="MCMC-162"><a href="#MCMC-162"><span class="linenos">162</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="MCMC-163"><a href="#MCMC-163"><span class="linenos">163</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="MCMC-164"><a href="#MCMC-164"><span class="linenos">164</span></a>
</span><span id="MCMC-165"><a href="#MCMC-165"><span class="linenos">165</span></a><span class="sd">        Parameters</span>
</span><span id="MCMC-166"><a href="#MCMC-166"><span class="linenos">166</span></a><span class="sd">        ----------</span>
</span><span id="MCMC-167"><a href="#MCMC-167"><span class="linenos">167</span></a><span class="sd">        state : State</span>
</span><span id="MCMC-168"><a href="#MCMC-168"><span class="linenos">168</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="MCMC-169"><a href="#MCMC-169"><span class="linenos">169</span></a>
</span><span id="MCMC-170"><a href="#MCMC-170"><span class="linenos">170</span></a><span class="sd">        Returns</span>
</span><span id="MCMC-171"><a href="#MCMC-171"><span class="linenos">171</span></a><span class="sd">        -------</span>
</span><span id="MCMC-172"><a href="#MCMC-172"><span class="linenos">172</span></a><span class="sd">        tuple[float, State]</span>
</span><span id="MCMC-173"><a href="#MCMC-173"><span class="linenos">173</span></a><span class="sd">            (Log density (float), native state and cached values (dict))</span>
</span><span id="MCMC-174"><a href="#MCMC-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MCMC-175"><a href="#MCMC-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="MCMC-176"><a href="#MCMC-176"><span class="linenos">176</span></a>            <span class="c1"># state is real.</span>
</span><span id="MCMC-177"><a href="#MCMC-177"><span class="linenos">177</span></a>            <span class="c1"># Returns logprob + log_det_jacobian, native_state.</span>
</span><span id="MCMC-178"><a href="#MCMC-178"><span class="linenos">178</span></a>            <span class="k">return</span> <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="MCMC-179"><a href="#MCMC-179"><span class="linenos">179</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="MCMC-180"><a href="#MCMC-180"><span class="linenos">180</span></a>            <span class="p">)</span>
</span><span id="MCMC-181"><a href="#MCMC-181"><span class="linenos">181</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MCMC-182"><a href="#MCMC-182"><span class="linenos">182</span></a>            <span class="c1"># state is native.</span>
</span><span id="MCMC-183"><a href="#MCMC-183"><span class="linenos">183</span></a>            <span class="c1"># Returns logprob, state (which is already native).</span>
</span><span id="MCMC-184"><a href="#MCMC-184"><span class="linenos">184</span></a>            <span class="k">return</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Abstract class for MCMC.</p>
</div>


                            <div id="MCMC.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span><span class="annotation">: Callable[Concatenate[<a href="context.html#Context">arianna.ppl.context.Context</a>, ~P], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#MCMC.model"></a>
    
    

                            </div>
                            <div id="MCMC.model_data" class="classattr">
                                <div class="attr variable">
            <span class="name">model_data</span><span class="annotation">: dict[str, typing.Any]</span>

        
    </div>
    <a class="headerlink" href="#MCMC.model_data"></a>
    
    

                            </div>
                            <div id="MCMC.nsamples" class="classattr">
                                <div class="attr variable">
            <span class="name">nsamples</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#MCMC.nsamples"></a>
    
    

                            </div>
                            <div id="MCMC.burn" class="classattr">
                                <div class="attr variable">
            <span class="name">burn</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#MCMC.burn"></a>
    
    

                            </div>
                            <div id="MCMC.thin" class="classattr">
                                <div class="attr variable">
            <span class="name">thin</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#MCMC.thin"></a>
    
    

                            </div>
                            <div id="MCMC.mcmc_iteration" class="classattr">
                                <div class="attr variable">
            <span class="name">mcmc_iteration</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#MCMC.mcmc_iteration"></a>
    
    

                            </div>
                            <div id="MCMC.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#MCMC.transform"></a>
    
    

                            </div>
                            <div id="MCMC.logprob_history" class="classattr">
                                <div class="attr variable">
            <span class="name">logprob_history</span><span class="annotation">: list[float]</span>

        
    </div>
    <a class="headerlink" href="#MCMC.logprob_history"></a>
    
    

                            </div>
                            <div id="MCMC.step" class="classattr">
                                        <input id="MCMC.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abstractmethod">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="MCMC.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MCMC.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MCMC.step-147"><a href="#MCMC.step-147"><span class="linenos">147</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="MCMC.step-148"><a href="#MCMC.step-148"><span class="linenos">148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="MCMC.step-149"><a href="#MCMC.step-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update model state in one MCMC iteration.&quot;&quot;&quot;</span>
</span><span id="MCMC.step-150"><a href="#MCMC.step-150"><span class="linenos">150</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Update model state in one MCMC iteration.</p>
</div>


                            </div>
                            <div id="MCMC.fit" class="classattr">
                                        <input id="MCMC.fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">*</span><span class="n">args</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n"><a href="#Chain">Chain</a></span>:</span></span>

                <label class="view-source-button" for="MCMC.fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MCMC.fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MCMC.fit-152"><a href="#MCMC.fit-152"><span class="linenos">152</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="MCMC.fit-153"><a href="#MCMC.fit-153"><span class="linenos">153</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run MCMC.</span>
</span><span id="MCMC.fit-154"><a href="#MCMC.fit-154"><span class="linenos">154</span></a>
</span><span id="MCMC.fit-155"><a href="#MCMC.fit-155"><span class="linenos">155</span></a><span class="sd">        Returns</span>
</span><span id="MCMC.fit-156"><a href="#MCMC.fit-156"><span class="linenos">156</span></a><span class="sd">        -------</span>
</span><span id="MCMC.fit-157"><a href="#MCMC.fit-157"><span class="linenos">157</span></a><span class="sd">        Chain</span>
</span><span id="MCMC.fit-158"><a href="#MCMC.fit-158"><span class="linenos">158</span></a><span class="sd">            Chain of MCMC samples.</span>
</span><span id="MCMC.fit-159"><a href="#MCMC.fit-159"><span class="linenos">159</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MCMC.fit-160"><a href="#MCMC.fit-160"><span class="linenos">160</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Run MCMC.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>Chain</strong>: Chain of MCMC samples.</li>
</ul>
</div>


                            </div>
                            <div id="MCMC.logprob" class="classattr">
                                        <input id="MCMC.logprob-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">logprob</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="MCMC.logprob-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MCMC.logprob"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MCMC.logprob-162"><a href="#MCMC.logprob-162"><span class="linenos">162</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="MCMC.logprob-163"><a href="#MCMC.logprob-163"><span class="linenos">163</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="MCMC.logprob-164"><a href="#MCMC.logprob-164"><span class="linenos">164</span></a>
</span><span id="MCMC.logprob-165"><a href="#MCMC.logprob-165"><span class="linenos">165</span></a><span class="sd">        Parameters</span>
</span><span id="MCMC.logprob-166"><a href="#MCMC.logprob-166"><span class="linenos">166</span></a><span class="sd">        ----------</span>
</span><span id="MCMC.logprob-167"><a href="#MCMC.logprob-167"><span class="linenos">167</span></a><span class="sd">        state : State</span>
</span><span id="MCMC.logprob-168"><a href="#MCMC.logprob-168"><span class="linenos">168</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="MCMC.logprob-169"><a href="#MCMC.logprob-169"><span class="linenos">169</span></a>
</span><span id="MCMC.logprob-170"><a href="#MCMC.logprob-170"><span class="linenos">170</span></a><span class="sd">        Returns</span>
</span><span id="MCMC.logprob-171"><a href="#MCMC.logprob-171"><span class="linenos">171</span></a><span class="sd">        -------</span>
</span><span id="MCMC.logprob-172"><a href="#MCMC.logprob-172"><span class="linenos">172</span></a><span class="sd">        tuple[float, State]</span>
</span><span id="MCMC.logprob-173"><a href="#MCMC.logprob-173"><span class="linenos">173</span></a><span class="sd">            (Log density (float), native state and cached values (dict))</span>
</span><span id="MCMC.logprob-174"><a href="#MCMC.logprob-174"><span class="linenos">174</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="MCMC.logprob-175"><a href="#MCMC.logprob-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="MCMC.logprob-176"><a href="#MCMC.logprob-176"><span class="linenos">176</span></a>            <span class="c1"># state is real.</span>
</span><span id="MCMC.logprob-177"><a href="#MCMC.logprob-177"><span class="linenos">177</span></a>            <span class="c1"># Returns logprob + log_det_jacobian, native_state.</span>
</span><span id="MCMC.logprob-178"><a href="#MCMC.logprob-178"><span class="linenos">178</span></a>            <span class="k">return</span> <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="MCMC.logprob-179"><a href="#MCMC.logprob-179"><span class="linenos">179</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="MCMC.logprob-180"><a href="#MCMC.logprob-180"><span class="linenos">180</span></a>            <span class="p">)</span>
</span><span id="MCMC.logprob-181"><a href="#MCMC.logprob-181"><span class="linenos">181</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="MCMC.logprob-182"><a href="#MCMC.logprob-182"><span class="linenos">182</span></a>            <span class="c1"># state is native.</span>
</span><span id="MCMC.logprob-183"><a href="#MCMC.logprob-183"><span class="linenos">183</span></a>            <span class="c1"># Returns logprob, state (which is already native).</span>
</span><span id="MCMC.logprob-184"><a href="#MCMC.logprob-184"><span class="linenos">184</span></a>            <span class="k">return</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute log density.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>state</strong> (State):
Dictionary containing random variables to model.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>tuple[float, State]</strong>: (Log density (float), native state and cached values (dict))</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#InferenceEngine">InferenceEngine</a></dt>
                                <dd id="MCMC.rng" class="variable"><a href="#InferenceEngine.rng">rng</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="SingleWalkerMCMC">
                            <input id="SingleWalkerMCMC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SingleWalkerMCMC</span><wbr>(<span class="base"><a href="#MCMC">MCMC</a></span>):

                <label class="view-source-button" for="SingleWalkerMCMC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SingleWalkerMCMC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SingleWalkerMCMC-187"><a href="#SingleWalkerMCMC-187"><span class="linenos">187</span></a><span class="k">class</span><span class="w"> </span><span class="nc">SingleWalkerMCMC</span><span class="p">(</span><span class="n">MCMC</span><span class="p">):</span>
</span><span id="SingleWalkerMCMC-188"><a href="#SingleWalkerMCMC-188"><span class="linenos">188</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Markov Chain Monte Carlo.&quot;&quot;&quot;</span>
</span><span id="SingleWalkerMCMC-189"><a href="#SingleWalkerMCMC-189"><span class="linenos">189</span></a>
</span><span id="SingleWalkerMCMC-190"><a href="#SingleWalkerMCMC-190"><span class="linenos">190</span></a>    <span class="n">init_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="SingleWalkerMCMC-191"><a href="#SingleWalkerMCMC-191"><span class="linenos">191</span></a>    <span class="n">mcmc_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="SingleWalkerMCMC-192"><a href="#SingleWalkerMCMC-192"><span class="linenos">192</span></a>    <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="SingleWalkerMCMC-193"><a href="#SingleWalkerMCMC-193"><span class="linenos">193</span></a>
</span><span id="SingleWalkerMCMC-194"><a href="#SingleWalkerMCMC-194"><span class="linenos">194</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="SingleWalkerMCMC-195"><a href="#SingleWalkerMCMC-195"><span class="linenos">195</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="SingleWalkerMCMC-196"><a href="#SingleWalkerMCMC-196"><span class="linenos">196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return logprob and native_state_and_cache.</span>
</span><span id="SingleWalkerMCMC-197"><a href="#SingleWalkerMCMC-197"><span class="linenos">197</span></a>
</span><span id="SingleWalkerMCMC-198"><a href="#SingleWalkerMCMC-198"><span class="linenos">198</span></a><span class="sd">        Returns</span>
</span><span id="SingleWalkerMCMC-199"><a href="#SingleWalkerMCMC-199"><span class="linenos">199</span></a><span class="sd">        -------</span>
</span><span id="SingleWalkerMCMC-200"><a href="#SingleWalkerMCMC-200"><span class="linenos">200</span></a><span class="sd">        float, State</span>
</span><span id="SingleWalkerMCMC-201"><a href="#SingleWalkerMCMC-201"><span class="linenos">201</span></a><span class="sd">            Logprob and native state and cache dictionary.</span>
</span><span id="SingleWalkerMCMC-202"><a href="#SingleWalkerMCMC-202"><span class="linenos">202</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SingleWalkerMCMC-203"><a href="#SingleWalkerMCMC-203"><span class="linenos">203</span></a>        <span class="k">pass</span>
</span><span id="SingleWalkerMCMC-204"><a href="#SingleWalkerMCMC-204"><span class="linenos">204</span></a>
</span><span id="SingleWalkerMCMC-205"><a href="#SingleWalkerMCMC-205"><span class="linenos">205</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span>
</span><span id="SingleWalkerMCMC-206"><a href="#SingleWalkerMCMC-206"><span class="linenos">206</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="SingleWalkerMCMC-207"><a href="#SingleWalkerMCMC-207"><span class="linenos">207</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="SingleWalkerMCMC-208"><a href="#SingleWalkerMCMC-208"><span class="linenos">208</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="n">nsamples</span>
</span><span id="SingleWalkerMCMC-209"><a href="#SingleWalkerMCMC-209"><span class="linenos">209</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">burn</span> <span class="o">=</span> <span class="n">burn</span>
</span><span id="SingleWalkerMCMC-210"><a href="#SingleWalkerMCMC-210"><span class="linenos">210</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thin</span> <span class="o">=</span> <span class="n">thin</span>
</span><span id="SingleWalkerMCMC-211"><a href="#SingleWalkerMCMC-211"><span class="linenos">211</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="SingleWalkerMCMC-212"><a href="#SingleWalkerMCMC-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SingleWalkerMCMC-213"><a href="#SingleWalkerMCMC-213"><span class="linenos">213</span></a>
</span><span id="SingleWalkerMCMC-214"><a href="#SingleWalkerMCMC-214"><span class="linenos">214</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">nsamples</span> <span class="o">*</span> <span class="n">thin</span> <span class="o">+</span> <span class="n">burn</span><span class="p">):</span>
</span><span id="SingleWalkerMCMC-215"><a href="#SingleWalkerMCMC-215"><span class="linenos">215</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="SingleWalkerMCMC-216"><a href="#SingleWalkerMCMC-216"><span class="linenos">216</span></a>            <span class="c1"># NOTE: mcmc_state may not be the returned state, but the state</span>
</span><span id="SingleWalkerMCMC-217"><a href="#SingleWalkerMCMC-217"><span class="linenos">217</span></a>            <span class="c1"># that is used in the MCMC (e.g., for computational efficiency).</span>
</span><span id="SingleWalkerMCMC-218"><a href="#SingleWalkerMCMC-218"><span class="linenos">218</span></a>            <span class="c1"># trace is the state in its native space appended with any cached</span>
</span><span id="SingleWalkerMCMC-219"><a href="#SingleWalkerMCMC-219"><span class="linenos">219</span></a>            <span class="c1"># values.</span>
</span><span id="SingleWalkerMCMC-220"><a href="#SingleWalkerMCMC-220"><span class="linenos">220</span></a>            <span class="n">logprob</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="SingleWalkerMCMC-221"><a href="#SingleWalkerMCMC-221"><span class="linenos">221</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">burn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">thin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="SingleWalkerMCMC-222"><a href="#SingleWalkerMCMC-222"><span class="linenos">222</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logprob</span><span class="p">)</span>
</span><span id="SingleWalkerMCMC-223"><a href="#SingleWalkerMCMC-223"><span class="linenos">223</span></a>                <span class="k">yield</span> <span class="n">trace</span>
</span></pre></div>


            <div class="docstring"><p>Markov Chain Monte Carlo.</p>
</div>


                            <div id="SingleWalkerMCMC.init_state" class="classattr">
                                <div class="attr variable">
            <span class="name">init_state</span><span class="annotation">: dict[str, float | numpy.ndarray]</span>

        
    </div>
    <a class="headerlink" href="#SingleWalkerMCMC.init_state"></a>
    
    

                            </div>
                            <div id="SingleWalkerMCMC.mcmc_state" class="classattr">
                                <div class="attr variable">
            <span class="name">mcmc_state</span><span class="annotation">: dict[str, float | numpy.ndarray]</span>

        
    </div>
    <a class="headerlink" href="#SingleWalkerMCMC.mcmc_state"></a>
    
    

                            </div>
                            <div id="SingleWalkerMCMC.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#SingleWalkerMCMC.transform"></a>
    
    

                            </div>
                            <div id="SingleWalkerMCMC.step" class="classattr">
                                        <input id="SingleWalkerMCMC.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abstractmethod">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="SingleWalkerMCMC.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SingleWalkerMCMC.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SingleWalkerMCMC.step-194"><a href="#SingleWalkerMCMC.step-194"><span class="linenos">194</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="SingleWalkerMCMC.step-195"><a href="#SingleWalkerMCMC.step-195"><span class="linenos">195</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="SingleWalkerMCMC.step-196"><a href="#SingleWalkerMCMC.step-196"><span class="linenos">196</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return logprob and native_state_and_cache.</span>
</span><span id="SingleWalkerMCMC.step-197"><a href="#SingleWalkerMCMC.step-197"><span class="linenos">197</span></a>
</span><span id="SingleWalkerMCMC.step-198"><a href="#SingleWalkerMCMC.step-198"><span class="linenos">198</span></a><span class="sd">        Returns</span>
</span><span id="SingleWalkerMCMC.step-199"><a href="#SingleWalkerMCMC.step-199"><span class="linenos">199</span></a><span class="sd">        -------</span>
</span><span id="SingleWalkerMCMC.step-200"><a href="#SingleWalkerMCMC.step-200"><span class="linenos">200</span></a><span class="sd">        float, State</span>
</span><span id="SingleWalkerMCMC.step-201"><a href="#SingleWalkerMCMC.step-201"><span class="linenos">201</span></a><span class="sd">            Logprob and native state and cache dictionary.</span>
</span><span id="SingleWalkerMCMC.step-202"><a href="#SingleWalkerMCMC.step-202"><span class="linenos">202</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SingleWalkerMCMC.step-203"><a href="#SingleWalkerMCMC.step-203"><span class="linenos">203</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Update mcmc_state and return logprob and native_state_and_cache.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>float, State</strong>: Logprob and native state and cache dictionary.</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#MCMC">MCMC</a></dt>
                                <dd id="SingleWalkerMCMC.model" class="variable"><a href="#MCMC.model">model</a></dd>
                <dd id="SingleWalkerMCMC.model_data" class="variable"><a href="#MCMC.model_data">model_data</a></dd>
                <dd id="SingleWalkerMCMC.nsamples" class="variable"><a href="#MCMC.nsamples">nsamples</a></dd>
                <dd id="SingleWalkerMCMC.burn" class="variable"><a href="#MCMC.burn">burn</a></dd>
                <dd id="SingleWalkerMCMC.thin" class="variable"><a href="#MCMC.thin">thin</a></dd>
                <dd id="SingleWalkerMCMC.mcmc_iteration" class="variable"><a href="#MCMC.mcmc_iteration">mcmc_iteration</a></dd>
                <dd id="SingleWalkerMCMC.logprob_history" class="variable"><a href="#MCMC.logprob_history">logprob_history</a></dd>
                <dd id="SingleWalkerMCMC.fit" class="function"><a href="#MCMC.fit">fit</a></dd>
                <dd id="SingleWalkerMCMC.logprob" class="function"><a href="#MCMC.logprob">logprob</a></dd>

            </div>
            <div><dt><a href="#InferenceEngine">InferenceEngine</a></dt>
                                <dd id="SingleWalkerMCMC.rng" class="variable"><a href="#InferenceEngine.rng">rng</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="RandomWalkMetropolis">
                            <input id="RandomWalkMetropolis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">RandomWalkMetropolis</span><wbr>(<span class="base"><a href="#SingleWalkerMCMC">SingleWalkerMCMC</a></span>):

                <label class="view-source-button" for="RandomWalkMetropolis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RandomWalkMetropolis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RandomWalkMetropolis-226"><a href="#RandomWalkMetropolis-226"><span class="linenos">226</span></a><span class="k">class</span><span class="w"> </span><span class="nc">RandomWalkMetropolis</span><span class="p">(</span><span class="n">SingleWalkerMCMC</span><span class="p">):</span>
</span><span id="RandomWalkMetropolis-227"><a href="#RandomWalkMetropolis-227"><span class="linenos">227</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Random walk Metropolis.</span>
</span><span id="RandomWalkMetropolis-228"><a href="#RandomWalkMetropolis-228"><span class="linenos">228</span></a>
</span><span id="RandomWalkMetropolis-229"><a href="#RandomWalkMetropolis-229"><span class="linenos">229</span></a><span class="sd">    Parameters</span>
</span><span id="RandomWalkMetropolis-230"><a href="#RandomWalkMetropolis-230"><span class="linenos">230</span></a><span class="sd">    ----------</span>
</span><span id="RandomWalkMetropolis-231"><a href="#RandomWalkMetropolis-231"><span class="linenos">231</span></a><span class="sd">    model: Model</span>
</span><span id="RandomWalkMetropolis-232"><a href="#RandomWalkMetropolis-232"><span class="linenos">232</span></a><span class="sd">        model function.</span>
</span><span id="RandomWalkMetropolis-233"><a href="#RandomWalkMetropolis-233"><span class="linenos">233</span></a><span class="sd">    init_state: Optional[State]</span>
</span><span id="RandomWalkMetropolis-234"><a href="#RandomWalkMetropolis-234"><span class="linenos">234</span></a><span class="sd">        Initial state for MCMC. If `transform=True` then `init_state` should</span>
</span><span id="RandomWalkMetropolis-235"><a href="#RandomWalkMetropolis-235"><span class="linenos">235</span></a><span class="sd">        contain values in the real space; if `transform=False`, then</span>
</span><span id="RandomWalkMetropolis-236"><a href="#RandomWalkMetropolis-236"><span class="linenos">236</span></a><span class="sd">        `init_state` should contain values in the native space. If not</span>
</span><span id="RandomWalkMetropolis-237"><a href="#RandomWalkMetropolis-237"><span class="linenos">237</span></a><span class="sd">        provided, `init_state` is sampled from the prior predictive.</span>
</span><span id="RandomWalkMetropolis-238"><a href="#RandomWalkMetropolis-238"><span class="linenos">238</span></a><span class="sd">        Defaults to None.</span>
</span><span id="RandomWalkMetropolis-239"><a href="#RandomWalkMetropolis-239"><span class="linenos">239</span></a><span class="sd">    proposal: Optional[dict[str, Any]]</span>
</span><span id="RandomWalkMetropolis-240"><a href="#RandomWalkMetropolis-240"><span class="linenos">240</span></a><span class="sd">        Dictionary containing proposal functions, dependent on the current</span>
</span><span id="RandomWalkMetropolis-241"><a href="#RandomWalkMetropolis-241"><span class="linenos">241</span></a><span class="sd">        value. Defaults to None.</span>
</span><span id="RandomWalkMetropolis-242"><a href="#RandomWalkMetropolis-242"><span class="linenos">242</span></a><span class="sd">    transform: bool</span>
</span><span id="RandomWalkMetropolis-243"><a href="#RandomWalkMetropolis-243"><span class="linenos">243</span></a><span class="sd">        Whether or not to sample parameters into the real space. If False,</span>
</span><span id="RandomWalkMetropolis-244"><a href="#RandomWalkMetropolis-244"><span class="linenos">244</span></a><span class="sd">        samples parameters in the native space. Regardless, returned samples</span>
</span><span id="RandomWalkMetropolis-245"><a href="#RandomWalkMetropolis-245"><span class="linenos">245</span></a><span class="sd">        are in the native space and will include cached values. Defaults to</span>
</span><span id="RandomWalkMetropolis-246"><a href="#RandomWalkMetropolis-246"><span class="linenos">246</span></a><span class="sd">        True.</span>
</span><span id="RandomWalkMetropolis-247"><a href="#RandomWalkMetropolis-247"><span class="linenos">247</span></a><span class="sd">    rng: Optional[RNG]</span>
</span><span id="RandomWalkMetropolis-248"><a href="#RandomWalkMetropolis-248"><span class="linenos">248</span></a><span class="sd">        Numpy random number generator. Defaults to None.</span>
</span><span id="RandomWalkMetropolis-249"><a href="#RandomWalkMetropolis-249"><span class="linenos">249</span></a>
</span><span id="RandomWalkMetropolis-250"><a href="#RandomWalkMetropolis-250"><span class="linenos">250</span></a><span class="sd">    Attributes</span>
</span><span id="RandomWalkMetropolis-251"><a href="#RandomWalkMetropolis-251"><span class="linenos">251</span></a><span class="sd">    ----------</span>
</span><span id="RandomWalkMetropolis-252"><a href="#RandomWalkMetropolis-252"><span class="linenos">252</span></a><span class="sd">    model: Model</span>
</span><span id="RandomWalkMetropolis-253"><a href="#RandomWalkMetropolis-253"><span class="linenos">253</span></a><span class="sd">        See Parameters.</span>
</span><span id="RandomWalkMetropolis-254"><a href="#RandomWalkMetropolis-254"><span class="linenos">254</span></a><span class="sd">    init_state: State</span>
</span><span id="RandomWalkMetropolis-255"><a href="#RandomWalkMetropolis-255"><span class="linenos">255</span></a><span class="sd">        If the constructor received None, `init_state` will be an empty</span>
</span><span id="RandomWalkMetropolis-256"><a href="#RandomWalkMetropolis-256"><span class="linenos">256</span></a><span class="sd">        dictionary.</span>
</span><span id="RandomWalkMetropolis-257"><a href="#RandomWalkMetropolis-257"><span class="linenos">257</span></a><span class="sd">    proposal: dict[str, Any]</span>
</span><span id="RandomWalkMetropolis-258"><a href="#RandomWalkMetropolis-258"><span class="linenos">258</span></a><span class="sd">        If None is received in the constructor, an empty dictionary is first</span>
</span><span id="RandomWalkMetropolis-259"><a href="#RandomWalkMetropolis-259"><span class="linenos">259</span></a><span class="sd">        created. In addition, any model parameters unnamed in the constructor</span>
</span><span id="RandomWalkMetropolis-260"><a href="#RandomWalkMetropolis-260"><span class="linenos">260</span></a><span class="sd">        will have a value of</span>
</span><span id="RandomWalkMetropolis-261"><a href="#RandomWalkMetropolis-261"><span class="linenos">261</span></a><span class="sd">        `lambda value, rng, mcmc_iteration: rng.normal(value, 0.1)`.</span>
</span><span id="RandomWalkMetropolis-262"><a href="#RandomWalkMetropolis-262"><span class="linenos">262</span></a><span class="sd">        Thus, if you supplied in the constructor</span>
</span><span id="RandomWalkMetropolis-263"><a href="#RandomWalkMetropolis-263"><span class="linenos">263</span></a><span class="sd">        `dict(mu=lambda value, rng, mcmc_iteration: rng.normal(value, 1))`</span>
</span><span id="RandomWalkMetropolis-264"><a href="#RandomWalkMetropolis-264"><span class="linenos">264</span></a><span class="sd">        and your model is</span>
</span><span id="RandomWalkMetropolis-265"><a href="#RandomWalkMetropolis-265"><span class="linenos">265</span></a><span class="sd">        ```python</span>
</span><span id="RandomWalkMetropolis-266"><a href="#RandomWalkMetropolis-266"><span class="linenos">266</span></a><span class="sd">        def model(ctx, y=None):</span>
</span><span id="RandomWalkMetropolis-267"><a href="#RandomWalkMetropolis-267"><span class="linenos">267</span></a><span class="sd">            mu = ctx.rv(&quot;mu&quot;, Normal(0, 10))</span>
</span><span id="RandomWalkMetropolis-268"><a href="#RandomWalkMetropolis-268"><span class="linenos">268</span></a><span class="sd">            sigma = ctx.rv(&quot;sigma&quot;, Gamma(1, 1))</span>
</span><span id="RandomWalkMetropolis-269"><a href="#RandomWalkMetropolis-269"><span class="linenos">269</span></a><span class="sd">            ctx.rv(&quot;y&quot;, Normal(mu, sigma), obs=y)</span>
</span><span id="RandomWalkMetropolis-270"><a href="#RandomWalkMetropolis-270"><span class="linenos">270</span></a><span class="sd">        ```</span>
</span><span id="RandomWalkMetropolis-271"><a href="#RandomWalkMetropolis-271"><span class="linenos">271</span></a><span class="sd">        then the value for sigma will be</span>
</span><span id="RandomWalkMetropolis-272"><a href="#RandomWalkMetropolis-272"><span class="linenos">272</span></a><span class="sd">        `lambda value, rng, _: rng.normal(value, 0.1)`.</span>
</span><span id="RandomWalkMetropolis-273"><a href="#RandomWalkMetropolis-273"><span class="linenos">273</span></a><span class="sd">    transform: bool</span>
</span><span id="RandomWalkMetropolis-274"><a href="#RandomWalkMetropolis-274"><span class="linenos">274</span></a><span class="sd">        See Parameters.</span>
</span><span id="RandomWalkMetropolis-275"><a href="#RandomWalkMetropolis-275"><span class="linenos">275</span></a><span class="sd">    rng: RNG</span>
</span><span id="RandomWalkMetropolis-276"><a href="#RandomWalkMetropolis-276"><span class="linenos">276</span></a><span class="sd">        If `None` was supplied in the constructor, then rng will be set to</span>
</span><span id="RandomWalkMetropolis-277"><a href="#RandomWalkMetropolis-277"><span class="linenos">277</span></a><span class="sd">        `np.random.default_rng()`.</span>
</span><span id="RandomWalkMetropolis-278"><a href="#RandomWalkMetropolis-278"><span class="linenos">278</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="RandomWalkMetropolis-279"><a href="#RandomWalkMetropolis-279"><span class="linenos">279</span></a>
</span><span id="RandomWalkMetropolis-280"><a href="#RandomWalkMetropolis-280"><span class="linenos">280</span></a>    <span class="n">mcmc_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="RandomWalkMetropolis-281"><a href="#RandomWalkMetropolis-281"><span class="linenos">281</span></a>    <span class="n">init_state</span><span class="p">:</span> <span class="n">State</span>
</span><span id="RandomWalkMetropolis-282"><a href="#RandomWalkMetropolis-282"><span class="linenos">282</span></a>
</span><span id="RandomWalkMetropolis-283"><a href="#RandomWalkMetropolis-283"><span class="linenos">283</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis-284"><a href="#RandomWalkMetropolis-284"><span class="linenos">284</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis-285"><a href="#RandomWalkMetropolis-285"><span class="linenos">285</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis-286"><a href="#RandomWalkMetropolis-286"><span class="linenos">286</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">State</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis-287"><a href="#RandomWalkMetropolis-287"><span class="linenos">287</span></a>        <span class="n">proposal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis-288"><a href="#RandomWalkMetropolis-288"><span class="linenos">288</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis-289"><a href="#RandomWalkMetropolis-289"><span class="linenos">289</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis-290"><a href="#RandomWalkMetropolis-290"><span class="linenos">290</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis-291"><a href="#RandomWalkMetropolis-291"><span class="linenos">291</span></a>    <span class="p">):</span>
</span><span id="RandomWalkMetropolis-292"><a href="#RandomWalkMetropolis-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="RandomWalkMetropolis-293"><a href="#RandomWalkMetropolis-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="RandomWalkMetropolis-294"><a href="#RandomWalkMetropolis-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="RandomWalkMetropolis-295"><a href="#RandomWalkMetropolis-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="RandomWalkMetropolis-296"><a href="#RandomWalkMetropolis-296"><span class="linenos">296</span></a>
</span><span id="RandomWalkMetropolis-297"><a href="#RandomWalkMetropolis-297"><span class="linenos">297</span></a>        <span class="k">match</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis-298"><a href="#RandomWalkMetropolis-298"><span class="linenos">298</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis-299"><a href="#RandomWalkMetropolis-299"><span class="linenos">299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">TransformedPredictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis-300"><a href="#RandomWalkMetropolis-300"><span class="linenos">300</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="RandomWalkMetropolis-301"><a href="#RandomWalkMetropolis-301"><span class="linenos">301</span></a>                <span class="p">)</span>
</span><span id="RandomWalkMetropolis-302"><a href="#RandomWalkMetropolis-302"><span class="linenos">302</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis-303"><a href="#RandomWalkMetropolis-303"><span class="linenos">303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis-304"><a href="#RandomWalkMetropolis-304"><span class="linenos">304</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="RandomWalkMetropolis-305"><a href="#RandomWalkMetropolis-305"><span class="linenos">305</span></a>                <span class="p">)</span>
</span><span id="RandomWalkMetropolis-306"><a href="#RandomWalkMetropolis-306"><span class="linenos">306</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># init_state is provided.</span>
</span><span id="RandomWalkMetropolis-307"><a href="#RandomWalkMetropolis-307"><span class="linenos">307</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span><span id="RandomWalkMetropolis-308"><a href="#RandomWalkMetropolis-308"><span class="linenos">308</span></a>
</span><span id="RandomWalkMetropolis-309"><a href="#RandomWalkMetropolis-309"><span class="linenos">309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span> <span class="o">=</span> <span class="n">proposal</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="RandomWalkMetropolis-310"><a href="#RandomWalkMetropolis-310"><span class="linenos">310</span></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">:</span>  <span class="c1"># should not have cached values.</span>
</span><span id="RandomWalkMetropolis-311"><a href="#RandomWalkMetropolis-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis-312"><a href="#RandomWalkMetropolis-312"><span class="linenos">312</span></a>                <span class="n">name</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis-313"><a href="#RandomWalkMetropolis-313"><span class="linenos">313</span></a>            <span class="p">)</span>
</span><span id="RandomWalkMetropolis-314"><a href="#RandomWalkMetropolis-314"><span class="linenos">314</span></a>
</span><span id="RandomWalkMetropolis-315"><a href="#RandomWalkMetropolis-315"><span class="linenos">315</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="RandomWalkMetropolis-316"><a href="#RandomWalkMetropolis-316"><span class="linenos">316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return native state and cached values.</span>
</span><span id="RandomWalkMetropolis-317"><a href="#RandomWalkMetropolis-317"><span class="linenos">317</span></a>
</span><span id="RandomWalkMetropolis-318"><a href="#RandomWalkMetropolis-318"><span class="linenos">318</span></a><span class="sd">        Returns</span>
</span><span id="RandomWalkMetropolis-319"><a href="#RandomWalkMetropolis-319"><span class="linenos">319</span></a><span class="sd">        -------</span>
</span><span id="RandomWalkMetropolis-320"><a href="#RandomWalkMetropolis-320"><span class="linenos">320</span></a><span class="sd">        State</span>
</span><span id="RandomWalkMetropolis-321"><a href="#RandomWalkMetropolis-321"><span class="linenos">321</span></a><span class="sd">            Native state and cached values.</span>
</span><span id="RandomWalkMetropolis-322"><a href="#RandomWalkMetropolis-322"><span class="linenos">322</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RandomWalkMetropolis-323"><a href="#RandomWalkMetropolis-323"><span class="linenos">323</span></a>        <span class="n">proposed_state</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="RandomWalkMetropolis-324"><a href="#RandomWalkMetropolis-324"><span class="linenos">324</span></a>            <span class="n">name</span><span class="p">:</span> <span class="n">propose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis-325"><a href="#RandomWalkMetropolis-325"><span class="linenos">325</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">propose</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="RandomWalkMetropolis-326"><a href="#RandomWalkMetropolis-326"><span class="linenos">326</span></a>        <span class="p">}</span>
</span><span id="RandomWalkMetropolis-327"><a href="#RandomWalkMetropolis-327"><span class="linenos">327</span></a>        <span class="c1"># NOTE: A trace contains the state (i.e., result of rv) in the native</span>
</span><span id="RandomWalkMetropolis-328"><a href="#RandomWalkMetropolis-328"><span class="linenos">328</span></a>        <span class="c1"># space AND cached values (i.e., result of cached).</span>
</span><span id="RandomWalkMetropolis-329"><a href="#RandomWalkMetropolis-329"><span class="linenos">329</span></a>        <span class="n">logprob_proposed</span><span class="p">,</span> <span class="n">proposed_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">proposed_state</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis-330"><a href="#RandomWalkMetropolis-330"><span class="linenos">330</span></a>        <span class="n">logprob_current</span><span class="p">,</span> <span class="n">current_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis-331"><a href="#RandomWalkMetropolis-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="n">logprob_proposed</span> <span class="o">-</span> <span class="n">logprob_current</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">()):</span>
</span><span id="RandomWalkMetropolis-332"><a href="#RandomWalkMetropolis-332"><span class="linenos">332</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span> <span class="o">=</span> <span class="n">proposed_state</span>
</span><span id="RandomWalkMetropolis-333"><a href="#RandomWalkMetropolis-333"><span class="linenos">333</span></a>            <span class="k">return</span> <span class="n">logprob_proposed</span><span class="p">,</span> <span class="n">proposed_trace</span>
</span><span id="RandomWalkMetropolis-334"><a href="#RandomWalkMetropolis-334"><span class="linenos">334</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis-335"><a href="#RandomWalkMetropolis-335"><span class="linenos">335</span></a>            <span class="k">return</span> <span class="n">logprob_current</span><span class="p">,</span> <span class="n">current_trace</span>
</span></pre></div>


            <div class="docstring"><p>Random walk Metropolis.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>model</strong> (Model):
model function.</li>
<li><strong>init_state</strong> (Optional[State]):
Initial state for MCMC. If <code>transform=True</code> then <code><a href="#RandomWalkMetropolis.init_state">init_state</a></code> should
contain values in the real space; if <code>transform=False</code>, then
<code><a href="#RandomWalkMetropolis.init_state">init_state</a></code> should contain values in the native space. If not
provided, <code><a href="#RandomWalkMetropolis.init_state">init_state</a></code> is sampled from the prior predictive.
Defaults to None.</li>
<li><strong>proposal</strong> (Optional[dict[str, Any]]):
Dictionary containing proposal functions, dependent on the current
value. Defaults to None.</li>
<li><strong>transform</strong> (bool):
Whether or not to sample parameters into the real space. If False,
samples parameters in the native space. Regardless, returned samples
are in the native space and will include cached values. Defaults to
True.</li>
<li><strong>rng</strong> (Optional[RNG]):
Numpy random number generator. Defaults to None.</li>
</ul>

<h6 id="attributes">Attributes</h6>

<ul>
<li><strong>model</strong> (Model):
See Parameters.</li>
<li><strong>init_state</strong> (State):
If the constructor received None, <code><a href="#RandomWalkMetropolis.init_state">init_state</a></code> will be an empty
dictionary.</li>
<li><p><strong>proposal</strong> (dict[str, Any]):
If None is received in the constructor, an empty dictionary is first
created. In addition, any model parameters unnamed in the constructor
will have a value of
<code>lambda value, rng, mcmc_iteration: rng.normal(value, 0.1)</code>.
Thus, if you supplied in the constructor
<code>dict(mu=lambda value, rng, mcmc_iteration: rng.normal(value, 1))</code>
and your model is</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">model</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">rv</span><span class="p">(</span><span class="s2">&quot;mu&quot;</span><span class="p">,</span> <span class="n">Normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">rv</span><span class="p">(</span><span class="s2">&quot;sigma&quot;</span><span class="p">,</span> <span class="n">Gamma</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ctx</span><span class="o">.</span><span class="n">rv</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">Normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">y</span><span class="p">)</span>
</code></pre>
</div>

<p>then the value for sigma will be
<code>lambda value, rng, _: rng.normal(value, 0.1)</code>.</p></li>
<li><strong>transform</strong> (bool):
See Parameters.</li>
<li><strong>rng</strong> (RNG):
If <code>None</code> was supplied in the constructor, then rng will be set to
<code>np.random.default_rng()</code>.</li>
</ul>
</div>


                            <div id="RandomWalkMetropolis.__init__" class="classattr">
                                        <input id="RandomWalkMetropolis.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">RandomWalkMetropolis</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n"><a href="context.html#Context">arianna.ppl.context.Context</a></span><span class="p">,</span> <span class="o">~</span><span class="n">P</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span>,</span><span class="param">	<span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">proposal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">_generator</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">model_data</span></span>)</span>

                <label class="view-source-button" for="RandomWalkMetropolis.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RandomWalkMetropolis.__init__-283"><a href="#RandomWalkMetropolis.__init__-283"><span class="linenos">283</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis.__init__-284"><a href="#RandomWalkMetropolis.__init__-284"><span class="linenos">284</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis.__init__-285"><a href="#RandomWalkMetropolis.__init__-285"><span class="linenos">285</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis.__init__-286"><a href="#RandomWalkMetropolis.__init__-286"><span class="linenos">286</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">State</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis.__init__-287"><a href="#RandomWalkMetropolis.__init__-287"><span class="linenos">287</span></a>        <span class="n">proposal</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis.__init__-288"><a href="#RandomWalkMetropolis.__init__-288"><span class="linenos">288</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis.__init__-289"><a href="#RandomWalkMetropolis.__init__-289"><span class="linenos">289</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis.__init__-290"><a href="#RandomWalkMetropolis.__init__-290"><span class="linenos">290</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="RandomWalkMetropolis.__init__-291"><a href="#RandomWalkMetropolis.__init__-291"><span class="linenos">291</span></a>    <span class="p">):</span>
</span><span id="RandomWalkMetropolis.__init__-292"><a href="#RandomWalkMetropolis.__init__-292"><span class="linenos">292</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="RandomWalkMetropolis.__init__-293"><a href="#RandomWalkMetropolis.__init__-293"><span class="linenos">293</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="RandomWalkMetropolis.__init__-294"><a href="#RandomWalkMetropolis.__init__-294"><span class="linenos">294</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="RandomWalkMetropolis.__init__-295"><a href="#RandomWalkMetropolis.__init__-295"><span class="linenos">295</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="RandomWalkMetropolis.__init__-296"><a href="#RandomWalkMetropolis.__init__-296"><span class="linenos">296</span></a>
</span><span id="RandomWalkMetropolis.__init__-297"><a href="#RandomWalkMetropolis.__init__-297"><span class="linenos">297</span></a>        <span class="k">match</span> <span class="n">init_state</span><span class="p">,</span> <span class="n">transform</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis.__init__-298"><a href="#RandomWalkMetropolis.__init__-298"><span class="linenos">298</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis.__init__-299"><a href="#RandomWalkMetropolis.__init__-299"><span class="linenos">299</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">TransformedPredictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis.__init__-300"><a href="#RandomWalkMetropolis.__init__-300"><span class="linenos">300</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="RandomWalkMetropolis.__init__-301"><a href="#RandomWalkMetropolis.__init__-301"><span class="linenos">301</span></a>                <span class="p">)</span>
</span><span id="RandomWalkMetropolis.__init__-302"><a href="#RandomWalkMetropolis.__init__-302"><span class="linenos">302</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis.__init__-303"><a href="#RandomWalkMetropolis.__init__-303"><span class="linenos">303</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis.__init__-304"><a href="#RandomWalkMetropolis.__init__-304"><span class="linenos">304</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="RandomWalkMetropolis.__init__-305"><a href="#RandomWalkMetropolis.__init__-305"><span class="linenos">305</span></a>                <span class="p">)</span>
</span><span id="RandomWalkMetropolis.__init__-306"><a href="#RandomWalkMetropolis.__init__-306"><span class="linenos">306</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>  <span class="c1"># init_state is provided.</span>
</span><span id="RandomWalkMetropolis.__init__-307"><a href="#RandomWalkMetropolis.__init__-307"><span class="linenos">307</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span><span id="RandomWalkMetropolis.__init__-308"><a href="#RandomWalkMetropolis.__init__-308"><span class="linenos">308</span></a>
</span><span id="RandomWalkMetropolis.__init__-309"><a href="#RandomWalkMetropolis.__init__-309"><span class="linenos">309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span> <span class="o">=</span> <span class="n">proposal</span> <span class="ow">or</span> <span class="p">{}</span>
</span><span id="RandomWalkMetropolis.__init__-310"><a href="#RandomWalkMetropolis.__init__-310"><span class="linenos">310</span></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">:</span>  <span class="c1"># should not have cached values.</span>
</span><span id="RandomWalkMetropolis.__init__-311"><a href="#RandomWalkMetropolis.__init__-311"><span class="linenos">311</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
</span><span id="RandomWalkMetropolis.__init__-312"><a href="#RandomWalkMetropolis.__init__-312"><span class="linenos">312</span></a>                <span class="n">name</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">value</span><span class="p">,</span> <span class="n">rng</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">rng</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis.__init__-313"><a href="#RandomWalkMetropolis.__init__-313"><span class="linenos">313</span></a>            <span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="RandomWalkMetropolis.mcmc_state" class="classattr">
                                <div class="attr variable">
            <span class="name">mcmc_state</span><span class="annotation">: dict[str, float | numpy.ndarray]</span>

        
    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.mcmc_state"></a>
    
    

                            </div>
                            <div id="RandomWalkMetropolis.init_state" class="classattr">
                                <div class="attr variable">
            <span class="name">init_state</span><span class="annotation">: dict[str, float | numpy.ndarray]</span>

        
    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.init_state"></a>
    
    

                            </div>
                            <div id="RandomWalkMetropolis.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span>

        
    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.model"></a>
    
    

                            </div>
                            <div id="RandomWalkMetropolis.model_data" class="classattr">
                                <div class="attr variable">
            <span class="name">model_data</span>

        
    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.model_data"></a>
    
    

                            </div>
                            <div id="RandomWalkMetropolis.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span>

        
    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.transform"></a>
    
    

                            </div>
                            <div id="RandomWalkMetropolis.rng" class="classattr">
                                <div class="attr variable">
            <span class="name">rng</span>

        
    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.rng"></a>
    
    

                            </div>
                            <div id="RandomWalkMetropolis.proposal" class="classattr">
                                <div class="attr variable">
            <span class="name">proposal</span>

        
    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.proposal"></a>
    
    

                            </div>
                            <div id="RandomWalkMetropolis.step" class="classattr">
                                        <input id="RandomWalkMetropolis.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="RandomWalkMetropolis.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RandomWalkMetropolis.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RandomWalkMetropolis.step-315"><a href="#RandomWalkMetropolis.step-315"><span class="linenos">315</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="RandomWalkMetropolis.step-316"><a href="#RandomWalkMetropolis.step-316"><span class="linenos">316</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return native state and cached values.</span>
</span><span id="RandomWalkMetropolis.step-317"><a href="#RandomWalkMetropolis.step-317"><span class="linenos">317</span></a>
</span><span id="RandomWalkMetropolis.step-318"><a href="#RandomWalkMetropolis.step-318"><span class="linenos">318</span></a><span class="sd">        Returns</span>
</span><span id="RandomWalkMetropolis.step-319"><a href="#RandomWalkMetropolis.step-319"><span class="linenos">319</span></a><span class="sd">        -------</span>
</span><span id="RandomWalkMetropolis.step-320"><a href="#RandomWalkMetropolis.step-320"><span class="linenos">320</span></a><span class="sd">        State</span>
</span><span id="RandomWalkMetropolis.step-321"><a href="#RandomWalkMetropolis.step-321"><span class="linenos">321</span></a><span class="sd">            Native state and cached values.</span>
</span><span id="RandomWalkMetropolis.step-322"><a href="#RandomWalkMetropolis.step-322"><span class="linenos">322</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="RandomWalkMetropolis.step-323"><a href="#RandomWalkMetropolis.step-323"><span class="linenos">323</span></a>        <span class="n">proposed_state</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="RandomWalkMetropolis.step-324"><a href="#RandomWalkMetropolis.step-324"><span class="linenos">324</span></a>            <span class="n">name</span><span class="p">:</span> <span class="n">propose</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis.step-325"><a href="#RandomWalkMetropolis.step-325"><span class="linenos">325</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">propose</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proposal</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="RandomWalkMetropolis.step-326"><a href="#RandomWalkMetropolis.step-326"><span class="linenos">326</span></a>        <span class="p">}</span>
</span><span id="RandomWalkMetropolis.step-327"><a href="#RandomWalkMetropolis.step-327"><span class="linenos">327</span></a>        <span class="c1"># NOTE: A trace contains the state (i.e., result of rv) in the native</span>
</span><span id="RandomWalkMetropolis.step-328"><a href="#RandomWalkMetropolis.step-328"><span class="linenos">328</span></a>        <span class="c1"># space AND cached values (i.e., result of cached).</span>
</span><span id="RandomWalkMetropolis.step-329"><a href="#RandomWalkMetropolis.step-329"><span class="linenos">329</span></a>        <span class="n">logprob_proposed</span><span class="p">,</span> <span class="n">proposed_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">proposed_state</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis.step-330"><a href="#RandomWalkMetropolis.step-330"><span class="linenos">330</span></a>        <span class="n">logprob_current</span><span class="p">,</span> <span class="n">current_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">)</span>
</span><span id="RandomWalkMetropolis.step-331"><a href="#RandomWalkMetropolis.step-331"><span class="linenos">331</span></a>        <span class="k">if</span> <span class="n">logprob_proposed</span> <span class="o">-</span> <span class="n">logprob_current</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">()):</span>
</span><span id="RandomWalkMetropolis.step-332"><a href="#RandomWalkMetropolis.step-332"><span class="linenos">332</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span> <span class="o">=</span> <span class="n">proposed_state</span>
</span><span id="RandomWalkMetropolis.step-333"><a href="#RandomWalkMetropolis.step-333"><span class="linenos">333</span></a>            <span class="k">return</span> <span class="n">logprob_proposed</span><span class="p">,</span> <span class="n">proposed_trace</span>
</span><span id="RandomWalkMetropolis.step-334"><a href="#RandomWalkMetropolis.step-334"><span class="linenos">334</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="RandomWalkMetropolis.step-335"><a href="#RandomWalkMetropolis.step-335"><span class="linenos">335</span></a>            <span class="k">return</span> <span class="n">logprob_current</span><span class="p">,</span> <span class="n">current_trace</span>
</span></pre></div>


            <div class="docstring"><p>Update mcmc_state and return native state and cached values.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>State</strong>: Native state and cached values.</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#MCMC">MCMC</a></dt>
                                <dd id="RandomWalkMetropolis.nsamples" class="variable"><a href="#MCMC.nsamples">nsamples</a></dd>
                <dd id="RandomWalkMetropolis.burn" class="variable"><a href="#MCMC.burn">burn</a></dd>
                <dd id="RandomWalkMetropolis.thin" class="variable"><a href="#MCMC.thin">thin</a></dd>
                <dd id="RandomWalkMetropolis.mcmc_iteration" class="variable"><a href="#MCMC.mcmc_iteration">mcmc_iteration</a></dd>
                <dd id="RandomWalkMetropolis.logprob_history" class="variable"><a href="#MCMC.logprob_history">logprob_history</a></dd>
                <dd id="RandomWalkMetropolis.fit" class="function"><a href="#MCMC.fit">fit</a></dd>
                <dd id="RandomWalkMetropolis.logprob" class="function"><a href="#MCMC.logprob">logprob</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="AffineInvariantMCMC">
                            <input id="AffineInvariantMCMC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AffineInvariantMCMC</span><wbr>(<span class="base"><a href="#MCMC">MCMC</a></span>):

                <label class="view-source-button" for="AffineInvariantMCMC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AffineInvariantMCMC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AffineInvariantMCMC-338"><a href="#AffineInvariantMCMC-338"><span class="linenos">338</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AffineInvariantMCMC</span><span class="p">(</span><span class="n">MCMC</span><span class="p">):</span>
</span><span id="AffineInvariantMCMC-339"><a href="#AffineInvariantMCMC-339"><span class="linenos">339</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Affine Invariant MCMC.&quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC-340"><a href="#AffineInvariantMCMC-340"><span class="linenos">340</span></a>
</span><span id="AffineInvariantMCMC-341"><a href="#AffineInvariantMCMC-341"><span class="linenos">341</span></a>    <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="AffineInvariantMCMC-342"><a href="#AffineInvariantMCMC-342"><span class="linenos">342</span></a>    <span class="n">init_state</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]</span>
</span><span id="AffineInvariantMCMC-343"><a href="#AffineInvariantMCMC-343"><span class="linenos">343</span></a>    <span class="n">mcmc_state</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]</span>
</span><span id="AffineInvariantMCMC-344"><a href="#AffineInvariantMCMC-344"><span class="linenos">344</span></a>    <span class="n">accept_rate</span><span class="p">:</span> <span class="n">ndarray</span>
</span><span id="AffineInvariantMCMC-345"><a href="#AffineInvariantMCMC-345"><span class="linenos">345</span></a>    <span class="n">accept</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
</span><span id="AffineInvariantMCMC-346"><a href="#AffineInvariantMCMC-346"><span class="linenos">346</span></a>    <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span>
</span><span id="AffineInvariantMCMC-347"><a href="#AffineInvariantMCMC-347"><span class="linenos">347</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span>
</span><span id="AffineInvariantMCMC-348"><a href="#AffineInvariantMCMC-348"><span class="linenos">348</span></a>    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span>
</span><span id="AffineInvariantMCMC-349"><a href="#AffineInvariantMCMC-349"><span class="linenos">349</span></a>
</span><span id="AffineInvariantMCMC-350"><a href="#AffineInvariantMCMC-350"><span class="linenos">350</span></a>    <span class="nd">@cached_property</span>
</span><span id="AffineInvariantMCMC-351"><a href="#AffineInvariantMCMC-351"><span class="linenos">351</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-352"><a href="#AffineInvariantMCMC-352"><span class="linenos">352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of model parameters.&quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC-353"><a href="#AffineInvariantMCMC-353"><span class="linenos">353</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-354"><a href="#AffineInvariantMCMC-354"><span class="linenos">354</span></a>            <span class="nb">sum</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-355"><a href="#AffineInvariantMCMC-355"><span class="linenos">355</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span id="AffineInvariantMCMC-356"><a href="#AffineInvariantMCMC-356"><span class="linenos">356</span></a>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="AffineInvariantMCMC-357"><a href="#AffineInvariantMCMC-357"><span class="linenos">357</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC-358"><a href="#AffineInvariantMCMC-358"><span class="linenos">358</span></a>        <span class="p">)</span>
</span><span id="AffineInvariantMCMC-359"><a href="#AffineInvariantMCMC-359"><span class="linenos">359</span></a>
</span><span id="AffineInvariantMCMC-360"><a href="#AffineInvariantMCMC-360"><span class="linenos">360</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="AffineInvariantMCMC-361"><a href="#AffineInvariantMCMC-361"><span class="linenos">361</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="AffineInvariantMCMC-362"><a href="#AffineInvariantMCMC-362"><span class="linenos">362</span></a>
</span><span id="AffineInvariantMCMC-363"><a href="#AffineInvariantMCMC-363"><span class="linenos">363</span></a><span class="sd">        Parameters</span>
</span><span id="AffineInvariantMCMC-364"><a href="#AffineInvariantMCMC-364"><span class="linenos">364</span></a><span class="sd">        ----------</span>
</span><span id="AffineInvariantMCMC-365"><a href="#AffineInvariantMCMC-365"><span class="linenos">365</span></a><span class="sd">        state : State</span>
</span><span id="AffineInvariantMCMC-366"><a href="#AffineInvariantMCMC-366"><span class="linenos">366</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="AffineInvariantMCMC-367"><a href="#AffineInvariantMCMC-367"><span class="linenos">367</span></a>
</span><span id="AffineInvariantMCMC-368"><a href="#AffineInvariantMCMC-368"><span class="linenos">368</span></a><span class="sd">        Returns</span>
</span><span id="AffineInvariantMCMC-369"><a href="#AffineInvariantMCMC-369"><span class="linenos">369</span></a><span class="sd">        -------</span>
</span><span id="AffineInvariantMCMC-370"><a href="#AffineInvariantMCMC-370"><span class="linenos">370</span></a><span class="sd">        tuple[float, float, State]</span>
</span><span id="AffineInvariantMCMC-371"><a href="#AffineInvariantMCMC-371"><span class="linenos">371</span></a><span class="sd">            (</span>
</span><span id="AffineInvariantMCMC-372"><a href="#AffineInvariantMCMC-372"><span class="linenos">372</span></a><span class="sd">                Log density in native space,</span>
</span><span id="AffineInvariantMCMC-373"><a href="#AffineInvariantMCMC-373"><span class="linenos">373</span></a><span class="sd">                Log determinant of jacobian,</span>
</span><span id="AffineInvariantMCMC-374"><a href="#AffineInvariantMCMC-374"><span class="linenos">374</span></a><span class="sd">                native state and cached values (dict)</span>
</span><span id="AffineInvariantMCMC-375"><a href="#AffineInvariantMCMC-375"><span class="linenos">375</span></a><span class="sd">            )</span>
</span><span id="AffineInvariantMCMC-376"><a href="#AffineInvariantMCMC-376"><span class="linenos">376</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC-377"><a href="#AffineInvariantMCMC-377"><span class="linenos">377</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-378"><a href="#AffineInvariantMCMC-378"><span class="linenos">378</span></a>            <span class="c1"># state is real.</span>
</span><span id="AffineInvariantMCMC-379"><a href="#AffineInvariantMCMC-379"><span class="linenos">379</span></a>            <span class="c1"># Returns logprob, log_det_jacobian, native_state.</span>
</span><span id="AffineInvariantMCMC-380"><a href="#AffineInvariantMCMC-380"><span class="linenos">380</span></a>            <span class="k">return</span> <span class="n">LogprobAndLogjacobianAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-381"><a href="#AffineInvariantMCMC-381"><span class="linenos">381</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="AffineInvariantMCMC-382"><a href="#AffineInvariantMCMC-382"><span class="linenos">382</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC-383"><a href="#AffineInvariantMCMC-383"><span class="linenos">383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-384"><a href="#AffineInvariantMCMC-384"><span class="linenos">384</span></a>            <span class="c1"># state is native.</span>
</span><span id="AffineInvariantMCMC-385"><a href="#AffineInvariantMCMC-385"><span class="linenos">385</span></a>            <span class="c1"># Returns logprob, logprob, state (which is already native).</span>
</span><span id="AffineInvariantMCMC-386"><a href="#AffineInvariantMCMC-386"><span class="linenos">386</span></a>            <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-387"><a href="#AffineInvariantMCMC-387"><span class="linenos">387</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="AffineInvariantMCMC-388"><a href="#AffineInvariantMCMC-388"><span class="linenos">388</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC-389"><a href="#AffineInvariantMCMC-389"><span class="linenos">389</span></a>            <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="AffineInvariantMCMC-390"><a href="#AffineInvariantMCMC-390"><span class="linenos">390</span></a>
</span><span id="AffineInvariantMCMC-391"><a href="#AffineInvariantMCMC-391"><span class="linenos">391</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="AffineInvariantMCMC-392"><a href="#AffineInvariantMCMC-392"><span class="linenos">392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="AffineInvariantMCMC-393"><a href="#AffineInvariantMCMC-393"><span class="linenos">393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="AffineInvariantMCMC-394"><a href="#AffineInvariantMCMC-394"><span class="linenos">394</span></a>
</span><span id="AffineInvariantMCMC-395"><a href="#AffineInvariantMCMC-395"><span class="linenos">395</span></a><span class="sd">        Returns</span>
</span><span id="AffineInvariantMCMC-396"><a href="#AffineInvariantMCMC-396"><span class="linenos">396</span></a><span class="sd">        -------</span>
</span><span id="AffineInvariantMCMC-397"><a href="#AffineInvariantMCMC-397"><span class="linenos">397</span></a><span class="sd">        list[State]</span>
</span><span id="AffineInvariantMCMC-398"><a href="#AffineInvariantMCMC-398"><span class="linenos">398</span></a><span class="sd">            List of native state and cache dictionary.</span>
</span><span id="AffineInvariantMCMC-399"><a href="#AffineInvariantMCMC-399"><span class="linenos">399</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC-400"><a href="#AffineInvariantMCMC-400"><span class="linenos">400</span></a>        <span class="k">pass</span>
</span><span id="AffineInvariantMCMC-401"><a href="#AffineInvariantMCMC-401"><span class="linenos">401</span></a>
</span><span id="AffineInvariantMCMC-402"><a href="#AffineInvariantMCMC-402"><span class="linenos">402</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="AffineInvariantMCMC-403"><a href="#AffineInvariantMCMC-403"><span class="linenos">403</span></a>        <span class="n">this_walker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="AffineInvariantMCMC-404"><a href="#AffineInvariantMCMC-404"><span class="linenos">404</span></a>        <span class="n">z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_z</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-405"><a href="#AffineInvariantMCMC-405"><span class="linenos">405</span></a>        <span class="n">other_walker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_walker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-406"><a href="#AffineInvariantMCMC-406"><span class="linenos">406</span></a>
</span><span id="AffineInvariantMCMC-407"><a href="#AffineInvariantMCMC-407"><span class="linenos">407</span></a>        <span class="n">candidate</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="AffineInvariantMCMC-408"><a href="#AffineInvariantMCMC-408"><span class="linenos">408</span></a>            <span class="n">name</span><span class="p">:</span> <span class="n">value</span> <span class="o">+</span> <span class="p">(</span><span class="n">this_walker</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="n">z</span>
</span><span id="AffineInvariantMCMC-409"><a href="#AffineInvariantMCMC-409"><span class="linenos">409</span></a>            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">other_walker</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="AffineInvariantMCMC-410"><a href="#AffineInvariantMCMC-410"><span class="linenos">410</span></a>        <span class="p">}</span>
</span><span id="AffineInvariantMCMC-411"><a href="#AffineInvariantMCMC-411"><span class="linenos">411</span></a>
</span><span id="AffineInvariantMCMC-412"><a href="#AffineInvariantMCMC-412"><span class="linenos">412</span></a>        <span class="n">cand_logprob</span><span class="p">,</span> <span class="n">cand_ldj</span><span class="p">,</span> <span class="n">cand_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">candidate</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-413"><a href="#AffineInvariantMCMC-413"><span class="linenos">413</span></a>        <span class="n">this_logprob</span><span class="p">,</span> <span class="n">this_ldj</span><span class="p">,</span> <span class="n">this_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">this_walker</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-414"><a href="#AffineInvariantMCMC-414"><span class="linenos">414</span></a>        <span class="n">log_accept_prob</span> <span class="o">=</span> <span class="n">cand_logprob</span> <span class="o">+</span> <span class="n">cand_ldj</span> <span class="o">-</span> <span class="n">this_logprob</span> <span class="o">-</span> <span class="n">this_ldj</span>
</span><span id="AffineInvariantMCMC-415"><a href="#AffineInvariantMCMC-415"><span class="linenos">415</span></a>        <span class="n">log_accept_prob</span> <span class="o">+=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-416"><a href="#AffineInvariantMCMC-416"><span class="linenos">416</span></a>        <span class="k">if</span> <span class="n">log_accept_prob</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_draw_u</span><span class="p">(</span><span class="n">i</span><span class="p">)):</span>
</span><span id="AffineInvariantMCMC-417"><a href="#AffineInvariantMCMC-417"><span class="linenos">417</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">burn</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-418"><a href="#AffineInvariantMCMC-418"><span class="linenos">418</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="AffineInvariantMCMC-419"><a href="#AffineInvariantMCMC-419"><span class="linenos">419</span></a>            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">candidate</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="AffineInvariantMCMC-420"><a href="#AffineInvariantMCMC-420"><span class="linenos">420</span></a>                <span class="n">this_walker</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="AffineInvariantMCMC-421"><a href="#AffineInvariantMCMC-421"><span class="linenos">421</span></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">cand_trace</span>
</span><span id="AffineInvariantMCMC-422"><a href="#AffineInvariantMCMC-422"><span class="linenos">422</span></a>            <span class="n">lp</span> <span class="o">=</span> <span class="n">cand_logprob</span>
</span><span id="AffineInvariantMCMC-423"><a href="#AffineInvariantMCMC-423"><span class="linenos">423</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-424"><a href="#AffineInvariantMCMC-424"><span class="linenos">424</span></a>            <span class="n">trace</span> <span class="o">=</span> <span class="n">this_trace</span>
</span><span id="AffineInvariantMCMC-425"><a href="#AffineInvariantMCMC-425"><span class="linenos">425</span></a>            <span class="n">lp</span> <span class="o">=</span> <span class="n">this_logprob</span>
</span><span id="AffineInvariantMCMC-426"><a href="#AffineInvariantMCMC-426"><span class="linenos">426</span></a>
</span><span id="AffineInvariantMCMC-427"><a href="#AffineInvariantMCMC-427"><span class="linenos">427</span></a>        <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="AffineInvariantMCMC-428"><a href="#AffineInvariantMCMC-428"><span class="linenos">428</span></a>
</span><span id="AffineInvariantMCMC-429"><a href="#AffineInvariantMCMC-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-430"><a href="#AffineInvariantMCMC-430"><span class="linenos">430</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">rebalanced_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="AffineInvariantMCMC-431"><a href="#AffineInvariantMCMC-431"><span class="linenos">431</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-432"><a href="#AffineInvariantMCMC-432"><span class="linenos">432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model with AIES.&quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC-433"><a href="#AffineInvariantMCMC-433"><span class="linenos">433</span></a>        <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="AffineInvariantMCMC-434"><a href="#AffineInvariantMCMC-434"><span class="linenos">434</span></a>
</span><span id="AffineInvariantMCMC-435"><a href="#AffineInvariantMCMC-435"><span class="linenos">435</span></a>        <span class="k">if</span> <span class="n">rebalanced_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-436"><a href="#AffineInvariantMCMC-436"><span class="linenos">436</span></a>            <span class="n">rebalanced_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
</span><span id="AffineInvariantMCMC-437"><a href="#AffineInvariantMCMC-437"><span class="linenos">437</span></a>
</span><span id="AffineInvariantMCMC-438"><a href="#AffineInvariantMCMC-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="n">rebalanced_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-439"><a href="#AffineInvariantMCMC-439"><span class="linenos">439</span></a>            <span class="c1"># Reweight with importance sampling.</span>
</span><span id="AffineInvariantMCMC-440"><a href="#AffineInvariantMCMC-440"><span class="linenos">440</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-441"><a href="#AffineInvariantMCMC-441"><span class="linenos">441</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-442"><a href="#AffineInvariantMCMC-442"><span class="linenos">442</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">rebalanced_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">weights</span>
</span><span id="AffineInvariantMCMC-443"><a href="#AffineInvariantMCMC-443"><span class="linenos">443</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC-444"><a href="#AffineInvariantMCMC-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">resampled_logprob_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-445"><a href="#AffineInvariantMCMC-445"><span class="linenos">445</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
</span><span id="AffineInvariantMCMC-446"><a href="#AffineInvariantMCMC-446"><span class="linenos">446</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC-447"><a href="#AffineInvariantMCMC-447"><span class="linenos">447</span></a>            <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-448"><a href="#AffineInvariantMCMC-448"><span class="linenos">448</span></a>
</span><span id="AffineInvariantMCMC-449"><a href="#AffineInvariantMCMC-449"><span class="linenos">449</span></a>        <span class="k">return</span> <span class="n">chain</span>
</span><span id="AffineInvariantMCMC-450"><a href="#AffineInvariantMCMC-450"><span class="linenos">450</span></a>
</span><span id="AffineInvariantMCMC-451"><a href="#AffineInvariantMCMC-451"><span class="linenos">451</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fit</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC-452"><a href="#AffineInvariantMCMC-452"><span class="linenos">452</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">burn</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">thin</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="AffineInvariantMCMC-453"><a href="#AffineInvariantMCMC-453"><span class="linenos">453</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="n">State</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
</span><span id="AffineInvariantMCMC-454"><a href="#AffineInvariantMCMC-454"><span class="linenos">454</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="n">nsteps</span>
</span><span id="AffineInvariantMCMC-455"><a href="#AffineInvariantMCMC-455"><span class="linenos">455</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nsamples</span> <span class="o">=</span> <span class="n">nsteps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span>
</span><span id="AffineInvariantMCMC-456"><a href="#AffineInvariantMCMC-456"><span class="linenos">456</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">burn</span> <span class="o">=</span> <span class="n">burn</span>
</span><span id="AffineInvariantMCMC-457"><a href="#AffineInvariantMCMC-457"><span class="linenos">457</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">thin</span> <span class="o">=</span> <span class="n">thin</span>
</span><span id="AffineInvariantMCMC-458"><a href="#AffineInvariantMCMC-458"><span class="linenos">458</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-459"><a href="#AffineInvariantMCMC-459"><span class="linenos">459</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AffineInvariantMCMC-460"><a href="#AffineInvariantMCMC-460"><span class="linenos">460</span></a>
</span><span id="AffineInvariantMCMC-461"><a href="#AffineInvariantMCMC-461"><span class="linenos">461</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="n">nsteps</span> <span class="o">*</span> <span class="n">thin</span> <span class="o">+</span> <span class="n">burn</span><span class="p">):</span>
</span><span id="AffineInvariantMCMC-462"><a href="#AffineInvariantMCMC-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_iteration</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="AffineInvariantMCMC-463"><a href="#AffineInvariantMCMC-463"><span class="linenos">463</span></a>            <span class="c1"># NOTE: mcmc_state may not be the returned state, but the state</span>
</span><span id="AffineInvariantMCMC-464"><a href="#AffineInvariantMCMC-464"><span class="linenos">464</span></a>            <span class="c1"># that is used in the MCMC (e.g., for computational efficiency).</span>
</span><span id="AffineInvariantMCMC-465"><a href="#AffineInvariantMCMC-465"><span class="linenos">465</span></a>            <span class="c1"># trace is the state in its native space appended with any cached</span>
</span><span id="AffineInvariantMCMC-466"><a href="#AffineInvariantMCMC-466"><span class="linenos">466</span></a>            <span class="c1"># values.</span>
</span><span id="AffineInvariantMCMC-467"><a href="#AffineInvariantMCMC-467"><span class="linenos">467</span></a>            <span class="n">logprob</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="AffineInvariantMCMC-468"><a href="#AffineInvariantMCMC-468"><span class="linenos">468</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">burn</span> <span class="ow">and</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">thin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-469"><a href="#AffineInvariantMCMC-469"><span class="linenos">469</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">logprob</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-470"><a href="#AffineInvariantMCMC-470"><span class="linenos">470</span></a>                <span class="k">yield from</span> <span class="n">trace</span>
</span><span id="AffineInvariantMCMC-471"><a href="#AffineInvariantMCMC-471"><span class="linenos">471</span></a>
</span><span id="AffineInvariantMCMC-472"><a href="#AffineInvariantMCMC-472"><span class="linenos">472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept_rate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accept</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">thin</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-473"><a href="#AffineInvariantMCMC-473"><span class="linenos">473</span></a>
</span><span id="AffineInvariantMCMC-474"><a href="#AffineInvariantMCMC-474"><span class="linenos">474</span></a>    <span class="nd">@cached_property</span>
</span><span id="AffineInvariantMCMC-475"><a href="#AffineInvariantMCMC-475"><span class="linenos">475</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_root_a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-476"><a href="#AffineInvariantMCMC-476"><span class="linenos">476</span></a>        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-477"><a href="#AffineInvariantMCMC-477"><span class="linenos">477</span></a>
</span><span id="AffineInvariantMCMC-478"><a href="#AffineInvariantMCMC-478"><span class="linenos">478</span></a>    <span class="nd">@cached_property</span>
</span><span id="AffineInvariantMCMC-479"><a href="#AffineInvariantMCMC-479"><span class="linenos">479</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_invroot_a</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-480"><a href="#AffineInvariantMCMC-480"><span class="linenos">480</span></a>        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_root_a</span>
</span><span id="AffineInvariantMCMC-481"><a href="#AffineInvariantMCMC-481"><span class="linenos">481</span></a>
</span><span id="AffineInvariantMCMC-482"><a href="#AffineInvariantMCMC-482"><span class="linenos">482</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="AffineInvariantMCMC-483"><a href="#AffineInvariantMCMC-483"><span class="linenos">483</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span> <span class="o">...</span>
</span><span id="AffineInvariantMCMC-484"><a href="#AffineInvariantMCMC-484"><span class="linenos">484</span></a>
</span><span id="AffineInvariantMCMC-485"><a href="#AffineInvariantMCMC-485"><span class="linenos">485</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="AffineInvariantMCMC-486"><a href="#AffineInvariantMCMC-486"><span class="linenos">486</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span> <span class="o">...</span>
</span><span id="AffineInvariantMCMC-487"><a href="#AffineInvariantMCMC-487"><span class="linenos">487</span></a>
</span><span id="AffineInvariantMCMC-488"><a href="#AffineInvariantMCMC-488"><span class="linenos">488</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_z_given_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-489"><a href="#AffineInvariantMCMC-489"><span class="linenos">489</span></a>        <span class="k">return</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_a</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invroot_a</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invroot_a</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
</span><span id="AffineInvariantMCMC-490"><a href="#AffineInvariantMCMC-490"><span class="linenos">490</span></a>
</span><span id="AffineInvariantMCMC-491"><a href="#AffineInvariantMCMC-491"><span class="linenos">491</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_z</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC-492"><a href="#AffineInvariantMCMC-492"><span class="linenos">492</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_u</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC-493"><a href="#AffineInvariantMCMC-493"><span class="linenos">493</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_z_given_u</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Affine Invariant MCMC.</p>
</div>


                            <div id="AffineInvariantMCMC.nsteps" class="classattr">
                                <div class="attr variable">
            <span class="name">nsteps</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.nsteps"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.init_state" class="classattr">
                                <div class="attr variable">
            <span class="name">init_state</span><span class="annotation">: list[dict[str, float | numpy.ndarray]]</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.init_state"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.mcmc_state" class="classattr">
                                <div class="attr variable">
            <span class="name">mcmc_state</span><span class="annotation">: list[dict[str, float | numpy.ndarray]]</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.mcmc_state"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.accept_rate" class="classattr">
                                <div class="attr variable">
            <span class="name">accept_rate</span><span class="annotation">: numpy.ndarray</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.accept_rate"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.accept" class="classattr">
                                <div class="attr variable">
            <span class="name">accept</span><span class="annotation">: list[int]</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.accept"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.nwalkers" class="classattr">
                                <div class="attr variable">
            <span class="name">nwalkers</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.nwalkers"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.rng" class="classattr">
                                <div class="attr variable">
            <span class="name">rng</span><span class="annotation">: numpy.random._generator.Generator</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.rng"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.a" class="classattr">
                                <div class="attr variable">
            <span class="name">a</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.a"></a>
    
    

                            </div>
                            <div id="AffineInvariantMCMC.dim" class="classattr">
                                        <input id="AffineInvariantMCMC.dim-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">dim</span><span class="annotation">: int</span>

                <label class="view-source-button" for="AffineInvariantMCMC.dim-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.dim"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AffineInvariantMCMC.dim-350"><a href="#AffineInvariantMCMC.dim-350"><span class="linenos">350</span></a>    <span class="nd">@cached_property</span>
</span><span id="AffineInvariantMCMC.dim-351"><a href="#AffineInvariantMCMC.dim-351"><span class="linenos">351</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dim</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC.dim-352"><a href="#AffineInvariantMCMC.dim-352"><span class="linenos">352</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of model parameters.&quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC.dim-353"><a href="#AffineInvariantMCMC.dim-353"><span class="linenos">353</span></a>        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC.dim-354"><a href="#AffineInvariantMCMC.dim-354"><span class="linenos">354</span></a>            <span class="nb">sum</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC.dim-355"><a href="#AffineInvariantMCMC.dim-355"><span class="linenos">355</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
</span><span id="AffineInvariantMCMC.dim-356"><a href="#AffineInvariantMCMC.dim-356"><span class="linenos">356</span></a>                <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="AffineInvariantMCMC.dim-357"><a href="#AffineInvariantMCMC.dim-357"><span class="linenos">357</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC.dim-358"><a href="#AffineInvariantMCMC.dim-358"><span class="linenos">358</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Number of model parameters.</p>
</div>


                            </div>
                            <div id="AffineInvariantMCMC.logprob" class="classattr">
                                        <input id="AffineInvariantMCMC.logprob-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">logprob</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">state</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="AffineInvariantMCMC.logprob-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.logprob"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AffineInvariantMCMC.logprob-360"><a href="#AffineInvariantMCMC.logprob-360"><span class="linenos">360</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">State</span><span class="p">]:</span>
</span><span id="AffineInvariantMCMC.logprob-361"><a href="#AffineInvariantMCMC.logprob-361"><span class="linenos">361</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="AffineInvariantMCMC.logprob-362"><a href="#AffineInvariantMCMC.logprob-362"><span class="linenos">362</span></a>
</span><span id="AffineInvariantMCMC.logprob-363"><a href="#AffineInvariantMCMC.logprob-363"><span class="linenos">363</span></a><span class="sd">        Parameters</span>
</span><span id="AffineInvariantMCMC.logprob-364"><a href="#AffineInvariantMCMC.logprob-364"><span class="linenos">364</span></a><span class="sd">        ----------</span>
</span><span id="AffineInvariantMCMC.logprob-365"><a href="#AffineInvariantMCMC.logprob-365"><span class="linenos">365</span></a><span class="sd">        state : State</span>
</span><span id="AffineInvariantMCMC.logprob-366"><a href="#AffineInvariantMCMC.logprob-366"><span class="linenos">366</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="AffineInvariantMCMC.logprob-367"><a href="#AffineInvariantMCMC.logprob-367"><span class="linenos">367</span></a>
</span><span id="AffineInvariantMCMC.logprob-368"><a href="#AffineInvariantMCMC.logprob-368"><span class="linenos">368</span></a><span class="sd">        Returns</span>
</span><span id="AffineInvariantMCMC.logprob-369"><a href="#AffineInvariantMCMC.logprob-369"><span class="linenos">369</span></a><span class="sd">        -------</span>
</span><span id="AffineInvariantMCMC.logprob-370"><a href="#AffineInvariantMCMC.logprob-370"><span class="linenos">370</span></a><span class="sd">        tuple[float, float, State]</span>
</span><span id="AffineInvariantMCMC.logprob-371"><a href="#AffineInvariantMCMC.logprob-371"><span class="linenos">371</span></a><span class="sd">            (</span>
</span><span id="AffineInvariantMCMC.logprob-372"><a href="#AffineInvariantMCMC.logprob-372"><span class="linenos">372</span></a><span class="sd">                Log density in native space,</span>
</span><span id="AffineInvariantMCMC.logprob-373"><a href="#AffineInvariantMCMC.logprob-373"><span class="linenos">373</span></a><span class="sd">                Log determinant of jacobian,</span>
</span><span id="AffineInvariantMCMC.logprob-374"><a href="#AffineInvariantMCMC.logprob-374"><span class="linenos">374</span></a><span class="sd">                native state and cached values (dict)</span>
</span><span id="AffineInvariantMCMC.logprob-375"><a href="#AffineInvariantMCMC.logprob-375"><span class="linenos">375</span></a><span class="sd">            )</span>
</span><span id="AffineInvariantMCMC.logprob-376"><a href="#AffineInvariantMCMC.logprob-376"><span class="linenos">376</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC.logprob-377"><a href="#AffineInvariantMCMC.logprob-377"><span class="linenos">377</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC.logprob-378"><a href="#AffineInvariantMCMC.logprob-378"><span class="linenos">378</span></a>            <span class="c1"># state is real.</span>
</span><span id="AffineInvariantMCMC.logprob-379"><a href="#AffineInvariantMCMC.logprob-379"><span class="linenos">379</span></a>            <span class="c1"># Returns logprob, log_det_jacobian, native_state.</span>
</span><span id="AffineInvariantMCMC.logprob-380"><a href="#AffineInvariantMCMC.logprob-380"><span class="linenos">380</span></a>            <span class="k">return</span> <span class="n">LogprobAndLogjacobianAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC.logprob-381"><a href="#AffineInvariantMCMC.logprob-381"><span class="linenos">381</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="AffineInvariantMCMC.logprob-382"><a href="#AffineInvariantMCMC.logprob-382"><span class="linenos">382</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC.logprob-383"><a href="#AffineInvariantMCMC.logprob-383"><span class="linenos">383</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC.logprob-384"><a href="#AffineInvariantMCMC.logprob-384"><span class="linenos">384</span></a>            <span class="c1"># state is native.</span>
</span><span id="AffineInvariantMCMC.logprob-385"><a href="#AffineInvariantMCMC.logprob-385"><span class="linenos">385</span></a>            <span class="c1"># Returns logprob, logprob, state (which is already native).</span>
</span><span id="AffineInvariantMCMC.logprob-386"><a href="#AffineInvariantMCMC.logprob-386"><span class="linenos">386</span></a>            <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC.logprob-387"><a href="#AffineInvariantMCMC.logprob-387"><span class="linenos">387</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="AffineInvariantMCMC.logprob-388"><a href="#AffineInvariantMCMC.logprob-388"><span class="linenos">388</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC.logprob-389"><a href="#AffineInvariantMCMC.logprob-389"><span class="linenos">389</span></a>            <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">trace</span>
</span></pre></div>


            <div class="docstring"><p>Compute log density.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>state</strong> (State):
Dictionary containing random variables to model.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>tuple[float, float, State]</strong>: (
Log density in native space,
Log determinant of jacobian,
native state and cached values (dict)
)</li>
</ul>
</div>


                            </div>
                            <div id="AffineInvariantMCMC.step" class="classattr">
                                        <input id="AffineInvariantMCMC.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-abstractmethod">@abstractmethod</div>

        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span>:</span></span>

                <label class="view-source-button" for="AffineInvariantMCMC.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AffineInvariantMCMC.step-391"><a href="#AffineInvariantMCMC.step-391"><span class="linenos">391</span></a>    <span class="nd">@abstractmethod</span>
</span><span id="AffineInvariantMCMC.step-392"><a href="#AffineInvariantMCMC.step-392"><span class="linenos">392</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="AffineInvariantMCMC.step-393"><a href="#AffineInvariantMCMC.step-393"><span class="linenos">393</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="AffineInvariantMCMC.step-394"><a href="#AffineInvariantMCMC.step-394"><span class="linenos">394</span></a>
</span><span id="AffineInvariantMCMC.step-395"><a href="#AffineInvariantMCMC.step-395"><span class="linenos">395</span></a><span class="sd">        Returns</span>
</span><span id="AffineInvariantMCMC.step-396"><a href="#AffineInvariantMCMC.step-396"><span class="linenos">396</span></a><span class="sd">        -------</span>
</span><span id="AffineInvariantMCMC.step-397"><a href="#AffineInvariantMCMC.step-397"><span class="linenos">397</span></a><span class="sd">        list[State]</span>
</span><span id="AffineInvariantMCMC.step-398"><a href="#AffineInvariantMCMC.step-398"><span class="linenos">398</span></a><span class="sd">            List of native state and cache dictionary.</span>
</span><span id="AffineInvariantMCMC.step-399"><a href="#AffineInvariantMCMC.step-399"><span class="linenos">399</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC.step-400"><a href="#AffineInvariantMCMC.step-400"><span class="linenos">400</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Update mcmc_state and return list of native_state_and_cache.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list[State]</strong>: List of native state and cache dictionary.</li>
</ul>
</div>


                            </div>
                            <div id="AffineInvariantMCMC.fit" class="classattr">
                                        <input id="AffineInvariantMCMC.fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="o">*</span><span class="n">args</span>,</span><span class="param">	<span class="n">rebalanced_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n"><a href="#Chain">Chain</a></span>:</span></span>

                <label class="view-source-button" for="AffineInvariantMCMC.fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AffineInvariantMCMC.fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AffineInvariantMCMC.fit-429"><a href="#AffineInvariantMCMC.fit-429"><span class="linenos">429</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC.fit-430"><a href="#AffineInvariantMCMC.fit-430"><span class="linenos">430</span></a>        <span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">rebalanced_samples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
</span><span id="AffineInvariantMCMC.fit-431"><a href="#AffineInvariantMCMC.fit-431"><span class="linenos">431</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC.fit-432"><a href="#AffineInvariantMCMC.fit-432"><span class="linenos">432</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model with AIES.&quot;&quot;&quot;</span>
</span><span id="AffineInvariantMCMC.fit-433"><a href="#AffineInvariantMCMC.fit-433"><span class="linenos">433</span></a>        <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
</span><span id="AffineInvariantMCMC.fit-434"><a href="#AffineInvariantMCMC.fit-434"><span class="linenos">434</span></a>
</span><span id="AffineInvariantMCMC.fit-435"><a href="#AffineInvariantMCMC.fit-435"><span class="linenos">435</span></a>        <span class="k">if</span> <span class="n">rebalanced_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC.fit-436"><a href="#AffineInvariantMCMC.fit-436"><span class="linenos">436</span></a>            <span class="n">rebalanced_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span>
</span><span id="AffineInvariantMCMC.fit-437"><a href="#AffineInvariantMCMC.fit-437"><span class="linenos">437</span></a>
</span><span id="AffineInvariantMCMC.fit-438"><a href="#AffineInvariantMCMC.fit-438"><span class="linenos">438</span></a>        <span class="k">if</span> <span class="n">rebalanced_samples</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="AffineInvariantMCMC.fit-439"><a href="#AffineInvariantMCMC.fit-439"><span class="linenos">439</span></a>            <span class="c1"># Reweight with importance sampling.</span>
</span><span id="AffineInvariantMCMC.fit-440"><a href="#AffineInvariantMCMC.fit-440"><span class="linenos">440</span></a>            <span class="n">weights</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC.fit-441"><a href="#AffineInvariantMCMC.fit-441"><span class="linenos">441</span></a>            <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC.fit-442"><a href="#AffineInvariantMCMC.fit-442"><span class="linenos">442</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">rebalanced_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">weights</span>
</span><span id="AffineInvariantMCMC.fit-443"><a href="#AffineInvariantMCMC.fit-443"><span class="linenos">443</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC.fit-444"><a href="#AffineInvariantMCMC.fit-444"><span class="linenos">444</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">resampled_logprob_history</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="AffineInvariantMCMC.fit-445"><a href="#AffineInvariantMCMC.fit-445"><span class="linenos">445</span></a>                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob_history</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">]</span>
</span><span id="AffineInvariantMCMC.fit-446"><a href="#AffineInvariantMCMC.fit-446"><span class="linenos">446</span></a>            <span class="p">)</span>
</span><span id="AffineInvariantMCMC.fit-447"><a href="#AffineInvariantMCMC.fit-447"><span class="linenos">447</span></a>            <span class="n">chain</span> <span class="o">=</span> <span class="n">Chain</span><span class="p">(</span><span class="n">chain</span><span class="o">.</span><span class="n">states</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index</span><span class="p">)</span>
</span><span id="AffineInvariantMCMC.fit-448"><a href="#AffineInvariantMCMC.fit-448"><span class="linenos">448</span></a>
</span><span id="AffineInvariantMCMC.fit-449"><a href="#AffineInvariantMCMC.fit-449"><span class="linenos">449</span></a>        <span class="k">return</span> <span class="n">chain</span>
</span></pre></div>


            <div class="docstring"><p>Fit model with AIES.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#MCMC">MCMC</a></dt>
                                <dd id="AffineInvariantMCMC.model" class="variable"><a href="#MCMC.model">model</a></dd>
                <dd id="AffineInvariantMCMC.model_data" class="variable"><a href="#MCMC.model_data">model_data</a></dd>
                <dd id="AffineInvariantMCMC.nsamples" class="variable"><a href="#MCMC.nsamples">nsamples</a></dd>
                <dd id="AffineInvariantMCMC.burn" class="variable"><a href="#MCMC.burn">burn</a></dd>
                <dd id="AffineInvariantMCMC.thin" class="variable"><a href="#MCMC.thin">thin</a></dd>
                <dd id="AffineInvariantMCMC.mcmc_iteration" class="variable"><a href="#MCMC.mcmc_iteration">mcmc_iteration</a></dd>
                <dd id="AffineInvariantMCMC.transform" class="variable"><a href="#MCMC.transform">transform</a></dd>
                <dd id="AffineInvariantMCMC.logprob_history" class="variable"><a href="#MCMC.logprob_history">logprob_history</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="AIES">
                            <input id="AIES-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AIES</span><wbr>(<span class="base"><a href="#AffineInvariantMCMC">AffineInvariantMCMC</a></span>):

                <label class="view-source-button" for="AIES-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIES"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIES-497"><a href="#AIES-497"><span class="linenos">497</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AIES</span><span class="p">(</span><span class="n">AffineInvariantMCMC</span><span class="p">):</span>
</span><span id="AIES-498"><a href="#AIES-498"><span class="linenos">498</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequential Affine Invariant Ensemble Sampler.</span>
</span><span id="AIES-499"><a href="#AIES-499"><span class="linenos">499</span></a>
</span><span id="AIES-500"><a href="#AIES-500"><span class="linenos">500</span></a><span class="sd">    This sampler is good for target distributions that are not multimodal and</span>
</span><span id="AIES-501"><a href="#AIES-501"><span class="linenos">501</span></a><span class="sd">    separated by large low density regions. You should use as many walkers as</span>
</span><span id="AIES-502"><a href="#AIES-502"><span class="linenos">502</span></a><span class="sd">    you can afford. Whereas this sampler employs walkers that are sequeutnailly</span>
</span><span id="AIES-503"><a href="#AIES-503"><span class="linenos">503</span></a><span class="sd">    updated.  there is a parallel analog that updates walkers in parallel.</span>
</span><span id="AIES-504"><a href="#AIES-504"><span class="linenos">504</span></a>
</span><span id="AIES-505"><a href="#AIES-505"><span class="linenos">505</span></a><span class="sd">    Parameters</span>
</span><span id="AIES-506"><a href="#AIES-506"><span class="linenos">506</span></a><span class="sd">    ----------</span>
</span><span id="AIES-507"><a href="#AIES-507"><span class="linenos">507</span></a><span class="sd">    model : Model</span>
</span><span id="AIES-508"><a href="#AIES-508"><span class="linenos">508</span></a><span class="sd">        A model function of the form `def model(ctx: Context, **data)`.</span>
</span><span id="AIES-509"><a href="#AIES-509"><span class="linenos">509</span></a><span class="sd">    num_walkers : int, optional</span>
</span><span id="AIES-510"><a href="#AIES-510"><span class="linenos">510</span></a><span class="sd">        Number of walkers. Defaults to 10.</span>
</span><span id="AIES-511"><a href="#AIES-511"><span class="linenos">511</span></a><span class="sd">    transform : bool, optional</span>
</span><span id="AIES-512"><a href="#AIES-512"><span class="linenos">512</span></a><span class="sd">        Whether or not to transform parameters into the real space, by default</span>
</span><span id="AIES-513"><a href="#AIES-513"><span class="linenos">513</span></a><span class="sd">        True.</span>
</span><span id="AIES-514"><a href="#AIES-514"><span class="linenos">514</span></a><span class="sd">    rng : RNG, optional</span>
</span><span id="AIES-515"><a href="#AIES-515"><span class="linenos">515</span></a><span class="sd">        Random number generator, by default default_rng()</span>
</span><span id="AIES-516"><a href="#AIES-516"><span class="linenos">516</span></a><span class="sd">    a : float, optional</span>
</span><span id="AIES-517"><a href="#AIES-517"><span class="linenos">517</span></a><span class="sd">        Tuning parameter that is set, by default, to 2.0, which is good for many</span>
</span><span id="AIES-518"><a href="#AIES-518"><span class="linenos">518</span></a><span class="sd">        cases.</span>
</span><span id="AIES-519"><a href="#AIES-519"><span class="linenos">519</span></a><span class="sd">    temperature_fn : Optional[Callable[[int], float]], optional</span>
</span><span id="AIES-520"><a href="#AIES-520"><span class="linenos">520</span></a><span class="sd">        A temperature function for annealing, by default None.</span>
</span><span id="AIES-521"><a href="#AIES-521"><span class="linenos">521</span></a>
</span><span id="AIES-522"><a href="#AIES-522"><span class="linenos">522</span></a><span class="sd">    References</span>
</span><span id="AIES-523"><a href="#AIES-523"><span class="linenos">523</span></a><span class="sd">    ----------</span>
</span><span id="AIES-524"><a href="#AIES-524"><span class="linenos">524</span></a><span class="sd">    - [emcee: The MCMC Hammer](https://arxiv.org/pdf/1202.3665)</span>
</span><span id="AIES-525"><a href="#AIES-525"><span class="linenos">525</span></a><span class="sd">    - [Ensemble Samplers with Affine Invariance](https://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-s.pdf)</span>
</span><span id="AIES-526"><a href="#AIES-526"><span class="linenos">526</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="AIES-527"><a href="#AIES-527"><span class="linenos">527</span></a>
</span><span id="AIES-528"><a href="#AIES-528"><span class="linenos">528</span></a>    <span class="nd">@staticmethod</span>
</span><span id="AIES-529"><a href="#AIES-529"><span class="linenos">529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">default_temperature_fn</span><span class="p">(</span><span class="nb">iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AIES-530"><a href="#AIES-530"><span class="linenos">530</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return 1.&quot;&quot;&quot;</span>
</span><span id="AIES-531"><a href="#AIES-531"><span class="linenos">531</span></a>        <span class="k">return</span> <span class="mf">1.0</span>
</span><span id="AIES-532"><a href="#AIES-532"><span class="linenos">532</span></a>
</span><span id="AIES-533"><a href="#AIES-533"><span class="linenos">533</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AIES-534"><a href="#AIES-534"><span class="linenos">534</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AIES-535"><a href="#AIES-535"><span class="linenos">535</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="AIES-536"><a href="#AIES-536"><span class="linenos">536</span></a>        <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="AIES-537"><a href="#AIES-537"><span class="linenos">537</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AIES-538"><a href="#AIES-538"><span class="linenos">538</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(),</span>
</span><span id="AIES-539"><a href="#AIES-539"><span class="linenos">539</span></a>        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="AIES-540"><a href="#AIES-540"><span class="linenos">540</span></a>        <span class="n">temperature_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AIES-541"><a href="#AIES-541"><span class="linenos">541</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AIES-542"><a href="#AIES-542"><span class="linenos">542</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="AIES-543"><a href="#AIES-543"><span class="linenos">543</span></a>    <span class="p">):</span>
</span><span id="AIES-544"><a href="#AIES-544"><span class="linenos">544</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="AIES-545"><a href="#AIES-545"><span class="linenos">545</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">nwalkers</span>
</span><span id="AIES-546"><a href="#AIES-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="AIES-547"><a href="#AIES-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
</span><span id="AIES-548"><a href="#AIES-548"><span class="linenos">548</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nwalkers</span>
</span><span id="AIES-549"><a href="#AIES-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AIES-550"><a href="#AIES-550"><span class="linenos">550</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tuning parameter `a` must be larger than 1.&quot;</span><span class="p">)</span>
</span><span id="AIES-551"><a href="#AIES-551"><span class="linenos">551</span></a>
</span><span id="AIES-552"><a href="#AIES-552"><span class="linenos">552</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="AIES-553"><a href="#AIES-553"><span class="linenos">553</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="AIES-554"><a href="#AIES-554"><span class="linenos">554</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temperature_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AIES-555"><a href="#AIES-555"><span class="linenos">555</span></a>            <span class="n">temperature_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_temperature_fn</span>
</span><span id="AIES-556"><a href="#AIES-556"><span class="linenos">556</span></a>        <span class="p">)</span>
</span><span id="AIES-557"><a href="#AIES-557"><span class="linenos">557</span></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TransformedPredictive</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="n">Predictive</span>
</span><span id="AIES-558"><a href="#AIES-558"><span class="linenos">558</span></a>        <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIES-559"><a href="#AIES-559"><span class="linenos">559</span></a>            <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AIES-560"><a href="#AIES-560"><span class="linenos">560</span></a>                <span class="n">predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="AIES-561"><a href="#AIES-561"><span class="linenos">561</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="AIES-562"><a href="#AIES-562"><span class="linenos">562</span></a>                <span class="p">)</span>
</span><span id="AIES-563"><a href="#AIES-563"><span class="linenos">563</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="AIES-564"><a href="#AIES-564"><span class="linenos">564</span></a>            <span class="p">]</span>
</span><span id="AIES-565"><a href="#AIES-565"><span class="linenos">565</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span><span id="AIES-566"><a href="#AIES-566"><span class="linenos">566</span></a>
</span><span id="AIES-567"><a href="#AIES-567"><span class="linenos">567</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="AIES-568"><a href="#AIES-568"><span class="linenos">568</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="AIES-569"><a href="#AIES-569"><span class="linenos">569</span></a>
</span><span id="AIES-570"><a href="#AIES-570"><span class="linenos">570</span></a><span class="sd">        Returns</span>
</span><span id="AIES-571"><a href="#AIES-571"><span class="linenos">571</span></a><span class="sd">        -------</span>
</span><span id="AIES-572"><a href="#AIES-572"><span class="linenos">572</span></a><span class="sd">        list[float], list[State]</span>
</span><span id="AIES-573"><a href="#AIES-573"><span class="linenos">573</span></a><span class="sd">            List of logprobs and list of native state and cache dictionary.</span>
</span><span id="AIES-574"><a href="#AIES-574"><span class="linenos">574</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIES-575"><a href="#AIES-575"><span class="linenos">575</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AIES-576"><a href="#AIES-576"><span class="linenos">576</span></a>        <span class="n">lp</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AIES-577"><a href="#AIES-577"><span class="linenos">577</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">):</span>
</span><span id="AIES-578"><a href="#AIES-578"><span class="linenos">578</span></a>            <span class="n">lp_i</span><span class="p">,</span> <span class="n">trace_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="AIES-579"><a href="#AIES-579"><span class="linenos">579</span></a>            <span class="n">lp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp_i</span><span class="p">)</span>
</span><span id="AIES-580"><a href="#AIES-580"><span class="linenos">580</span></a>            <span class="n">trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace_i</span><span class="p">)</span>
</span><span id="AIES-581"><a href="#AIES-581"><span class="linenos">581</span></a>
</span><span id="AIES-582"><a href="#AIES-582"><span class="linenos">582</span></a>        <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="AIES-583"><a href="#AIES-583"><span class="linenos">583</span></a>
</span><span id="AIES-584"><a href="#AIES-584"><span class="linenos">584</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AIES-585"><a href="#AIES-585"><span class="linenos">585</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
</span><span id="AIES-586"><a href="#AIES-586"><span class="linenos">586</span></a>
</span><span id="AIES-587"><a href="#AIES-587"><span class="linenos">587</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
</span><span id="AIES-588"><a href="#AIES-588"><span class="linenos">588</span></a>        <span class="c1"># Draw anything but the current walker (i).</span>
</span><span id="AIES-589"><a href="#AIES-589"><span class="linenos">589</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">))</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
</span><span id="AIES-590"><a href="#AIES-590"><span class="linenos">590</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_walker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="AIES-591"><a href="#AIES-591"><span class="linenos">591</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="AIES-592"><a href="#AIES-592"><span class="linenos">592</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Sequential Affine Invariant Ensemble Sampler.</p>

<p>This sampler is good for target distributions that are not multimodal and
separated by large low density regions. You should use as many walkers as
you can afford. Whereas this sampler employs walkers that are sequeutnailly
updated.  there is a parallel analog that updates walkers in parallel.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>model</strong> (Model):
A model function of the form <code>def model(ctx: Context, **data)</code>.</li>
<li><strong>num_walkers</strong> (int, optional):
Number of walkers. Defaults to 10.</li>
<li><strong>transform</strong> (bool, optional):
Whether or not to transform parameters into the real space, by default
True.</li>
<li><strong>rng</strong> (RNG, optional):
Random number generator, by default default_rng()</li>
<li><strong>a</strong> (float, optional):
Tuning parameter that is set, by default, to 2.0, which is good for many
cases.</li>
<li><strong>temperature_fn</strong> (Optional[Callable[[int], float]], optional):
A temperature function for annealing, by default None.</li>
</ul>

<h6 id="references">References</h6>

<ul>
<li><a href="https://arxiv.org/pdf/1202.3665">emcee: The MCMC Hammer</a></li>
<li><a href="https://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-s.pdf">Ensemble Samplers with Affine Invariance</a></li>
</ul>
</div>


                            <div id="AIES.__init__" class="classattr">
                                        <input id="AIES.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">AIES</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n"><a href="context.html#Context">arianna.ppl.context.Context</a></span><span class="p">,</span> <span class="o">~</span><span class="n">P</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span>,</span><span class="param">	<span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">rng</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">_generator</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">PCG64</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x105861000</span>,</span><span class="param">	<span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>,</span><span class="param">	<span class="n">temperature_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">model_data</span></span>)</span>

                <label class="view-source-button" for="AIES.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIES.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIES.__init__-533"><a href="#AIES.__init__-533"><span class="linenos">533</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="AIES.__init__-534"><a href="#AIES.__init__-534"><span class="linenos">534</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="AIES.__init__-535"><a href="#AIES.__init__-535"><span class="linenos">535</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="AIES.__init__-536"><a href="#AIES.__init__-536"><span class="linenos">536</span></a>        <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="AIES.__init__-537"><a href="#AIES.__init__-537"><span class="linenos">537</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="AIES.__init__-538"><a href="#AIES.__init__-538"><span class="linenos">538</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(),</span>
</span><span id="AIES.__init__-539"><a href="#AIES.__init__-539"><span class="linenos">539</span></a>        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="AIES.__init__-540"><a href="#AIES.__init__-540"><span class="linenos">540</span></a>        <span class="n">temperature_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AIES.__init__-541"><a href="#AIES.__init__-541"><span class="linenos">541</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="AIES.__init__-542"><a href="#AIES.__init__-542"><span class="linenos">542</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="AIES.__init__-543"><a href="#AIES.__init__-543"><span class="linenos">543</span></a>    <span class="p">):</span>
</span><span id="AIES.__init__-544"><a href="#AIES.__init__-544"><span class="linenos">544</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="AIES.__init__-545"><a href="#AIES.__init__-545"><span class="linenos">545</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">nwalkers</span>
</span><span id="AIES.__init__-546"><a href="#AIES.__init__-546"><span class="linenos">546</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="AIES.__init__-547"><a href="#AIES.__init__-547"><span class="linenos">547</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
</span><span id="AIES.__init__-548"><a href="#AIES.__init__-548"><span class="linenos">548</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nwalkers</span>
</span><span id="AIES.__init__-549"><a href="#AIES.__init__-549"><span class="linenos">549</span></a>        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="AIES.__init__-550"><a href="#AIES.__init__-550"><span class="linenos">550</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tuning parameter `a` must be larger than 1.&quot;</span><span class="p">)</span>
</span><span id="AIES.__init__-551"><a href="#AIES.__init__-551"><span class="linenos">551</span></a>
</span><span id="AIES.__init__-552"><a href="#AIES.__init__-552"><span class="linenos">552</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="AIES.__init__-553"><a href="#AIES.__init__-553"><span class="linenos">553</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="AIES.__init__-554"><a href="#AIES.__init__-554"><span class="linenos">554</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temperature_fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="AIES.__init__-555"><a href="#AIES.__init__-555"><span class="linenos">555</span></a>            <span class="n">temperature_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_temperature_fn</span>
</span><span id="AIES.__init__-556"><a href="#AIES.__init__-556"><span class="linenos">556</span></a>        <span class="p">)</span>
</span><span id="AIES.__init__-557"><a href="#AIES.__init__-557"><span class="linenos">557</span></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TransformedPredictive</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="n">Predictive</span>
</span><span id="AIES.__init__-558"><a href="#AIES.__init__-558"><span class="linenos">558</span></a>        <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="AIES.__init__-559"><a href="#AIES.__init__-559"><span class="linenos">559</span></a>            <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="AIES.__init__-560"><a href="#AIES.__init__-560"><span class="linenos">560</span></a>                <span class="n">predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="AIES.__init__-561"><a href="#AIES.__init__-561"><span class="linenos">561</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="AIES.__init__-562"><a href="#AIES.__init__-562"><span class="linenos">562</span></a>                <span class="p">)</span>
</span><span id="AIES.__init__-563"><a href="#AIES.__init__-563"><span class="linenos">563</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="AIES.__init__-564"><a href="#AIES.__init__-564"><span class="linenos">564</span></a>            <span class="p">]</span>
</span><span id="AIES.__init__-565"><a href="#AIES.__init__-565"><span class="linenos">565</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span></pre></div>


    

                            </div>
                            <div id="AIES.default_temperature_fn" class="classattr">
                                        <input id="AIES.default_temperature_fn-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-staticmethod">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">default_temperature_fn</span><span class="signature pdoc-code condensed">(<span class="param"><span class="nb">iter</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="AIES.default_temperature_fn-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIES.default_temperature_fn"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIES.default_temperature_fn-528"><a href="#AIES.default_temperature_fn-528"><span class="linenos">528</span></a>    <span class="nd">@staticmethod</span>
</span><span id="AIES.default_temperature_fn-529"><a href="#AIES.default_temperature_fn-529"><span class="linenos">529</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">default_temperature_fn</span><span class="p">(</span><span class="nb">iter</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="AIES.default_temperature_fn-530"><a href="#AIES.default_temperature_fn-530"><span class="linenos">530</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Return 1.&quot;&quot;&quot;</span>
</span><span id="AIES.default_temperature_fn-531"><a href="#AIES.default_temperature_fn-531"><span class="linenos">531</span></a>        <span class="k">return</span> <span class="mf">1.0</span>
</span></pre></div>


            <div class="docstring"><p>Return 1.</p>
</div>


                            </div>
                            <div id="AIES.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span><span class="annotation">: Callable[Concatenate[<a href="context.html#Context">arianna.ppl.context.Context</a>, ~P], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#AIES.model"></a>
    
    

                            </div>
                            <div id="AIES.nwalkers" class="classattr">
                                <div class="attr variable">
            <span class="name">nwalkers</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#AIES.nwalkers"></a>
    
    

                            </div>
                            <div id="AIES.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#AIES.transform"></a>
    
    

                            </div>
                            <div id="AIES.rng" class="classattr">
                                <div class="attr variable">
            <span class="name">rng</span>

        
    </div>
    <a class="headerlink" href="#AIES.rng"></a>
    
    

                            </div>
                            <div id="AIES.accept" class="classattr">
                                <div class="attr variable">
            <span class="name">accept</span>

        
    </div>
    <a class="headerlink" href="#AIES.accept"></a>
    
    

                            </div>
                            <div id="AIES.a" class="classattr">
                                <div class="attr variable">
            <span class="name">a</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#AIES.a"></a>
    
    

                            </div>
                            <div id="AIES.model_data" class="classattr">
                                <div class="attr variable">
            <span class="name">model_data</span>

        
    </div>
    <a class="headerlink" href="#AIES.model_data"></a>
    
    

                            </div>
                            <div id="AIES.temperature_fn" class="classattr">
                                <div class="attr variable">
            <span class="name">temperature_fn</span><span class="annotation">: Callable[[int], float]</span>

        
    </div>
    <a class="headerlink" href="#AIES.temperature_fn"></a>
    
    

                            </div>
                            <div id="AIES.init_state" class="classattr">
                                <div class="attr variable">
            <span class="name">init_state</span>

        
    </div>
    <a class="headerlink" href="#AIES.init_state"></a>
    
    

                            </div>
                            <div id="AIES.step" class="classattr">
                                        <input id="AIES.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span>:</span></span>

                <label class="view-source-button" for="AIES.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AIES.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AIES.step-567"><a href="#AIES.step-567"><span class="linenos">567</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="AIES.step-568"><a href="#AIES.step-568"><span class="linenos">568</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="AIES.step-569"><a href="#AIES.step-569"><span class="linenos">569</span></a>
</span><span id="AIES.step-570"><a href="#AIES.step-570"><span class="linenos">570</span></a><span class="sd">        Returns</span>
</span><span id="AIES.step-571"><a href="#AIES.step-571"><span class="linenos">571</span></a><span class="sd">        -------</span>
</span><span id="AIES.step-572"><a href="#AIES.step-572"><span class="linenos">572</span></a><span class="sd">        list[float], list[State]</span>
</span><span id="AIES.step-573"><a href="#AIES.step-573"><span class="linenos">573</span></a><span class="sd">            List of logprobs and list of native state and cache dictionary.</span>
</span><span id="AIES.step-574"><a href="#AIES.step-574"><span class="linenos">574</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="AIES.step-575"><a href="#AIES.step-575"><span class="linenos">575</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AIES.step-576"><a href="#AIES.step-576"><span class="linenos">576</span></a>        <span class="n">lp</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="AIES.step-577"><a href="#AIES.step-577"><span class="linenos">577</span></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">):</span>
</span><span id="AIES.step-578"><a href="#AIES.step-578"><span class="linenos">578</span></a>            <span class="n">lp_i</span><span class="p">,</span> <span class="n">trace_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="AIES.step-579"><a href="#AIES.step-579"><span class="linenos">579</span></a>            <span class="n">lp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lp_i</span><span class="p">)</span>
</span><span id="AIES.step-580"><a href="#AIES.step-580"><span class="linenos">580</span></a>            <span class="n">trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trace_i</span><span class="p">)</span>
</span><span id="AIES.step-581"><a href="#AIES.step-581"><span class="linenos">581</span></a>
</span><span id="AIES.step-582"><a href="#AIES.step-582"><span class="linenos">582</span></a>        <span class="k">return</span> <span class="n">lp</span><span class="p">,</span> <span class="n">trace</span>
</span></pre></div>


            <div class="docstring"><p>Update mcmc_state and return list of native_state_and_cache.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list[float], list[State]</strong>: List of logprobs and list of native state and cache dictionary.</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#AffineInvariantMCMC">AffineInvariantMCMC</a></dt>
                                <dd id="AIES.nsteps" class="variable"><a href="#AffineInvariantMCMC.nsteps">nsteps</a></dd>
                <dd id="AIES.mcmc_state" class="variable"><a href="#AffineInvariantMCMC.mcmc_state">mcmc_state</a></dd>
                <dd id="AIES.accept_rate" class="variable"><a href="#AffineInvariantMCMC.accept_rate">accept_rate</a></dd>
                <dd id="AIES.dim" class="variable"><a href="#AffineInvariantMCMC.dim">dim</a></dd>
                <dd id="AIES.logprob" class="function"><a href="#AffineInvariantMCMC.logprob">logprob</a></dd>
                <dd id="AIES.fit" class="function"><a href="#AffineInvariantMCMC.fit">fit</a></dd>

            </div>
            <div><dt><a href="#MCMC">MCMC</a></dt>
                                <dd id="AIES.nsamples" class="variable"><a href="#MCMC.nsamples">nsamples</a></dd>
                <dd id="AIES.burn" class="variable"><a href="#MCMC.burn">burn</a></dd>
                <dd id="AIES.thin" class="variable"><a href="#MCMC.thin">thin</a></dd>
                <dd id="AIES.mcmc_iteration" class="variable"><a href="#MCMC.mcmc_iteration">mcmc_iteration</a></dd>
                <dd id="AIES.logprob_history" class="variable"><a href="#MCMC.logprob_history">logprob_history</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ParallelAIES">
                            <input id="ParallelAIES-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ParallelAIES</span><wbr>(<span class="base"><a href="#AffineInvariantMCMC">AffineInvariantMCMC</a></span>):

                <label class="view-source-button" for="ParallelAIES-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ParallelAIES"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ParallelAIES-595"><a href="#ParallelAIES-595"><span class="linenos">595</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ParallelAIES</span><span class="p">(</span><span class="n">AffineInvariantMCMC</span><span class="p">):</span>
</span><span id="ParallelAIES-596"><a href="#ParallelAIES-596"><span class="linenos">596</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Parallel Affine Invariant MCMC (or Parallel AIES).</span>
</span><span id="ParallelAIES-597"><a href="#ParallelAIES-597"><span class="linenos">597</span></a>
</span><span id="ParallelAIES-598"><a href="#ParallelAIES-598"><span class="linenos">598</span></a><span class="sd">    References</span>
</span><span id="ParallelAIES-599"><a href="#ParallelAIES-599"><span class="linenos">599</span></a><span class="sd">    ----------</span>
</span><span id="ParallelAIES-600"><a href="#ParallelAIES-600"><span class="linenos">600</span></a><span class="sd">    - [emcee: The MCMC Hammer](https://arxiv.org/pdf/1202.3665)</span>
</span><span id="ParallelAIES-601"><a href="#ParallelAIES-601"><span class="linenos">601</span></a><span class="sd">    - [Ensemble Samplers with Affine Invariance](https://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-s.pdf)</span>
</span><span id="ParallelAIES-602"><a href="#ParallelAIES-602"><span class="linenos">602</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ParallelAIES-603"><a href="#ParallelAIES-603"><span class="linenos">603</span></a>
</span><span id="ParallelAIES-604"><a href="#ParallelAIES-604"><span class="linenos">604</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ParallelAIES-605"><a href="#ParallelAIES-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ParallelAIES-606"><a href="#ParallelAIES-606"><span class="linenos">606</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="ParallelAIES-607"><a href="#ParallelAIES-607"><span class="linenos">607</span></a>        <span class="n">executor</span><span class="p">:</span> <span class="n">Executor</span><span class="p">,</span>
</span><span id="ParallelAIES-608"><a href="#ParallelAIES-608"><span class="linenos">608</span></a>        <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="ParallelAIES-609"><a href="#ParallelAIES-609"><span class="linenos">609</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="ParallelAIES-610"><a href="#ParallelAIES-610"><span class="linenos">610</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(),</span>
</span><span id="ParallelAIES-611"><a href="#ParallelAIES-611"><span class="linenos">611</span></a>        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="ParallelAIES-612"><a href="#ParallelAIES-612"><span class="linenos">612</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ParallelAIES-613"><a href="#ParallelAIES-613"><span class="linenos">613</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="ParallelAIES-614"><a href="#ParallelAIES-614"><span class="linenos">614</span></a>    <span class="p">):</span>
</span><span id="ParallelAIES-615"><a href="#ParallelAIES-615"><span class="linenos">615</span></a>        <span class="k">if</span> <span class="n">nwalkers</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">nwalkers</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ParallelAIES-616"><a href="#ParallelAIES-616"><span class="linenos">616</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ParallelAIES-617"><a href="#ParallelAIES-617"><span class="linenos">617</span></a>                <span class="s2">&quot;num_walkers needs to be an even integer greater than 3, &quot;</span>
</span><span id="ParallelAIES-618"><a href="#ParallelAIES-618"><span class="linenos">618</span></a>                <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="n">nwalkers</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="ParallelAIES-619"><a href="#ParallelAIES-619"><span class="linenos">619</span></a>            <span class="p">)</span>
</span><span id="ParallelAIES-620"><a href="#ParallelAIES-620"><span class="linenos">620</span></a>
</span><span id="ParallelAIES-621"><a href="#ParallelAIES-621"><span class="linenos">621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
</span><span id="ParallelAIES-622"><a href="#ParallelAIES-622"><span class="linenos">622</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="ParallelAIES-623"><a href="#ParallelAIES-623"><span class="linenos">623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">nwalkers</span>
</span><span id="ParallelAIES-624"><a href="#ParallelAIES-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="ParallelAIES-625"><a href="#ParallelAIES-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
</span><span id="ParallelAIES-626"><a href="#ParallelAIES-626"><span class="linenos">626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="ParallelAIES-627"><a href="#ParallelAIES-627"><span class="linenos">627</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nwalkers</span>
</span><span id="ParallelAIES-628"><a href="#ParallelAIES-628"><span class="linenos">628</span></a>        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ParallelAIES-629"><a href="#ParallelAIES-629"><span class="linenos">629</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tuning parameter `a` must be larger than 1.&quot;</span><span class="p">)</span>
</span><span id="ParallelAIES-630"><a href="#ParallelAIES-630"><span class="linenos">630</span></a>
</span><span id="ParallelAIES-631"><a href="#ParallelAIES-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="ParallelAIES-632"><a href="#ParallelAIES-632"><span class="linenos">632</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="ParallelAIES-633"><a href="#ParallelAIES-633"><span class="linenos">633</span></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TransformedPredictive</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="n">Predictive</span>
</span><span id="ParallelAIES-634"><a href="#ParallelAIES-634"><span class="linenos">634</span></a>        <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ParallelAIES-635"><a href="#ParallelAIES-635"><span class="linenos">635</span></a>            <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ParallelAIES-636"><a href="#ParallelAIES-636"><span class="linenos">636</span></a>                <span class="n">predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="ParallelAIES-637"><a href="#ParallelAIES-637"><span class="linenos">637</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="ParallelAIES-638"><a href="#ParallelAIES-638"><span class="linenos">638</span></a>                <span class="p">)</span>
</span><span id="ParallelAIES-639"><a href="#ParallelAIES-639"><span class="linenos">639</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="ParallelAIES-640"><a href="#ParallelAIES-640"><span class="linenos">640</span></a>            <span class="p">]</span>
</span><span id="ParallelAIES-641"><a href="#ParallelAIES-641"><span class="linenos">641</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span><span id="ParallelAIES-642"><a href="#ParallelAIES-642"><span class="linenos">642</span></a>
</span><span id="ParallelAIES-643"><a href="#ParallelAIES-643"><span class="linenos">643</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_u</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="ParallelAIES-644"><a href="#ParallelAIES-644"><span class="linenos">644</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">uniform</span><span class="p">()</span>
</span><span id="ParallelAIES-645"><a href="#ParallelAIES-645"><span class="linenos">645</span></a>
</span><span id="ParallelAIES-646"><a href="#ParallelAIES-646"><span class="linenos">646</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="ParallelAIES-647"><a href="#ParallelAIES-647"><span class="linenos">647</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="ParallelAIES-648"><a href="#ParallelAIES-648"><span class="linenos">648</span></a>
</span><span id="ParallelAIES-649"><a href="#ParallelAIES-649"><span class="linenos">649</span></a><span class="sd">        Returns</span>
</span><span id="ParallelAIES-650"><a href="#ParallelAIES-650"><span class="linenos">650</span></a><span class="sd">        -------</span>
</span><span id="ParallelAIES-651"><a href="#ParallelAIES-651"><span class="linenos">651</span></a><span class="sd">        list[float], list[State]</span>
</span><span id="ParallelAIES-652"><a href="#ParallelAIES-652"><span class="linenos">652</span></a><span class="sd">            Tuple in which the first element is a list of logprobs, and the</span>
</span><span id="ParallelAIES-653"><a href="#ParallelAIES-653"><span class="linenos">653</span></a><span class="sd">            second element is a list of traces (i.e., native state and cache</span>
</span><span id="ParallelAIES-654"><a href="#ParallelAIES-654"><span class="linenos">654</span></a><span class="sd">            dictionary).</span>
</span><span id="ParallelAIES-655"><a href="#ParallelAIES-655"><span class="linenos">655</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ParallelAIES-656"><a href="#ParallelAIES-656"><span class="linenos">656</span></a>        <span class="n">mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="ParallelAIES-657"><a href="#ParallelAIES-657"><span class="linenos">657</span></a>        <span class="n">out_first_half</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="ParallelAIES-658"><a href="#ParallelAIES-658"><span class="linenos">658</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">mid</span><span class="p">))</span>
</span><span id="ParallelAIES-659"><a href="#ParallelAIES-659"><span class="linenos">659</span></a>        <span class="p">)</span>
</span><span id="ParallelAIES-660"><a href="#ParallelAIES-660"><span class="linenos">660</span></a>        <span class="n">out_second_half</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="ParallelAIES-661"><a href="#ParallelAIES-661"><span class="linenos">661</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">))</span>
</span><span id="ParallelAIES-662"><a href="#ParallelAIES-662"><span class="linenos">662</span></a>        <span class="p">)</span>
</span><span id="ParallelAIES-663"><a href="#ParallelAIES-663"><span class="linenos">663</span></a>        <span class="n">logprob_first_half</span><span class="p">,</span> <span class="n">trace_first_half</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">out_first_half</span><span class="p">)</span>
</span><span id="ParallelAIES-664"><a href="#ParallelAIES-664"><span class="linenos">664</span></a>        <span class="n">logprob_second_half</span><span class="p">,</span> <span class="n">trace_second_half</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">out_second_half</span><span class="p">)</span>
</span><span id="ParallelAIES-665"><a href="#ParallelAIES-665"><span class="linenos">665</span></a>
</span><span id="ParallelAIES-666"><a href="#ParallelAIES-666"><span class="linenos">666</span></a>        <span class="n">logprob</span> <span class="o">=</span> <span class="n">logprob_first_half</span> <span class="o">+</span> <span class="n">logprob_second_half</span>
</span><span id="ParallelAIES-667"><a href="#ParallelAIES-667"><span class="linenos">667</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace_first_half</span> <span class="o">+</span> <span class="n">trace_second_half</span>
</span><span id="ParallelAIES-668"><a href="#ParallelAIES-668"><span class="linenos">668</span></a>        <span class="k">return</span> <span class="n">logprob</span><span class="p">,</span> <span class="n">trace</span>
</span><span id="ParallelAIES-669"><a href="#ParallelAIES-669"><span class="linenos">669</span></a>
</span><span id="ParallelAIES-670"><a href="#ParallelAIES-670"><span class="linenos">670</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_draw_walker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">State</span><span class="p">:</span>
</span><span id="ParallelAIES-671"><a href="#ParallelAIES-671"><span class="linenos">671</span></a>        <span class="n">other_walkers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_other_walkers</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="ParallelAIES-672"><a href="#ParallelAIES-672"><span class="linenos">672</span></a>        <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">integers</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">other_walkers</span><span class="p">))</span>
</span><span id="ParallelAIES-673"><a href="#ParallelAIES-673"><span class="linenos">673</span></a>        <span class="k">return</span> <span class="n">other_walkers</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span><span id="ParallelAIES-674"><a href="#ParallelAIES-674"><span class="linenos">674</span></a>
</span><span id="ParallelAIES-675"><a href="#ParallelAIES-675"><span class="linenos">675</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_other_walkers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]:</span>
</span><span id="ParallelAIES-676"><a href="#ParallelAIES-676"><span class="linenos">676</span></a>        <span class="n">mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="ParallelAIES-677"><a href="#ParallelAIES-677"><span class="linenos">677</span></a>        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mid</span><span class="p">:</span>
</span><span id="ParallelAIES-678"><a href="#ParallelAIES-678"><span class="linenos">678</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[</span><span class="n">mid</span><span class="p">:]</span>
</span><span id="ParallelAIES-679"><a href="#ParallelAIES-679"><span class="linenos">679</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="ParallelAIES-680"><a href="#ParallelAIES-680"><span class="linenos">680</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcmc_state</span><span class="p">[:</span><span class="n">mid</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Parallel Affine Invariant MCMC (or Parallel AIES).</p>

<h6 id="references">References</h6>

<ul>
<li><a href="https://arxiv.org/pdf/1202.3665">emcee: The MCMC Hammer</a></li>
<li><a href="https://msp.org/camcos/2010/5-1/camcos-v5-n1-p04-s.pdf">Ensemble Samplers with Affine Invariance</a></li>
</ul>
</div>


                            <div id="ParallelAIES.__init__" class="classattr">
                                        <input id="ParallelAIES.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ParallelAIES</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n"><a href="context.html#Context">arianna.ppl.context.Context</a></span><span class="p">,</span> <span class="o">~</span><span class="n">P</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span>,</span><span class="param">	<span class="n">executor</span><span class="p">:</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">_base</span><span class="o">.</span><span class="n">Executor</span>,</span><span class="param">	<span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">rng</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">_generator</span><span class="o">.</span><span class="n">Generator</span> <span class="o">=</span> <span class="n">Generator</span><span class="p">(</span><span class="n">PCG64</span><span class="p">)</span> <span class="n">at</span> <span class="mh">0x1058611C0</span>,</span><span class="param">	<span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span>,</span><span class="param">	<span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">model_data</span></span>)</span>

                <label class="view-source-button" for="ParallelAIES.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ParallelAIES.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ParallelAIES.__init__-604"><a href="#ParallelAIES.__init__-604"><span class="linenos">604</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ParallelAIES.__init__-605"><a href="#ParallelAIES.__init__-605"><span class="linenos">605</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-606"><a href="#ParallelAIES.__init__-606"><span class="linenos">606</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-607"><a href="#ParallelAIES.__init__-607"><span class="linenos">607</span></a>        <span class="n">executor</span><span class="p">:</span> <span class="n">Executor</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-608"><a href="#ParallelAIES.__init__-608"><span class="linenos">608</span></a>        <span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-609"><a href="#ParallelAIES.__init__-609"><span class="linenos">609</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-610"><a href="#ParallelAIES.__init__-610"><span class="linenos">610</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span> <span class="o">=</span> <span class="n">default_rng</span><span class="p">(),</span>
</span><span id="ParallelAIES.__init__-611"><a href="#ParallelAIES.__init__-611"><span class="linenos">611</span></a>        <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-612"><a href="#ParallelAIES.__init__-612"><span class="linenos">612</span></a>        <span class="n">init_state</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-613"><a href="#ParallelAIES.__init__-613"><span class="linenos">613</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="ParallelAIES.__init__-614"><a href="#ParallelAIES.__init__-614"><span class="linenos">614</span></a>    <span class="p">):</span>
</span><span id="ParallelAIES.__init__-615"><a href="#ParallelAIES.__init__-615"><span class="linenos">615</span></a>        <span class="k">if</span> <span class="n">nwalkers</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">nwalkers</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ParallelAIES.__init__-616"><a href="#ParallelAIES.__init__-616"><span class="linenos">616</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ParallelAIES.__init__-617"><a href="#ParallelAIES.__init__-617"><span class="linenos">617</span></a>                <span class="s2">&quot;num_walkers needs to be an even integer greater than 3, &quot;</span>
</span><span id="ParallelAIES.__init__-618"><a href="#ParallelAIES.__init__-618"><span class="linenos">618</span></a>                <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="n">nwalkers</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span id="ParallelAIES.__init__-619"><a href="#ParallelAIES.__init__-619"><span class="linenos">619</span></a>            <span class="p">)</span>
</span><span id="ParallelAIES.__init__-620"><a href="#ParallelAIES.__init__-620"><span class="linenos">620</span></a>
</span><span id="ParallelAIES.__init__-621"><a href="#ParallelAIES.__init__-621"><span class="linenos">621</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">executor</span>
</span><span id="ParallelAIES.__init__-622"><a href="#ParallelAIES.__init__-622"><span class="linenos">622</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">:</span> <span class="n">Model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="ParallelAIES.__init__-623"><a href="#ParallelAIES.__init__-623"><span class="linenos">623</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">nwalkers</span>
</span><span id="ParallelAIES.__init__-624"><a href="#ParallelAIES.__init__-624"><span class="linenos">624</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="ParallelAIES.__init__-625"><a href="#ParallelAIES.__init__-625"><span class="linenos">625</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span>
</span><span id="ParallelAIES.__init__-626"><a href="#ParallelAIES.__init__-626"><span class="linenos">626</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rngs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="ParallelAIES.__init__-627"><a href="#ParallelAIES.__init__-627"><span class="linenos">627</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">accept</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">nwalkers</span>
</span><span id="ParallelAIES.__init__-628"><a href="#ParallelAIES.__init__-628"><span class="linenos">628</span></a>        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="ParallelAIES.__init__-629"><a href="#ParallelAIES.__init__-629"><span class="linenos">629</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Tuning parameter `a` must be larger than 1.&quot;</span><span class="p">)</span>
</span><span id="ParallelAIES.__init__-630"><a href="#ParallelAIES.__init__-630"><span class="linenos">630</span></a>
</span><span id="ParallelAIES.__init__-631"><a href="#ParallelAIES.__init__-631"><span class="linenos">631</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a</span>
</span><span id="ParallelAIES.__init__-632"><a href="#ParallelAIES.__init__-632"><span class="linenos">632</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="ParallelAIES.__init__-633"><a href="#ParallelAIES.__init__-633"><span class="linenos">633</span></a>        <span class="n">predictive</span> <span class="o">=</span> <span class="n">TransformedPredictive</span> <span class="k">if</span> <span class="n">transform</span> <span class="k">else</span> <span class="n">Predictive</span>
</span><span id="ParallelAIES.__init__-634"><a href="#ParallelAIES.__init__-634"><span class="linenos">634</span></a>        <span class="k">if</span> <span class="n">init_state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ParallelAIES.__init__-635"><a href="#ParallelAIES.__init__-635"><span class="linenos">635</span></a>            <span class="n">init_state</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ParallelAIES.__init__-636"><a href="#ParallelAIES.__init__-636"><span class="linenos">636</span></a>                <span class="n">predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="ParallelAIES.__init__-637"><a href="#ParallelAIES.__init__-637"><span class="linenos">637</span></a>                    <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">model_data</span>
</span><span id="ParallelAIES.__init__-638"><a href="#ParallelAIES.__init__-638"><span class="linenos">638</span></a>                <span class="p">)</span>
</span><span id="ParallelAIES.__init__-639"><a href="#ParallelAIES.__init__-639"><span class="linenos">639</span></a>                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">)</span>
</span><span id="ParallelAIES.__init__-640"><a href="#ParallelAIES.__init__-640"><span class="linenos">640</span></a>            <span class="p">]</span>
</span><span id="ParallelAIES.__init__-641"><a href="#ParallelAIES.__init__-641"><span class="linenos">641</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">init_state</span>
</span></pre></div>


    

                            </div>
                            <div id="ParallelAIES.executor" class="classattr">
                                <div class="attr variable">
            <span class="name">executor</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.executor"></a>
    
    

                            </div>
                            <div id="ParallelAIES.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span><span class="annotation">: Callable[Concatenate[<a href="context.html#Context">arianna.ppl.context.Context</a>, ~P], NoneType]</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.model"></a>
    
    

                            </div>
                            <div id="ParallelAIES.nwalkers" class="classattr">
                                <div class="attr variable">
            <span class="name">nwalkers</span><span class="annotation">: int</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.nwalkers"></a>
    
    

                            </div>
                            <div id="ParallelAIES.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span><span class="annotation">: bool</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.transform"></a>
    
    

                            </div>
                            <div id="ParallelAIES.rng" class="classattr">
                                <div class="attr variable">
            <span class="name">rng</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.rng"></a>
    
    

                            </div>
                            <div id="ParallelAIES.rngs" class="classattr">
                                <div class="attr variable">
            <span class="name">rngs</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.rngs"></a>
    
    

                            </div>
                            <div id="ParallelAIES.accept" class="classattr">
                                <div class="attr variable">
            <span class="name">accept</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.accept"></a>
    
    

                            </div>
                            <div id="ParallelAIES.a" class="classattr">
                                <div class="attr variable">
            <span class="name">a</span><span class="annotation">: float</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.a"></a>
    
    

                            </div>
                            <div id="ParallelAIES.model_data" class="classattr">
                                <div class="attr variable">
            <span class="name">model_data</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.model_data"></a>
    
    

                            </div>
                            <div id="ParallelAIES.init_state" class="classattr">
                                <div class="attr variable">
            <span class="name">init_state</span>

        
    </div>
    <a class="headerlink" href="#ParallelAIES.init_state"></a>
    
    

                            </div>
                            <div id="ParallelAIES.step" class="classattr">
                                        <input id="ParallelAIES.step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span>:</span></span>

                <label class="view-source-button" for="ParallelAIES.step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ParallelAIES.step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ParallelAIES.step-646"><a href="#ParallelAIES.step-646"><span class="linenos">646</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]:</span>
</span><span id="ParallelAIES.step-647"><a href="#ParallelAIES.step-647"><span class="linenos">647</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mcmc_state and return list of native_state_and_cache.</span>
</span><span id="ParallelAIES.step-648"><a href="#ParallelAIES.step-648"><span class="linenos">648</span></a>
</span><span id="ParallelAIES.step-649"><a href="#ParallelAIES.step-649"><span class="linenos">649</span></a><span class="sd">        Returns</span>
</span><span id="ParallelAIES.step-650"><a href="#ParallelAIES.step-650"><span class="linenos">650</span></a><span class="sd">        -------</span>
</span><span id="ParallelAIES.step-651"><a href="#ParallelAIES.step-651"><span class="linenos">651</span></a><span class="sd">        list[float], list[State]</span>
</span><span id="ParallelAIES.step-652"><a href="#ParallelAIES.step-652"><span class="linenos">652</span></a><span class="sd">            Tuple in which the first element is a list of logprobs, and the</span>
</span><span id="ParallelAIES.step-653"><a href="#ParallelAIES.step-653"><span class="linenos">653</span></a><span class="sd">            second element is a list of traces (i.e., native state and cache</span>
</span><span id="ParallelAIES.step-654"><a href="#ParallelAIES.step-654"><span class="linenos">654</span></a><span class="sd">            dictionary).</span>
</span><span id="ParallelAIES.step-655"><a href="#ParallelAIES.step-655"><span class="linenos">655</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ParallelAIES.step-656"><a href="#ParallelAIES.step-656"><span class="linenos">656</span></a>        <span class="n">mid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span> <span class="o">//</span> <span class="mi">2</span>
</span><span id="ParallelAIES.step-657"><a href="#ParallelAIES.step-657"><span class="linenos">657</span></a>        <span class="n">out_first_half</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="ParallelAIES.step-658"><a href="#ParallelAIES.step-658"><span class="linenos">658</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">mid</span><span class="p">))</span>
</span><span id="ParallelAIES.step-659"><a href="#ParallelAIES.step-659"><span class="linenos">659</span></a>        <span class="p">)</span>
</span><span id="ParallelAIES.step-660"><a href="#ParallelAIES.step-660"><span class="linenos">660</span></a>        <span class="n">out_second_half</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="ParallelAIES.step-661"><a href="#ParallelAIES.step-661"><span class="linenos">661</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_walker</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nwalkers</span><span class="p">))</span>
</span><span id="ParallelAIES.step-662"><a href="#ParallelAIES.step-662"><span class="linenos">662</span></a>        <span class="p">)</span>
</span><span id="ParallelAIES.step-663"><a href="#ParallelAIES.step-663"><span class="linenos">663</span></a>        <span class="n">logprob_first_half</span><span class="p">,</span> <span class="n">trace_first_half</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">out_first_half</span><span class="p">)</span>
</span><span id="ParallelAIES.step-664"><a href="#ParallelAIES.step-664"><span class="linenos">664</span></a>        <span class="n">logprob_second_half</span><span class="p">,</span> <span class="n">trace_second_half</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">out_second_half</span><span class="p">)</span>
</span><span id="ParallelAIES.step-665"><a href="#ParallelAIES.step-665"><span class="linenos">665</span></a>
</span><span id="ParallelAIES.step-666"><a href="#ParallelAIES.step-666"><span class="linenos">666</span></a>        <span class="n">logprob</span> <span class="o">=</span> <span class="n">logprob_first_half</span> <span class="o">+</span> <span class="n">logprob_second_half</span>
</span><span id="ParallelAIES.step-667"><a href="#ParallelAIES.step-667"><span class="linenos">667</span></a>        <span class="n">trace</span> <span class="o">=</span> <span class="n">trace_first_half</span> <span class="o">+</span> <span class="n">trace_second_half</span>
</span><span id="ParallelAIES.step-668"><a href="#ParallelAIES.step-668"><span class="linenos">668</span></a>        <span class="k">return</span> <span class="n">logprob</span><span class="p">,</span> <span class="n">trace</span>
</span></pre></div>


            <div class="docstring"><p>Update mcmc_state and return list of native_state_and_cache.</p>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>list[float], list[State]</strong>: Tuple in which the first element is a list of logprobs, and the
second element is a list of traces (i.e., native state and cache
dictionary).</li>
</ul>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#AffineInvariantMCMC">AffineInvariantMCMC</a></dt>
                                <dd id="ParallelAIES.nsteps" class="variable"><a href="#AffineInvariantMCMC.nsteps">nsteps</a></dd>
                <dd id="ParallelAIES.mcmc_state" class="variable"><a href="#AffineInvariantMCMC.mcmc_state">mcmc_state</a></dd>
                <dd id="ParallelAIES.accept_rate" class="variable"><a href="#AffineInvariantMCMC.accept_rate">accept_rate</a></dd>
                <dd id="ParallelAIES.dim" class="variable"><a href="#AffineInvariantMCMC.dim">dim</a></dd>
                <dd id="ParallelAIES.logprob" class="function"><a href="#AffineInvariantMCMC.logprob">logprob</a></dd>
                <dd id="ParallelAIES.fit" class="function"><a href="#AffineInvariantMCMC.fit">fit</a></dd>

            </div>
            <div><dt><a href="#MCMC">MCMC</a></dt>
                                <dd id="ParallelAIES.nsamples" class="variable"><a href="#MCMC.nsamples">nsamples</a></dd>
                <dd id="ParallelAIES.burn" class="variable"><a href="#MCMC.burn">burn</a></dd>
                <dd id="ParallelAIES.thin" class="variable"><a href="#MCMC.thin">thin</a></dd>
                <dd id="ParallelAIES.mcmc_iteration" class="variable"><a href="#MCMC.mcmc_iteration">mcmc_iteration</a></dd>
                <dd id="ParallelAIES.logprob_history" class="variable"><a href="#MCMC.logprob_history">logprob_history</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ImportanceSampling">
                            <input id="ImportanceSampling-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ImportanceSampling</span><wbr>(<span class="base"><a href="#InferenceEngine">InferenceEngine</a></span>):

                <label class="view-source-button" for="ImportanceSampling-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImportanceSampling"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImportanceSampling-683"><a href="#ImportanceSampling-683"><span class="linenos">683</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ImportanceSampling</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="ImportanceSampling-684"><a href="#ImportanceSampling-684"><span class="linenos">684</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Importance Sampling.&quot;&quot;&quot;</span>
</span><span id="ImportanceSampling-685"><a href="#ImportanceSampling-685"><span class="linenos">685</span></a>
</span><span id="ImportanceSampling-686"><a href="#ImportanceSampling-686"><span class="linenos">686</span></a>    <span class="n">particles</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]</span>
</span><span id="ImportanceSampling-687"><a href="#ImportanceSampling-687"><span class="linenos">687</span></a>
</span><span id="ImportanceSampling-688"><a href="#ImportanceSampling-688"><span class="linenos">688</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ImportanceSampling-689"><a href="#ImportanceSampling-689"><span class="linenos">689</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ImportanceSampling-690"><a href="#ImportanceSampling-690"><span class="linenos">690</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="ImportanceSampling-691"><a href="#ImportanceSampling-691"><span class="linenos">691</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImportanceSampling-692"><a href="#ImportanceSampling-692"><span class="linenos">692</span></a>        <span class="n">particles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImportanceSampling-693"><a href="#ImportanceSampling-693"><span class="linenos">693</span></a>        <span class="n">nparticles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImportanceSampling-694"><a href="#ImportanceSampling-694"><span class="linenos">694</span></a>        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="ImportanceSampling-695"><a href="#ImportanceSampling-695"><span class="linenos">695</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="ImportanceSampling-696"><a href="#ImportanceSampling-696"><span class="linenos">696</span></a>    <span class="p">):</span>
</span><span id="ImportanceSampling-697"><a href="#ImportanceSampling-697"><span class="linenos">697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="ImportanceSampling-698"><a href="#ImportanceSampling-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="ImportanceSampling-699"><a href="#ImportanceSampling-699"><span class="linenos">699</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
</span><span id="ImportanceSampling-700"><a href="#ImportanceSampling-700"><span class="linenos">700</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="ImportanceSampling-701"><a href="#ImportanceSampling-701"><span class="linenos">701</span></a>        <span class="k">match</span> <span class="n">nparticles</span><span class="p">,</span> <span class="n">particles</span><span class="p">:</span>
</span><span id="ImportanceSampling-702"><a href="#ImportanceSampling-702"><span class="linenos">702</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ImportanceSampling-703"><a href="#ImportanceSampling-703"><span class="linenos">703</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ImportanceSampling-704"><a href="#ImportanceSampling-704"><span class="linenos">704</span></a>                    <span class="s2">&quot;nparticles and particles cannot both be None!&quot;</span>
</span><span id="ImportanceSampling-705"><a href="#ImportanceSampling-705"><span class="linenos">705</span></a>                <span class="p">)</span>
</span><span id="ImportanceSampling-706"><a href="#ImportanceSampling-706"><span class="linenos">706</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ImportanceSampling-707"><a href="#ImportanceSampling-707"><span class="linenos">707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="n">nparticles</span>
</span><span id="ImportanceSampling-708"><a href="#ImportanceSampling-708"><span class="linenos">708</span></a>                <span class="n">logprobs_and_samples</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ImportanceSampling-709"><a href="#ImportanceSampling-709"><span class="linenos">709</span></a>                    <span class="n">LogprobAndPriorSample</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="ImportanceSampling-710"><a href="#ImportanceSampling-710"><span class="linenos">710</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="ImportanceSampling-711"><a href="#ImportanceSampling-711"><span class="linenos">711</span></a>                    <span class="p">)</span>
</span><span id="ImportanceSampling-712"><a href="#ImportanceSampling-712"><span class="linenos">712</span></a>                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">)</span>
</span><span id="ImportanceSampling-713"><a href="#ImportanceSampling-713"><span class="linenos">713</span></a>                <span class="p">]</span>
</span><span id="ImportanceSampling-714"><a href="#ImportanceSampling-714"><span class="linenos">714</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">logprobs_and_samples</span><span class="p">)</span>
</span><span id="ImportanceSampling-715"><a href="#ImportanceSampling-715"><span class="linenos">715</span></a>            <span class="k">case</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span> <span class="k">_</span><span class="p">:</span>
</span><span id="ImportanceSampling-716"><a href="#ImportanceSampling-716"><span class="linenos">716</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span>
</span><span id="ImportanceSampling-717"><a href="#ImportanceSampling-717"><span class="linenos">717</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
</span><span id="ImportanceSampling-718"><a href="#ImportanceSampling-718"><span class="linenos">718</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ImportanceSampling-719"><a href="#ImportanceSampling-719"><span class="linenos">719</span></a>                    <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="ImportanceSampling-720"><a href="#ImportanceSampling-720"><span class="linenos">720</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">particle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="ImportanceSampling-721"><a href="#ImportanceSampling-721"><span class="linenos">721</span></a>                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImportanceSampling-722"><a href="#ImportanceSampling-722"><span class="linenos">722</span></a>                    <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>
</span><span id="ImportanceSampling-723"><a href="#ImportanceSampling-723"><span class="linenos">723</span></a>                <span class="p">]</span>
</span><span id="ImportanceSampling-724"><a href="#ImportanceSampling-724"><span class="linenos">724</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="ImportanceSampling-725"><a href="#ImportanceSampling-725"><span class="linenos">725</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ImportanceSampling-726"><a href="#ImportanceSampling-726"><span class="linenos">726</span></a>                    <span class="s2">&quot;nparticles and particles cannot both be specified!&quot;</span>
</span><span id="ImportanceSampling-727"><a href="#ImportanceSampling-727"><span class="linenos">727</span></a>                <span class="p">)</span>
</span><span id="ImportanceSampling-728"><a href="#ImportanceSampling-728"><span class="linenos">728</span></a>
</span><span id="ImportanceSampling-729"><a href="#ImportanceSampling-729"><span class="linenos">729</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_weights</span> <span class="o">=</span> <span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">)</span>
</span><span id="ImportanceSampling-730"><a href="#ImportanceSampling-730"><span class="linenos">730</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">)</span>
</span><span id="ImportanceSampling-731"><a href="#ImportanceSampling-731"><span class="linenos">731</span></a>        <span class="c1"># self.ess = ess_kish(self.weights)</span>
</span><span id="ImportanceSampling-732"><a href="#ImportanceSampling-732"><span class="linenos">732</span></a>
</span><span id="ImportanceSampling-733"><a href="#ImportanceSampling-733"><span class="linenos">733</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="ImportanceSampling-734"><a href="#ImportanceSampling-734"><span class="linenos">734</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample.&quot;&quot;&quot;</span>
</span><span id="ImportanceSampling-735"><a href="#ImportanceSampling-735"><span class="linenos">735</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="ImportanceSampling-736"><a href="#ImportanceSampling-736"><span class="linenos">736</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Importance Sampling.</p>
</div>


                            <div id="ImportanceSampling.__init__" class="classattr">
                                        <input id="ImportanceSampling.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ImportanceSampling</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n"><a href="context.html#Context">arianna.ppl.context.Context</a></span><span class="p">,</span> <span class="o">~</span><span class="n">P</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span>,</span><span class="param">	<span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">_generator</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">particles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span> <span class="o">|</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">nparticles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="o">**</span><span class="n">model_data</span></span>)</span>

                <label class="view-source-button" for="ImportanceSampling.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImportanceSampling.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImportanceSampling.__init__-688"><a href="#ImportanceSampling.__init__-688"><span class="linenos">688</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="ImportanceSampling.__init__-689"><a href="#ImportanceSampling.__init__-689"><span class="linenos">689</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ImportanceSampling.__init__-690"><a href="#ImportanceSampling.__init__-690"><span class="linenos">690</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="ImportanceSampling.__init__-691"><a href="#ImportanceSampling.__init__-691"><span class="linenos">691</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImportanceSampling.__init__-692"><a href="#ImportanceSampling.__init__-692"><span class="linenos">692</span></a>        <span class="n">particles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">State</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImportanceSampling.__init__-693"><a href="#ImportanceSampling.__init__-693"><span class="linenos">693</span></a>        <span class="n">nparticles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="ImportanceSampling.__init__-694"><a href="#ImportanceSampling.__init__-694"><span class="linenos">694</span></a>        <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
</span><span id="ImportanceSampling.__init__-695"><a href="#ImportanceSampling.__init__-695"><span class="linenos">695</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="ImportanceSampling.__init__-696"><a href="#ImportanceSampling.__init__-696"><span class="linenos">696</span></a>    <span class="p">):</span>
</span><span id="ImportanceSampling.__init__-697"><a href="#ImportanceSampling.__init__-697"><span class="linenos">697</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="ImportanceSampling.__init__-698"><a href="#ImportanceSampling.__init__-698"><span class="linenos">698</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="ImportanceSampling.__init__-699"><a href="#ImportanceSampling.__init__-699"><span class="linenos">699</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
</span><span id="ImportanceSampling.__init__-700"><a href="#ImportanceSampling.__init__-700"><span class="linenos">700</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="ImportanceSampling.__init__-701"><a href="#ImportanceSampling.__init__-701"><span class="linenos">701</span></a>        <span class="k">match</span> <span class="n">nparticles</span><span class="p">,</span> <span class="n">particles</span><span class="p">:</span>
</span><span id="ImportanceSampling.__init__-702"><a href="#ImportanceSampling.__init__-702"><span class="linenos">702</span></a>            <span class="k">case</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ImportanceSampling.__init__-703"><a href="#ImportanceSampling.__init__-703"><span class="linenos">703</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ImportanceSampling.__init__-704"><a href="#ImportanceSampling.__init__-704"><span class="linenos">704</span></a>                    <span class="s2">&quot;nparticles and particles cannot both be None!&quot;</span>
</span><span id="ImportanceSampling.__init__-705"><a href="#ImportanceSampling.__init__-705"><span class="linenos">705</span></a>                <span class="p">)</span>
</span><span id="ImportanceSampling.__init__-706"><a href="#ImportanceSampling.__init__-706"><span class="linenos">706</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">,</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="ImportanceSampling.__init__-707"><a href="#ImportanceSampling.__init__-707"><span class="linenos">707</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="n">nparticles</span>
</span><span id="ImportanceSampling.__init__-708"><a href="#ImportanceSampling.__init__-708"><span class="linenos">708</span></a>                <span class="n">logprobs_and_samples</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ImportanceSampling.__init__-709"><a href="#ImportanceSampling.__init__-709"><span class="linenos">709</span></a>                    <span class="n">LogprobAndPriorSample</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="ImportanceSampling.__init__-710"><a href="#ImportanceSampling.__init__-710"><span class="linenos">710</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="ImportanceSampling.__init__-711"><a href="#ImportanceSampling.__init__-711"><span class="linenos">711</span></a>                    <span class="p">)</span>
</span><span id="ImportanceSampling.__init__-712"><a href="#ImportanceSampling.__init__-712"><span class="linenos">712</span></a>                    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">)</span>
</span><span id="ImportanceSampling.__init__-713"><a href="#ImportanceSampling.__init__-713"><span class="linenos">713</span></a>                <span class="p">]</span>
</span><span id="ImportanceSampling.__init__-714"><a href="#ImportanceSampling.__init__-714"><span class="linenos">714</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">logprobs_and_samples</span><span class="p">)</span>
</span><span id="ImportanceSampling.__init__-715"><a href="#ImportanceSampling.__init__-715"><span class="linenos">715</span></a>            <span class="k">case</span><span class="w"> </span><span class="kc">None</span><span class="p">,</span> <span class="k">_</span><span class="p">:</span>
</span><span id="ImportanceSampling.__init__-716"><a href="#ImportanceSampling.__init__-716"><span class="linenos">716</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">particles</span> <span class="o">=</span> <span class="n">particles</span>
</span><span id="ImportanceSampling.__init__-717"><a href="#ImportanceSampling.__init__-717"><span class="linenos">717</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
</span><span id="ImportanceSampling.__init__-718"><a href="#ImportanceSampling.__init__-718"><span class="linenos">718</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="ImportanceSampling.__init__-719"><a href="#ImportanceSampling.__init__-719"><span class="linenos">719</span></a>                    <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="ImportanceSampling.__init__-720"><a href="#ImportanceSampling.__init__-720"><span class="linenos">720</span></a>                        <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">particle</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="ImportanceSampling.__init__-721"><a href="#ImportanceSampling.__init__-721"><span class="linenos">721</span></a>                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="ImportanceSampling.__init__-722"><a href="#ImportanceSampling.__init__-722"><span class="linenos">722</span></a>                    <span class="k">for</span> <span class="n">particle</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">)</span>
</span><span id="ImportanceSampling.__init__-723"><a href="#ImportanceSampling.__init__-723"><span class="linenos">723</span></a>                <span class="p">]</span>
</span><span id="ImportanceSampling.__init__-724"><a href="#ImportanceSampling.__init__-724"><span class="linenos">724</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="ImportanceSampling.__init__-725"><a href="#ImportanceSampling.__init__-725"><span class="linenos">725</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="ImportanceSampling.__init__-726"><a href="#ImportanceSampling.__init__-726"><span class="linenos">726</span></a>                    <span class="s2">&quot;nparticles and particles cannot both be specified!&quot;</span>
</span><span id="ImportanceSampling.__init__-727"><a href="#ImportanceSampling.__init__-727"><span class="linenos">727</span></a>                <span class="p">)</span>
</span><span id="ImportanceSampling.__init__-728"><a href="#ImportanceSampling.__init__-728"><span class="linenos">728</span></a>
</span><span id="ImportanceSampling.__init__-729"><a href="#ImportanceSampling.__init__-729"><span class="linenos">729</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log_weights</span> <span class="o">=</span> <span class="n">log_softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">)</span>
</span><span id="ImportanceSampling.__init__-730"><a href="#ImportanceSampling.__init__-730"><span class="linenos">730</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">softmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logprobs</span><span class="p">)</span>
</span><span id="ImportanceSampling.__init__-731"><a href="#ImportanceSampling.__init__-731"><span class="linenos">731</span></a>        <span class="c1"># self.ess = ess_kish(self.weights)</span>
</span></pre></div>


    

                            </div>
                            <div id="ImportanceSampling.particles" class="classattr">
                                <div class="attr variable">
            <span class="name">particles</span><span class="annotation">: list[dict[str, float | numpy.ndarray]]</span>

        
    </div>
    <a class="headerlink" href="#ImportanceSampling.particles"></a>
    
    

                            </div>
                            <div id="ImportanceSampling.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span>

        
    </div>
    <a class="headerlink" href="#ImportanceSampling.model"></a>
    
    

                            </div>
                            <div id="ImportanceSampling.model_data" class="classattr">
                                <div class="attr variable">
            <span class="name">model_data</span>

        
    </div>
    <a class="headerlink" href="#ImportanceSampling.model_data"></a>
    
    

                            </div>
                            <div id="ImportanceSampling.temperature" class="classattr">
                                <div class="attr variable">
            <span class="name">temperature</span>

        
    </div>
    <a class="headerlink" href="#ImportanceSampling.temperature"></a>
    
    

                            </div>
                            <div id="ImportanceSampling.rng" class="classattr">
                                <div class="attr variable">
            <span class="name">rng</span>

        
    </div>
    <a class="headerlink" href="#ImportanceSampling.rng"></a>
    
    

                            </div>
                            <div id="ImportanceSampling.log_weights" class="classattr">
                                <div class="attr variable">
            <span class="name">log_weights</span>

        
    </div>
    <a class="headerlink" href="#ImportanceSampling.log_weights"></a>
    
    

                            </div>
                            <div id="ImportanceSampling.weights" class="classattr">
                                <div class="attr variable">
            <span class="name">weights</span>

        
    </div>
    <a class="headerlink" href="#ImportanceSampling.weights"></a>
    
    

                            </div>
                            <div id="ImportanceSampling.fit" class="classattr">
                                        <input id="ImportanceSampling.fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span></span><span class="return-annotation">) -> <span class="n"><a href="#Chain">Chain</a></span>:</span></span>

                <label class="view-source-button" for="ImportanceSampling.fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ImportanceSampling.fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ImportanceSampling.fit-733"><a href="#ImportanceSampling.fit-733"><span class="linenos">733</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Chain</span><span class="p">:</span>
</span><span id="ImportanceSampling.fit-734"><a href="#ImportanceSampling.fit-734"><span class="linenos">734</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample.&quot;&quot;&quot;</span>
</span><span id="ImportanceSampling.fit-735"><a href="#ImportanceSampling.fit-735"><span class="linenos">735</span></a>        <span class="n">indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nparticles</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="ImportanceSampling.fit-736"><a href="#ImportanceSampling.fit-736"><span class="linenos">736</span></a>        <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Sample.</p>
</div>


                            </div>
                </section>
                <section id="LaplaceApproximation">
                            <input id="LaplaceApproximation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LaplaceApproximation</span><wbr>(<span class="base"><a href="#InferenceEngine">InferenceEngine</a></span>):

                <label class="view-source-button" for="LaplaceApproximation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceApproximation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceApproximation-739"><a href="#LaplaceApproximation-739"><span class="linenos">739</span></a><span class="k">class</span><span class="w"> </span><span class="nc">LaplaceApproximation</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="LaplaceApproximation-740"><a href="#LaplaceApproximation-740"><span class="linenos">740</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Laplace Approximation of Posterior.&quot;&quot;&quot;</span>
</span><span id="LaplaceApproximation-741"><a href="#LaplaceApproximation-741"><span class="linenos">741</span></a>
</span><span id="LaplaceApproximation-742"><a href="#LaplaceApproximation-742"><span class="linenos">742</span></a>    <span class="n">rng</span><span class="p">:</span> <span class="n">RNG</span>
</span><span id="LaplaceApproximation-743"><a href="#LaplaceApproximation-743"><span class="linenos">743</span></a>
</span><span id="LaplaceApproximation-744"><a href="#LaplaceApproximation-744"><span class="linenos">744</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LaplaceApproximation-745"><a href="#LaplaceApproximation-745"><span class="linenos">745</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LaplaceApproximation-746"><a href="#LaplaceApproximation-746"><span class="linenos">746</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="LaplaceApproximation-747"><a href="#LaplaceApproximation-747"><span class="linenos">747</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LaplaceApproximation-748"><a href="#LaplaceApproximation-748"><span class="linenos">748</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LaplaceApproximation-749"><a href="#LaplaceApproximation-749"><span class="linenos">749</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="LaplaceApproximation-750"><a href="#LaplaceApproximation-750"><span class="linenos">750</span></a>    <span class="p">):</span>
</span><span id="LaplaceApproximation-751"><a href="#LaplaceApproximation-751"><span class="linenos">751</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="LaplaceApproximation-752"><a href="#LaplaceApproximation-752"><span class="linenos">752</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="LaplaceApproximation-753"><a href="#LaplaceApproximation-753"><span class="linenos">753</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="LaplaceApproximation-754"><a href="#LaplaceApproximation-754"><span class="linenos">754</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="LaplaceApproximation-755"><a href="#LaplaceApproximation-755"><span class="linenos">755</span></a>
</span><span id="LaplaceApproximation-756"><a href="#LaplaceApproximation-756"><span class="linenos">756</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="LaplaceApproximation-757"><a href="#LaplaceApproximation-757"><span class="linenos">757</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">TransformedPredictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation-758"><a href="#LaplaceApproximation-758"><span class="linenos">758</span></a>                <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="LaplaceApproximation-759"><a href="#LaplaceApproximation-759"><span class="linenos">759</span></a>            <span class="p">)</span>
</span><span id="LaplaceApproximation-760"><a href="#LaplaceApproximation-760"><span class="linenos">760</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LaplaceApproximation-761"><a href="#LaplaceApproximation-761"><span class="linenos">761</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation-762"><a href="#LaplaceApproximation-762"><span class="linenos">762</span></a>                <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="LaplaceApproximation-763"><a href="#LaplaceApproximation-763"><span class="linenos">763</span></a>            <span class="p">)</span>
</span><span id="LaplaceApproximation-764"><a href="#LaplaceApproximation-764"><span class="linenos">764</span></a>
</span><span id="LaplaceApproximation-765"><a href="#LaplaceApproximation-765"><span class="linenos">765</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span> <span class="o">=</span> <span class="n">Shaper</span><span class="o">.</span><span class="n">from_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="LaplaceApproximation-766"><a href="#LaplaceApproximation-766"><span class="linenos">766</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_vec_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="LaplaceApproximation-767"><a href="#LaplaceApproximation-767"><span class="linenos">767</span></a>
</span><span id="LaplaceApproximation-768"><a href="#LaplaceApproximation-768"><span class="linenos">768</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="LaplaceApproximation-769"><a href="#LaplaceApproximation-769"><span class="linenos">769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="LaplaceApproximation-770"><a href="#LaplaceApproximation-770"><span class="linenos">770</span></a>
</span><span id="LaplaceApproximation-771"><a href="#LaplaceApproximation-771"><span class="linenos">771</span></a><span class="sd">        Parameters</span>
</span><span id="LaplaceApproximation-772"><a href="#LaplaceApproximation-772"><span class="linenos">772</span></a><span class="sd">        ----------</span>
</span><span id="LaplaceApproximation-773"><a href="#LaplaceApproximation-773"><span class="linenos">773</span></a><span class="sd">        state : State</span>
</span><span id="LaplaceApproximation-774"><a href="#LaplaceApproximation-774"><span class="linenos">774</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="LaplaceApproximation-775"><a href="#LaplaceApproximation-775"><span class="linenos">775</span></a>
</span><span id="LaplaceApproximation-776"><a href="#LaplaceApproximation-776"><span class="linenos">776</span></a><span class="sd">        Returns</span>
</span><span id="LaplaceApproximation-777"><a href="#LaplaceApproximation-777"><span class="linenos">777</span></a><span class="sd">        -------</span>
</span><span id="LaplaceApproximation-778"><a href="#LaplaceApproximation-778"><span class="linenos">778</span></a><span class="sd">        tuple[float, State]</span>
</span><span id="LaplaceApproximation-779"><a href="#LaplaceApproximation-779"><span class="linenos">779</span></a><span class="sd">            (Log density (float), native state and cached values (dict))</span>
</span><span id="LaplaceApproximation-780"><a href="#LaplaceApproximation-780"><span class="linenos">780</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LaplaceApproximation-781"><a href="#LaplaceApproximation-781"><span class="linenos">781</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">)</span>
</span><span id="LaplaceApproximation-782"><a href="#LaplaceApproximation-782"><span class="linenos">782</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="LaplaceApproximation-783"><a href="#LaplaceApproximation-783"><span class="linenos">783</span></a>            <span class="c1"># state is real.</span>
</span><span id="LaplaceApproximation-784"><a href="#LaplaceApproximation-784"><span class="linenos">784</span></a>            <span class="c1"># Returns logprob + log_det_jacobian, native_state.</span>
</span><span id="LaplaceApproximation-785"><a href="#LaplaceApproximation-785"><span class="linenos">785</span></a>            <span class="k">return</span> <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation-786"><a href="#LaplaceApproximation-786"><span class="linenos">786</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="LaplaceApproximation-787"><a href="#LaplaceApproximation-787"><span class="linenos">787</span></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LaplaceApproximation-788"><a href="#LaplaceApproximation-788"><span class="linenos">788</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LaplaceApproximation-789"><a href="#LaplaceApproximation-789"><span class="linenos">789</span></a>            <span class="c1"># state is native.</span>
</span><span id="LaplaceApproximation-790"><a href="#LaplaceApproximation-790"><span class="linenos">790</span></a>            <span class="c1"># Returns logprob, state (which is already native).</span>
</span><span id="LaplaceApproximation-791"><a href="#LaplaceApproximation-791"><span class="linenos">791</span></a>            <span class="k">return</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LaplaceApproximation-792"><a href="#LaplaceApproximation-792"><span class="linenos">792</span></a>
</span><span id="LaplaceApproximation-793"><a href="#LaplaceApproximation-793"><span class="linenos">793</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_negative_logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec_state</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="LaplaceApproximation-794"><a href="#LaplaceApproximation-794"><span class="linenos">794</span></a>        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">logprob</span><span class="p">(</span><span class="n">vec_state</span><span class="p">)</span>
</span><span id="LaplaceApproximation-795"><a href="#LaplaceApproximation-795"><span class="linenos">795</span></a>
</span><span id="LaplaceApproximation-796"><a href="#LaplaceApproximation-796"><span class="linenos">796</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">minimize_kwargs</span><span class="p">):</span>
</span><span id="LaplaceApproximation-797"><a href="#LaplaceApproximation-797"><span class="linenos">797</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model with laplace approx.&quot;&quot;&quot;</span>
</span><span id="LaplaceApproximation-798"><a href="#LaplaceApproximation-798"><span class="linenos">798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
</span><span id="LaplaceApproximation-799"><a href="#LaplaceApproximation-799"><span class="linenos">799</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_negative_logprob</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_vec_state</span><span class="p">,</span> <span class="o">**</span><span class="n">minimize_kwargs</span>
</span><span id="LaplaceApproximation-800"><a href="#LaplaceApproximation-800"><span class="linenos">800</span></a>        <span class="p">)</span>
</span><span id="LaplaceApproximation-801"><a href="#LaplaceApproximation-801"><span class="linenos">801</span></a>        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">x</span>
</span><span id="LaplaceApproximation-802"><a href="#LaplaceApproximation-802"><span class="linenos">802</span></a>        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">hess_inv</span>
</span><span id="LaplaceApproximation-803"><a href="#LaplaceApproximation-803"><span class="linenos">803</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">MvNormal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">nsamples</span><span class="p">,),</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
</span><span id="LaplaceApproximation-804"><a href="#LaplaceApproximation-804"><span class="linenos">804</span></a>
</span><span id="LaplaceApproximation-805"><a href="#LaplaceApproximation-805"><span class="linenos">805</span></a>        <span class="c1"># Return native state and cache.</span>
</span><span id="LaplaceApproximation-806"><a href="#LaplaceApproximation-806"><span class="linenos">806</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="LaplaceApproximation-807"><a href="#LaplaceApproximation-807"><span class="linenos">807</span></a>            <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span>
</span><span id="LaplaceApproximation-808"><a href="#LaplaceApproximation-808"><span class="linenos">808</span></a>                <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation-809"><a href="#LaplaceApproximation-809"><span class="linenos">809</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="LaplaceApproximation-810"><a href="#LaplaceApproximation-810"><span class="linenos">810</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">),</span>
</span><span id="LaplaceApproximation-811"><a href="#LaplaceApproximation-811"><span class="linenos">811</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="LaplaceApproximation-812"><a href="#LaplaceApproximation-812"><span class="linenos">812</span></a>                <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LaplaceApproximation-813"><a href="#LaplaceApproximation-813"><span class="linenos">813</span></a>                <span class="k">for</span> <span class="n">vec_state</span> <span class="ow">in</span> <span class="n">samples</span>
</span><span id="LaplaceApproximation-814"><a href="#LaplaceApproximation-814"><span class="linenos">814</span></a>            <span class="p">)</span>
</span><span id="LaplaceApproximation-815"><a href="#LaplaceApproximation-815"><span class="linenos">815</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LaplaceApproximation-816"><a href="#LaplaceApproximation-816"><span class="linenos">816</span></a>            <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span>
</span><span id="LaplaceApproximation-817"><a href="#LaplaceApproximation-817"><span class="linenos">817</span></a>                <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation-818"><a href="#LaplaceApproximation-818"><span class="linenos">818</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="LaplaceApproximation-819"><a href="#LaplaceApproximation-819"><span class="linenos">819</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">),</span>
</span><span id="LaplaceApproximation-820"><a href="#LaplaceApproximation-820"><span class="linenos">820</span></a>                    <span class="n">return_cached</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LaplaceApproximation-821"><a href="#LaplaceApproximation-821"><span class="linenos">821</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="LaplaceApproximation-822"><a href="#LaplaceApproximation-822"><span class="linenos">822</span></a>                <span class="p">)</span>
</span><span id="LaplaceApproximation-823"><a href="#LaplaceApproximation-823"><span class="linenos">823</span></a>                <span class="k">for</span> <span class="n">vec_state</span> <span class="ow">in</span> <span class="n">samples</span>
</span><span id="LaplaceApproximation-824"><a href="#LaplaceApproximation-824"><span class="linenos">824</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Laplace Approximation of Posterior.</p>
</div>


                            <div id="LaplaceApproximation.__init__" class="classattr">
                                        <input id="LaplaceApproximation.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LaplaceApproximation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="n">Concatenate</span><span class="p">[</span><span class="n"><a href="context.html#Context">arianna.ppl.context.Context</a></span><span class="p">,</span> <span class="o">~</span><span class="n">P</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span>,</span><span class="param">	<span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>,</span><span class="param">	<span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">_generator</span><span class="o">.</span><span class="n">Generator</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="o">**</span><span class="n">model_data</span></span>)</span>

                <label class="view-source-button" for="LaplaceApproximation.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceApproximation.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceApproximation.__init__-744"><a href="#LaplaceApproximation.__init__-744"><span class="linenos">744</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
</span><span id="LaplaceApproximation.__init__-745"><a href="#LaplaceApproximation.__init__-745"><span class="linenos">745</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="LaplaceApproximation.__init__-746"><a href="#LaplaceApproximation.__init__-746"><span class="linenos">746</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
</span><span id="LaplaceApproximation.__init__-747"><a href="#LaplaceApproximation.__init__-747"><span class="linenos">747</span></a>        <span class="n">transform</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
</span><span id="LaplaceApproximation.__init__-748"><a href="#LaplaceApproximation.__init__-748"><span class="linenos">748</span></a>        <span class="n">rng</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RNG</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="LaplaceApproximation.__init__-749"><a href="#LaplaceApproximation.__init__-749"><span class="linenos">749</span></a>        <span class="o">**</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="LaplaceApproximation.__init__-750"><a href="#LaplaceApproximation.__init__-750"><span class="linenos">750</span></a>    <span class="p">):</span>
</span><span id="LaplaceApproximation.__init__-751"><a href="#LaplaceApproximation.__init__-751"><span class="linenos">751</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="LaplaceApproximation.__init__-752"><a href="#LaplaceApproximation.__init__-752"><span class="linenos">752</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">model_data</span> <span class="o">=</span> <span class="n">model_data</span>
</span><span id="LaplaceApproximation.__init__-753"><a href="#LaplaceApproximation.__init__-753"><span class="linenos">753</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">rng</span> <span class="ow">or</span> <span class="n">default_rng</span><span class="p">()</span>
</span><span id="LaplaceApproximation.__init__-754"><a href="#LaplaceApproximation.__init__-754"><span class="linenos">754</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="n">transform</span>
</span><span id="LaplaceApproximation.__init__-755"><a href="#LaplaceApproximation.__init__-755"><span class="linenos">755</span></a>
</span><span id="LaplaceApproximation.__init__-756"><a href="#LaplaceApproximation.__init__-756"><span class="linenos">756</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="LaplaceApproximation.__init__-757"><a href="#LaplaceApproximation.__init__-757"><span class="linenos">757</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">TransformedPredictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation.__init__-758"><a href="#LaplaceApproximation.__init__-758"><span class="linenos">758</span></a>                <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="LaplaceApproximation.__init__-759"><a href="#LaplaceApproximation.__init__-759"><span class="linenos">759</span></a>            <span class="p">)</span>
</span><span id="LaplaceApproximation.__init__-760"><a href="#LaplaceApproximation.__init__-760"><span class="linenos">760</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LaplaceApproximation.__init__-761"><a href="#LaplaceApproximation.__init__-761"><span class="linenos">761</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">init_state</span> <span class="o">=</span> <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation.__init__-762"><a href="#LaplaceApproximation.__init__-762"><span class="linenos">762</span></a>                <span class="n">model</span><span class="p">,</span> <span class="n">rng</span><span class="o">=</span><span class="n">rng</span><span class="p">,</span> <span class="n">return_cached</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="LaplaceApproximation.__init__-763"><a href="#LaplaceApproximation.__init__-763"><span class="linenos">763</span></a>            <span class="p">)</span>
</span><span id="LaplaceApproximation.__init__-764"><a href="#LaplaceApproximation.__init__-764"><span class="linenos">764</span></a>
</span><span id="LaplaceApproximation.__init__-765"><a href="#LaplaceApproximation.__init__-765"><span class="linenos">765</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span> <span class="o">=</span> <span class="n">Shaper</span><span class="o">.</span><span class="n">from_state</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span><span id="LaplaceApproximation.__init__-766"><a href="#LaplaceApproximation.__init__-766"><span class="linenos">766</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">init_vec_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_state</span><span class="p">)</span>
</span></pre></div>


    

                            </div>
                            <div id="LaplaceApproximation.rng" class="classattr">
                                <div class="attr variable">
            <span class="name">rng</span><span class="annotation">: numpy.random._generator.Generator</span>

        
    </div>
    <a class="headerlink" href="#LaplaceApproximation.rng"></a>
    
    

                            </div>
                            <div id="LaplaceApproximation.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span>

        
    </div>
    <a class="headerlink" href="#LaplaceApproximation.model"></a>
    
    

                            </div>
                            <div id="LaplaceApproximation.model_data" class="classattr">
                                <div class="attr variable">
            <span class="name">model_data</span>

        
    </div>
    <a class="headerlink" href="#LaplaceApproximation.model_data"></a>
    
    

                            </div>
                            <div id="LaplaceApproximation.transform" class="classattr">
                                <div class="attr variable">
            <span class="name">transform</span>

        
    </div>
    <a class="headerlink" href="#LaplaceApproximation.transform"></a>
    
    

                            </div>
                            <div id="LaplaceApproximation.shaper" class="classattr">
                                <div class="attr variable">
            <span class="name">shaper</span>

        
    </div>
    <a class="headerlink" href="#LaplaceApproximation.shaper"></a>
    
    

                            </div>
                            <div id="LaplaceApproximation.init_vec_state" class="classattr">
                                <div class="attr variable">
            <span class="name">init_vec_state</span>

        
    </div>
    <a class="headerlink" href="#LaplaceApproximation.init_vec_state"></a>
    
    

                            </div>
                            <div id="LaplaceApproximation.logprob" class="classattr">
                                        <input id="LaplaceApproximation.logprob-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">logprob</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">vec_state</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span></span><span class="return-annotation">) -> <span class="nb">float</span>:</span></span>

                <label class="view-source-button" for="LaplaceApproximation.logprob-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceApproximation.logprob"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceApproximation.logprob-768"><a href="#LaplaceApproximation.logprob-768"><span class="linenos">768</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">logprob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec_state</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
</span><span id="LaplaceApproximation.logprob-769"><a href="#LaplaceApproximation.logprob-769"><span class="linenos">769</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute log density.</span>
</span><span id="LaplaceApproximation.logprob-770"><a href="#LaplaceApproximation.logprob-770"><span class="linenos">770</span></a>
</span><span id="LaplaceApproximation.logprob-771"><a href="#LaplaceApproximation.logprob-771"><span class="linenos">771</span></a><span class="sd">        Parameters</span>
</span><span id="LaplaceApproximation.logprob-772"><a href="#LaplaceApproximation.logprob-772"><span class="linenos">772</span></a><span class="sd">        ----------</span>
</span><span id="LaplaceApproximation.logprob-773"><a href="#LaplaceApproximation.logprob-773"><span class="linenos">773</span></a><span class="sd">        state : State</span>
</span><span id="LaplaceApproximation.logprob-774"><a href="#LaplaceApproximation.logprob-774"><span class="linenos">774</span></a><span class="sd">            Dictionary containing random variables to model.</span>
</span><span id="LaplaceApproximation.logprob-775"><a href="#LaplaceApproximation.logprob-775"><span class="linenos">775</span></a>
</span><span id="LaplaceApproximation.logprob-776"><a href="#LaplaceApproximation.logprob-776"><span class="linenos">776</span></a><span class="sd">        Returns</span>
</span><span id="LaplaceApproximation.logprob-777"><a href="#LaplaceApproximation.logprob-777"><span class="linenos">777</span></a><span class="sd">        -------</span>
</span><span id="LaplaceApproximation.logprob-778"><a href="#LaplaceApproximation.logprob-778"><span class="linenos">778</span></a><span class="sd">        tuple[float, State]</span>
</span><span id="LaplaceApproximation.logprob-779"><a href="#LaplaceApproximation.logprob-779"><span class="linenos">779</span></a><span class="sd">            (Log density (float), native state and cached values (dict))</span>
</span><span id="LaplaceApproximation.logprob-780"><a href="#LaplaceApproximation.logprob-780"><span class="linenos">780</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LaplaceApproximation.logprob-781"><a href="#LaplaceApproximation.logprob-781"><span class="linenos">781</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">)</span>
</span><span id="LaplaceApproximation.logprob-782"><a href="#LaplaceApproximation.logprob-782"><span class="linenos">782</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="LaplaceApproximation.logprob-783"><a href="#LaplaceApproximation.logprob-783"><span class="linenos">783</span></a>            <span class="c1"># state is real.</span>
</span><span id="LaplaceApproximation.logprob-784"><a href="#LaplaceApproximation.logprob-784"><span class="linenos">784</span></a>            <span class="c1"># Returns logprob + log_det_jacobian, native_state.</span>
</span><span id="LaplaceApproximation.logprob-785"><a href="#LaplaceApproximation.logprob-785"><span class="linenos">785</span></a>            <span class="k">return</span> <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation.logprob-786"><a href="#LaplaceApproximation.logprob-786"><span class="linenos">786</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span>
</span><span id="LaplaceApproximation.logprob-787"><a href="#LaplaceApproximation.logprob-787"><span class="linenos">787</span></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="LaplaceApproximation.logprob-788"><a href="#LaplaceApproximation.logprob-788"><span class="linenos">788</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LaplaceApproximation.logprob-789"><a href="#LaplaceApproximation.logprob-789"><span class="linenos">789</span></a>            <span class="c1"># state is native.</span>
</span><span id="LaplaceApproximation.logprob-790"><a href="#LaplaceApproximation.logprob-790"><span class="linenos">790</span></a>            <span class="c1"># Returns logprob, state (which is already native).</span>
</span><span id="LaplaceApproximation.logprob-791"><a href="#LaplaceApproximation.logprob-791"><span class="linenos">791</span></a>            <span class="k">return</span> <span class="n">LogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Compute log density.</p>

<h6 id="parameters">Parameters</h6>

<ul>
<li><strong>state</strong> (State):
Dictionary containing random variables to model.</li>
</ul>

<h6 id="returns">Returns</h6>

<ul>
<li><strong>tuple[float, State]</strong>: (Log density (float), native state and cached values (dict))</li>
</ul>
</div>


                            </div>
                            <div id="LaplaceApproximation.fit" class="classattr">
                                        <input id="LaplaceApproximation.fit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">fit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span>, </span><span class="param"><span class="o">**</span><span class="n">minimize_kwargs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="LaplaceApproximation.fit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LaplaceApproximation.fit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LaplaceApproximation.fit-796"><a href="#LaplaceApproximation.fit-796"><span class="linenos">796</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">minimize_kwargs</span><span class="p">):</span>
</span><span id="LaplaceApproximation.fit-797"><a href="#LaplaceApproximation.fit-797"><span class="linenos">797</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fit model with laplace approx.&quot;&quot;&quot;</span>
</span><span id="LaplaceApproximation.fit-798"><a href="#LaplaceApproximation.fit-798"><span class="linenos">798</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span>
</span><span id="LaplaceApproximation.fit-799"><a href="#LaplaceApproximation.fit-799"><span class="linenos">799</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_negative_logprob</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_vec_state</span><span class="p">,</span> <span class="o">**</span><span class="n">minimize_kwargs</span>
</span><span id="LaplaceApproximation.fit-800"><a href="#LaplaceApproximation.fit-800"><span class="linenos">800</span></a>        <span class="p">)</span>
</span><span id="LaplaceApproximation.fit-801"><a href="#LaplaceApproximation.fit-801"><span class="linenos">801</span></a>        <span class="n">mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">x</span>
</span><span id="LaplaceApproximation.fit-802"><a href="#LaplaceApproximation.fit-802"><span class="linenos">802</span></a>        <span class="n">cov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">result</span><span class="o">.</span><span class="n">hess_inv</span>
</span><span id="LaplaceApproximation.fit-803"><a href="#LaplaceApproximation.fit-803"><span class="linenos">803</span></a>        <span class="n">samples</span> <span class="o">=</span> <span class="n">MvNormal</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">cov</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">((</span><span class="n">nsamples</span><span class="p">,),</span> <span class="n">rng</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="p">)</span>
</span><span id="LaplaceApproximation.fit-804"><a href="#LaplaceApproximation.fit-804"><span class="linenos">804</span></a>
</span><span id="LaplaceApproximation.fit-805"><a href="#LaplaceApproximation.fit-805"><span class="linenos">805</span></a>        <span class="c1"># Return native state and cache.</span>
</span><span id="LaplaceApproximation.fit-806"><a href="#LaplaceApproximation.fit-806"><span class="linenos">806</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">:</span>
</span><span id="LaplaceApproximation.fit-807"><a href="#LaplaceApproximation.fit-807"><span class="linenos">807</span></a>            <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span>
</span><span id="LaplaceApproximation.fit-808"><a href="#LaplaceApproximation.fit-808"><span class="linenos">808</span></a>                <span class="n">TransformedLogprobAndTrace</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation.fit-809"><a href="#LaplaceApproximation.fit-809"><span class="linenos">809</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="LaplaceApproximation.fit-810"><a href="#LaplaceApproximation.fit-810"><span class="linenos">810</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">),</span>
</span><span id="LaplaceApproximation.fit-811"><a href="#LaplaceApproximation.fit-811"><span class="linenos">811</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="LaplaceApproximation.fit-812"><a href="#LaplaceApproximation.fit-812"><span class="linenos">812</span></a>                <span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="LaplaceApproximation.fit-813"><a href="#LaplaceApproximation.fit-813"><span class="linenos">813</span></a>                <span class="k">for</span> <span class="n">vec_state</span> <span class="ow">in</span> <span class="n">samples</span>
</span><span id="LaplaceApproximation.fit-814"><a href="#LaplaceApproximation.fit-814"><span class="linenos">814</span></a>            <span class="p">)</span>
</span><span id="LaplaceApproximation.fit-815"><a href="#LaplaceApproximation.fit-815"><span class="linenos">815</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="LaplaceApproximation.fit-816"><a href="#LaplaceApproximation.fit-816"><span class="linenos">816</span></a>            <span class="k">return</span> <span class="n">Chain</span><span class="p">(</span>
</span><span id="LaplaceApproximation.fit-817"><a href="#LaplaceApproximation.fit-817"><span class="linenos">817</span></a>                <span class="n">Predictive</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
</span><span id="LaplaceApproximation.fit-818"><a href="#LaplaceApproximation.fit-818"><span class="linenos">818</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="LaplaceApproximation.fit-819"><a href="#LaplaceApproximation.fit-819"><span class="linenos">819</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">shaper</span><span class="o">.</span><span class="n">unvec</span><span class="p">(</span><span class="n">vec_state</span><span class="p">),</span>
</span><span id="LaplaceApproximation.fit-820"><a href="#LaplaceApproximation.fit-820"><span class="linenos">820</span></a>                    <span class="n">return_cached</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="LaplaceApproximation.fit-821"><a href="#LaplaceApproximation.fit-821"><span class="linenos">821</span></a>                    <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">model_data</span><span class="p">,</span>
</span><span id="LaplaceApproximation.fit-822"><a href="#LaplaceApproximation.fit-822"><span class="linenos">822</span></a>                <span class="p">)</span>
</span><span id="LaplaceApproximation.fit-823"><a href="#LaplaceApproximation.fit-823"><span class="linenos">823</span></a>                <span class="k">for</span> <span class="n">vec_state</span> <span class="ow">in</span> <span class="n">samples</span>
</span><span id="LaplaceApproximation.fit-824"><a href="#LaplaceApproximation.fit-824"><span class="linenos">824</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Fit model with laplace approx.</p>
</div>


                            </div>
                </section>
                <section id="BayesianOptimization">
                            <input id="BayesianOptimization-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BayesianOptimization</span><wbr>(<span class="base"><a href="#InferenceEngine">InferenceEngine</a></span>):

                <label class="view-source-button" for="BayesianOptimization-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BayesianOptimization"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BayesianOptimization-827"><a href="#BayesianOptimization-827"><span class="linenos">827</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BayesianOptimization</span><span class="p">(</span><span class="n">InferenceEngine</span><span class="p">):</span>
</span><span id="BayesianOptimization-828"><a href="#BayesianOptimization-828"><span class="linenos">828</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Bayesian Optimization.&quot;&quot;&quot;</span>
</span><span id="BayesianOptimization-829"><a href="#BayesianOptimization-829"><span class="linenos">829</span></a>
</span><span id="BayesianOptimization-830"><a href="#BayesianOptimization-830"><span class="linenos">830</span></a>    <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Bayesian Optimization.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#InferenceEngine">InferenceEngine</a></dt>
                                <dd id="BayesianOptimization.rng" class="variable"><a href="#InferenceEngine.rng">rng</a></dd>
                <dd id="BayesianOptimization.fit" class="function"><a href="#InferenceEngine.fit">fit</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="AdaptiveRandomWalkMetropolis">
                            <input id="AdaptiveRandomWalkMetropolis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">AdaptiveRandomWalkMetropolis</span><wbr>(<span class="base"><a href="#SingleWalkerMCMC">SingleWalkerMCMC</a></span>):

                <label class="view-source-button" for="AdaptiveRandomWalkMetropolis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#AdaptiveRandomWalkMetropolis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="AdaptiveRandomWalkMetropolis-833"><a href="#AdaptiveRandomWalkMetropolis-833"><span class="linenos">833</span></a><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveRandomWalkMetropolis</span><span class="p">(</span><span class="n">SingleWalkerMCMC</span><span class="p">):</span>
</span><span id="AdaptiveRandomWalkMetropolis-834"><a href="#AdaptiveRandomWalkMetropolis-834"><span class="linenos">834</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Adaptive Random Walk Metropolis.</span>
</span><span id="AdaptiveRandomWalkMetropolis-835"><a href="#AdaptiveRandomWalkMetropolis-835"><span class="linenos">835</span></a>
</span><span id="AdaptiveRandomWalkMetropolis-836"><a href="#AdaptiveRandomWalkMetropolis-836"><span class="linenos">836</span></a><span class="sd">    Resources</span>
</span><span id="AdaptiveRandomWalkMetropolis-837"><a href="#AdaptiveRandomWalkMetropolis-837"><span class="linenos">837</span></a><span class="sd">    ---------</span>
</span><span id="AdaptiveRandomWalkMetropolis-838"><a href="#AdaptiveRandomWalkMetropolis-838"><span class="linenos">838</span></a><span class="sd">    - https://probability.ca/jeff/ftpdir/adaptex.pdf</span>
</span><span id="AdaptiveRandomWalkMetropolis-839"><a href="#AdaptiveRandomWalkMetropolis-839"><span class="linenos">839</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="AdaptiveRandomWalkMetropolis-840"><a href="#AdaptiveRandomWalkMetropolis-840"><span class="linenos">840</span></a>
</span><span id="AdaptiveRandomWalkMetropolis-841"><a href="#AdaptiveRandomWalkMetropolis-841"><span class="linenos">841</span></a>    <span class="o">...</span>
</span></pre></div>


            <div class="docstring"><p>Adaptive Random Walk Metropolis.</p>

<h6 id="resources">Resources</h6>

<ul>
<li><a href="https://probability.ca/jeff/ftpdir/adaptex.pdf">https://probability.ca/jeff/ftpdir/adaptex.pdf</a></li>
</ul>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#SingleWalkerMCMC">SingleWalkerMCMC</a></dt>
                                <dd id="AdaptiveRandomWalkMetropolis.init_state" class="variable"><a href="#SingleWalkerMCMC.init_state">init_state</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.mcmc_state" class="variable"><a href="#SingleWalkerMCMC.mcmc_state">mcmc_state</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.transform" class="variable"><a href="#SingleWalkerMCMC.transform">transform</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.step" class="function"><a href="#SingleWalkerMCMC.step">step</a></dd>

            </div>
            <div><dt><a href="#MCMC">MCMC</a></dt>
                                <dd id="AdaptiveRandomWalkMetropolis.model" class="variable"><a href="#MCMC.model">model</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.model_data" class="variable"><a href="#MCMC.model_data">model_data</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.nsamples" class="variable"><a href="#MCMC.nsamples">nsamples</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.burn" class="variable"><a href="#MCMC.burn">burn</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.thin" class="variable"><a href="#MCMC.thin">thin</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.mcmc_iteration" class="variable"><a href="#MCMC.mcmc_iteration">mcmc_iteration</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.logprob_history" class="variable"><a href="#MCMC.logprob_history">logprob_history</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.fit" class="function"><a href="#MCMC.fit">fit</a></dd>
                <dd id="AdaptiveRandomWalkMetropolis.logprob" class="function"><a href="#MCMC.logprob">logprob</a></dd>

            </div>
            <div><dt><a href="#InferenceEngine">InferenceEngine</a></dt>
                                <dd id="AdaptiveRandomWalkMetropolis.rng" class="variable"><a href="#InferenceEngine.rng">rng</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>